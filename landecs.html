<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time flood monitoring and predictive analytics for the Philippines">
    <meta name="theme-color" content="#1976D2">
    <title>Agos PH â€¢ Real-Time Flood Monitoring</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <style>
        :root {
            --primary-color: #1976D2;
            --primary-dark: #1565C0;
            --primary-light: #E3F2FD;
            --secondary-color: #FF9800;
            --danger-color: #F44336;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --dark-bg: #121212;
            --dark-surface: #1E1E1E;
            --dark-text: #E0E0E0;
            --light-bg: #F5F5F5;
            --light-surface: #FFFFFF;
            --light-text: #212121;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
            min-height: 100vh;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 1000;
            transition: var(--transition);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle,
        .language-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1rem;
            transition: var(--transition);
        }

        .theme-toggle:hover,
        .language-toggle:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .theme-toggle i,
        .language-toggle i {
            margin-right: 5px;
        }

        main {
            padding: 20px 0;
            min-height: calc(100vh - 120px);
        }

        .map-container {
            height: 400px;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
        }

        #flood-map {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            max-width: 200px;
            transition: var(--transition);
        }

        body.dark-mode .map-overlay {
            background-color: rgba(30, 30, 30, 0.9);
        }

        .map-overlay h4 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
            transition: var(--transition);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--light-surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.dark-mode .card {
            background-color: var(--dark-surface);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .card-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card-content {
            min-height: 150px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .flood-prediction {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
        }

        .prediction-level {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 10px 0;
            transition: var(--transition);
        }

        .low-risk {
            color: var(--success-color);
        }

        .moderate-risk {
            color: var(--warning-color);
        }

        .high-risk {
            color: var(--danger-color);
        }

        .prediction-time {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .sensor-item {
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .sensor-item:hover {
            transform: translateX(5px);
        }

        .sensor-icon {
            font-size: 2rem;
            margin-right: 10px;
            color: var(--primary-color);
            transition: var(--transition);
        }

        .sensor-info h4 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .sensor-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .road-alerts {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .road-alert {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: rgba(244, 67, 54, 0.1);
            border-radius: 5px;
            transition: var(--transition);
        }

        .road-alert:hover {
            background-color: rgba(244, 67, 54, 0.2);
        }

        .road-alert i {
            margin-right: 10px;
            color: var(--danger-color);
        }

        .road-name {
            font-weight: 500;
        }

        .road-status {
            font-size: 0.8rem;
            margin-top: 3px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
        }

        #location-search {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: var(--transition);
        }

        #location-search:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        body.dark-mode #location-search {
            background-color: var(--dark-surface);
            border-color: #444;
            color: var(--dark-text);
        }

        .search-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .search-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .location-info {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--primary-light);
            border-radius: 5px;
            display: none;
            animation: fadeIn 0.3s ease-out;
            transition: var(--transition);
        }

        body.dark-mode .location-info {
            background-color: rgba(25, 118, 210, 0.2);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .location-title {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .location-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .data-value {
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .footer-link {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-link:hover {
            text-decoration: underline;
            opacity: 0.9;
        }

        .last-updated {
            margin-top: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* PWA install prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--light-surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 1000;
            max-width: 300px;
            animation: slideInUp 0.3s ease-out;
            transition: var(--transition);
        }

        body.dark-mode .install-prompt {
            background-color: var(--dark-surface);
        }

        .install-prompt p {
            margin-bottom: 10px;
        }

        .prompt-buttons {
            display: flex;
            gap: 10px;
        }

        .install-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .install-btn:hover {
            background-color: var(--primary-dark);
        }

        .dismiss-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dismiss-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .dismiss-btn {
            border-color: #444;
        }

        body.dark-mode .dismiss-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Notification permission prompt */
        .notification-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--light-surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 1000;
            max-width: 300px;
            animation: slideInUp 0.3s ease-out;
        }

        body.dark-mode .notification-prompt {
            background-color: var(--dark-surface);
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--danger-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 1000;
            animation: slideInUp 0.3s ease-out;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--light-surface);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideInUp 0.3s ease-out;
            transition: var(--transition);
        }

        body.dark-mode .modal-content {
            background-color: var(--dark-surface);
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
        }

        body.dark-mode .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .modal-btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
            transition: var(--transition);
        }

        body.dark-mode .modal-close {
            color: var(--dark-text);
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        /* Bottom sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--light-surface);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .bottom-sheet-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            background-color: inherit;
            z-index: 1;
        }

        body.dark-mode .bottom-sheet-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bottom-sheet-body {
            padding: 16px;
        }

        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1499;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loading-overlay p {
            color: white;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        /* Permission dialog */
        .permission-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--light-surface);
            border-radius: 8px;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: var(--shadow);
            z-index: 2000;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        body.dark-mode .permission-dialog {
            background-color: var(--dark-surface);
        }

        .permission-dialog h3 {
            margin-bottom: 15px;
        }

        .permission-dialog p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .permission-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Tracking transparency dialog */
        .tracking-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--light-surface);
            border-radius: 8px;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: var(--shadow);
            z-index: 2000;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        body.dark-mode .tracking-dialog {
            background-color: var(--dark-surface);
        }

        .tracking-dialog h3 {
            margin-bottom: 15px;
        }

        .tracking-dialog p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .tracking-options {
            margin-bottom: 20px;
        }

        .tracking-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .tracking-option input {
            margin-right: 10px;
        }

        .tracking-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .sensor-grid {
                grid-template-columns: 1fr;
            }

            .map-overlay {
                max-width: 150px;
            }

            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .footer-links {
                flex-wrap: wrap;
                gap: 10px;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
                padding: 12px;
            }

            .location-data {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="material-icons">water_damage</i>
                <span>Agos PH</span>
            </div>
            <div class="nav-controls">
                <button class="language-toggle" id="language-toggle" aria-label="Toggle language">
                    <i class="material-icons">translate</i>
                    <span>EN</span>
                </button>
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <i class="material-icons">brightness_4</i>
                    <span>Dark</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="search-container">
            <div class="search-bar">
                <input type="text" id="location-search" placeholder="Search for barangay or city..." aria-label="Location search">
                <button class="search-btn" id="search-btn" aria-label="Search location">
                    <span id="search-text">Search</span>
                    <span id="search-spinner" class="spinner" style="display: none;" aria-hidden="true"></span>
                </button>
            </div>
            <div class="location-info" id="location-info" style="display: none;">
                <div class="location-header">
                    <div class="location-title" id="selected-location">Loading...</div>
                    <div class="last-updated" id="location-updated">Updated: -</div>
                </div>
                <div class="location-data">
                    <div class="data-item">
                        <span class="data-label">Current Risk</span>
                        <span class="data-value" id="current-risk">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Rainfall</span>
                        <span class="data-value" id="rainfall-value">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Water Level</span>
                        <span class="data-value" id="water-level">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Flood Depth</span>
                        <span class="data-value" id="flood-depth">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="flood-map"></div>
            <div class="map-overlay">
                <h4>Flood Risk Legend</h4>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4CAF50;"></div>
                        <span>Low Risk (0-30cm)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFC107;"></div>
                        <span>Moderate (30-60cm)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #F44336;"></div>
                        <span>High (60-100cm)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9C27B0;"></div>
                        <span>Extreme (100cm+)</span>
                    </div>
                </div>
                <div class="map-controls">
                    <button id="locate-me" class="map-control-btn" aria-label="Locate me">
                        <i class="material-icons">my_location</i>
                    </button>
                    <button id="zoom-in" class="map-control-btn" aria-label="Zoom in">
                        <i class="material-icons">add</i>
                    </button>
                    <button id="zoom-out" class="map-control-btn" aria-label="Zoom out">
                        <i class="material-icons">remove</i>
                    </button>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card emergency-card" id="emergency-card" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Emergency Alert</div>
                    <i class="material-icons">warning</i>
                </div>
                <div class="card-content">
                    <div class="emergency-alert" id="emergency-alert-content">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="emergency-actions">
                        <button class="emergency-btn" id="view-evac-routes">
                            <i class="material-icons">directions</i>
                            <span>Evacuation Routes</span>
                        </button>
                        <button class="emergency-btn" id="call-emergency">
                            <i class="material-icons">call</i>
                            <span>Emergency Contacts</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Flood Prediction</div>
                    <i class="material-icons">schedule</i>
                </div>
                <div class="card-content">
                    <div class="flood-prediction">
                        <div>Flood possible in</div>
                        <div class="prediction-time" id="prediction-time">-</div>
                        <div class="prediction-level" id="prediction-level">-</div>
                        <div id="prediction-details">Gathering data...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Rainfall & Water Sensors</div>
                    <i class="material-icons">sensors</i>
                </div>
                <div class="card-content">
                    <div class="sensor-grid">
                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="material-icons">water_drop</i>
                            </div>
                            <div class="sensor-info">
                                <h4>Rain Rate</h4>
                                <div class="sensor-value" id="rain-rate">-</div>
                            </div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="material-icons">trending_up</i>
                            </div>
                            <div class="sensor-info">
                                <h4>Rise Velocity</h4>
                                <div class="sensor-value" id="rise-velocity">-</div>
                            </div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="material-icons">calendar_today</i>
                            </div>
                            <div class="sensor-info">
                                <h4>Last Heavy Rain</h4>
                                <div class="sensor-value" id="last-heavy-rain">-</div>
                            </div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="material-icons">compare</i>
                            </div>
                            <div class="sensor-info">
                                <h4>vs. Average</h4>
                                <div class="sensor-value" id="vs-average">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">7-Day Rainfall</div>
                    <i class="material-icons">bar_chart</i>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="rainfall-chart" aria-label="7-day rainfall chart" role="img"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Flood-Impacted Roads</div>
                    <i class="material-icons">directions</i>
                </div>
                <div class="card-content">
                    <div class="road-alerts" id="road-alerts">
                        <div class="no-data">Loading road conditions...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">6-Hour Forecast</div>
                    <i class="material-icons">timeline</i>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="forecast-chart" aria-label="6-hour forecast chart" role="img"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Flood Hotspots</div>
                    <i class="material-icons">location_on</i>
                </div>
                <div class="card-content">
                    <div id="hotspots-list">
                        <div class="no-data">Identifying flood hotspots...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Nearby Evacuation Centers</div>
                    <i class="material-icons">place</i>
                </div>
                <div class="card-content">
                    <div id="evacuation-centers">
                        <div class="no-data">Loading evacuation centers...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="/about" class="footer-link">About</a>
                <a href="/data-sources" class="footer-link">Data Sources</a>
                <a href="/emergency-contacts" class="footer-link">Emergency Contacts</a>
                <a href="/feedback" class="footer-link">Feedback</a>
                <a href="/privacy" class="footer-link">Privacy Policy</a>
            </div>
            <p>Agos PH: Real-Time Flood Monitoring System</p>
            <p class="last-updated" id="global-updated">Last updated: <span id="update-time">-</span></p>
            <p class="disclaimer">Data is provided by PAGASA, MMDA, and local government units. Use at your own risk.</p>
        </div>
    </footer>

    <!-- Install Prompt -->
    <div class="install-prompt" id="install-prompt" style="display: none;" role="dialog" aria-labelledby="install-prompt-title">
        <p id="install-prompt-title">Install Agos PH for faster access and offline use?</p>
        <div class="prompt-buttons">
            <button class="install-btn" id="install-btn">Install</button>
            <button class="dismiss-btn" id="dismiss-btn">Not Now</button>
        </div>
    </div>

    <!-- Notification Prompt -->
    <div class="notification-prompt" id="notification-prompt" style="display: none;" role="dialog" aria-labelledby="notification-prompt-title">
        <p id="notification-prompt-title">Get flood alerts for your area?</p>
        <div class="prompt-buttons">
            <button class="install-btn" id="enable-notifications">Enable</button>
            <button class="dismiss-btn" id="dismiss-notifications">Later</button>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offline-indicator" style="display: none;" role="status">
        You are currently offline. Showing last available data.
    </div>

    <!-- Emergency Modal -->
    <div class="modal" id="emergency-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="emergency-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="emergency-modal-title">Emergency Alert</h3>
                <button class="modal-close" id="emergency-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" id="emergency-modal-body">
                <!-- Content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" id="emergency-modal-confirm">Understood</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading latest flood data...</p>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="bottom-sheet">
        <div class="bottom-sheet-header">
            <h3 id="bottom-sheet-title">Details</h3>
            <button class="modal-close" id="bottom-sheet-close">&times;</button>
        </div>
        <div class="bottom-sheet-body" id="bottom-sheet-content">
            <!-- Content will be inserted here -->
        </div>
    </div>
    <div class="bottom-sheet-overlay" id="bottom-sheet-overlay"></div>

    <!-- Permission Dialog -->
    <div class="permission-dialog" id="location-permission-dialog" style="display: none;">
        <h3>Location Access Needed</h3>
        <p>Agos PH needs access to your location to provide accurate flood alerts and monitoring for your area. Your location data is only used to serve you better and is never shared with third parties.</p>
        <div class="permission-buttons">
            <button class="dismiss-btn" id="deny-location">Not Now</button>
            <button class="install-btn" id="grant-location">Allow Access</button>
        </div>
    </div>

    <!-- Tracking Transparency Dialog -->
    <div class="tracking-dialog" id="tracking-dialog" style="display: none;">
        <h3>Privacy Preferences</h3>
        <p>We respect your privacy. Please choose how you'd like us to handle your data:</p>
        <div class="tracking-options">
            <div class="tracking-option">
                <input type="radio" id="tracking-essential" name="tracking" value="essential" checked>
                <label for="tracking-essential">Essential Only (Required for app functionality)</label>
            </div>
            <div class="tracking-option">
                <input type="radio" id="tracking-analytics" name="tracking" value="analytics">
                <label for="tracking-analytics">Analytics (Help improve the app)</label>
            </div>
            <div class="tracking-option">
                <input type="radio" id="tracking-personalized" name="tracking" value="personalized">
                <label for="tracking-personalized">Personalized (Tailor experience to your needs)</label>
            </div>
        </div>
        <div class="tracking-buttons">
            <button class="dismiss-btn" id="tracking-cancel">Cancel</button>
            <button class="install-btn" id="tracking-confirm">Save Preferences</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script>
        // Application Configuration
        const AppConfig = {
            // API Configuration
            API_BASE_URL: 'https://api.agos.ph/v1',
            API_ENDPOINTS: {
                FLOOD_DATA: '/flood-data',
                RAINFALL: '/rainfall',
                PREDICTIONS: '/predictions',
                ROADS: '/affected-roads',
                EVACUATION: '/evacuation-centers',
                GEOLOCATION: '/geocode',
                ALERTS: '/alerts',
                SENSORS: '/sensors'
            },
            API_KEY: 'agos_public_key_2023', // Public API key
            CACHE_TTL: 300000, // 5 minutes cache time
            MAX_RETRIES: 3,
            TIMEOUT: 10000, // 10 seconds
            
            // Flood Risk Levels
            RISK_LEVELS: {
                LOW: { threshold: 30, color: '#4CAF50', label: 'Low Risk' },
                MODERATE: { threshold: 60, color: '#FFC107', label: 'Moderate Risk' },
                HIGH: { threshold: 100, color: '#F44336', label: 'High Risk' },
                EXTREME: { threshold: Infinity, color: '#9C27B0', label: 'Extreme Risk' }
            },
            
            // Map Configuration
            MAP_CONFIG: {
                DEFAULT_CENTER: [12.8797, 121.7740], // Philippines coordinates
                DEFAULT_ZOOM: 6,
                MIN_ZOOM: 5,
                MAX_ZOOM: 18,
                TILE_LAYER: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                ATTRIBUTION: '&copy; OpenStreetMap contributors',
                FLOOD_LAYER_OPACITY: 0.6,
                USER_MARKER_RADIUS: 8,
                USER_MARKER_COLOR: '#4285F4',
                EVAC_MARKER_COLOR: '#4CAF50'
            },
            
            // Emergency Contacts
            EMERGENCY_CONTACTS: [
                { name: "National Emergency Hotline", number: "911" },
                { name: "NDRRMC", number: "(02) 8911-6606" },
                { name: "Red Cross", number: "143" },
                { name: "MMDA", number: "136" },
                { name: "PNP", number: "117" }
            ]
        };

        // Application State
        const AppState = {
            // Map components
            map: null,
            floodLayer: null,
            evacuationLayer: null,
            userMarker: null,
            
            // Data state
            floodData: null,
            rainfallData: null,
            predictions: null,
            affectedRoads: null,
            evacuationCenters: null,
            sensorData: null,
            
            // User state
            currentLocation: null,
            selectedLocation: null,
            
            // UI state
            lastUpdate: null,
            offlineMode: false,
            dataStatus: 'loading',
            
            // User preferences
            preferences: {
                theme: localStorage.getItem('theme') || 'light',
                language: localStorage.getItem('language') || 'en',
                notifications: localStorage.getItem('notifications') || 'unset',
                tracking: localStorage.getItem('tracking') || 'essential',
                locationPermission: localStorage.getItem('locationPermission') || 'unset'
            },
            
            // Charts
            charts: {
                rainfallChart: null,
                forecastChart: null
            },
            
            // PWA state
            deferredPrompt: null,
            serviceWorkerRegistration: null
        };

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize UI components
                initTheme();
                initMap();
                initCharts();
                initEventListeners();
                
                // Register service worker
                await registerServiceWorker();
                
                // Check connectivity
                checkConnectivity();
                
                // Show tracking dialog if not set
                if (!localStorage.getItem('trackingSet')) {
                    showTrackingDialog();
                }
                
                // Request necessary permissions
                await requestPermissions();
                
                // Load initial data
                await loadInitialData();
                
                // Set up periodic data refresh
                setInterval(loadData, AppConfig.CACHE_TTL);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize application. Please refresh the page.');
            }
        });

        // Theme Management
        function initTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').querySelector('span').textContent = 'Light';
                AppState.preferences.theme = 'dark';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('theme-toggle').querySelector('span').textContent = 'Dark';
                AppState.preferences.theme = 'light';
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            const themeToggle = document.getElementById('theme-toggle').querySelector('span');

            if (isDark) {
                themeToggle.textContent = 'Light';
                AppState.preferences.theme = 'dark';
            } else {
                themeToggle.textContent = 'Dark';
                AppState.preferences.theme = 'light';
            }
            
            localStorage.setItem('theme', AppState.preferences.theme);
            if (AppState.map) AppState.map.invalidateSize();
            
            logEvent('theme_toggled', { theme: AppState.preferences.theme });
        }

        // Language Management
        function toggleLanguage() {
            const languageToggle = document.getElementById('language-toggle').querySelector('span');
            const newLang = languageToggle.textContent === 'EN' ? 'TL' : 'EN';
            
            languageToggle.textContent = newLang;
            AppState.preferences.language = newLang.toLowerCase();
            localStorage.setItem('language', newLang.toLowerCase());
            
            // In production, we would update all text content here
            logEvent('language_toggled', { language: newLang });
        }

        // Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    AppState.serviceWorkerRegistration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/',
                        updateViaCache: 'none'
                    });
                    
                    console.log('Service Worker registered');
                    
                    // Check for updates periodically
                    setInterval(() => {
                        AppState.serviceWorkerRegistration.update().catch(console.error);
                    }, 3600000); // Every hour
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }

        // Map Initialization
        function initMap() {
            // Create map instance
            AppState.map = L.map('flood-map', {
                preferCanvas: true,
                zoomControl: false,
                attributionControl: false,
                minZoom: AppConfig.MAP_CONFIG.MIN_ZOOM,
                maxZoom: AppConfig.MAP_CONFIG.MAX_ZOOM
            }).setView(AppConfig.MAP_CONFIG.DEFAULT_CENTER, AppConfig.MAP_CONFIG.DEFAULT_ZOOM);

            // Add base map layer
            L.tileLayer(AppConfig.MAP_CONFIG.TILE_LAYER, {
                attribution: AppConfig.MAP_CONFIG.ATTRIBUTION
            }).addTo(AppState.map);

            // Add flood risk layer
            AppState.floodLayer = L.layerGroup().addTo(AppState.map);

            // Add evacuation centers layer
            AppState.evacuationLayer = L.layerGroup().addTo(AppState.map);

            // Initialize user location marker
            AppState.userMarker = L.circleMarker([0, 0], {
                radius: AppConfig.MAP_CONFIG.USER_MARKER_RADIUS,
                fillColor: AppConfig.MAP_CONFIG.USER_MARKER_COLOR,
                color: "#FFFFFF",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });

            // Add map controls
            L.control.zoom({ position: 'topright' }).addTo(AppState.map);
            L.control.scale({ imperial: false, position: 'bottomright' }).addTo(AppState.map);
            L.control.attribution({
                position: 'bottomleft',
                prefix: '<a href="https://agos.ph">Agos PH</a> | <a href="https://openstreetmap.org">OSM</a>'
            }).addTo(AppState.map);
        }

        // Charts Initialization
        function initCharts() {
            // Rainfall chart
            const rainfallCtx = document.getElementById('rainfall-chart').getContext('2d');
            AppState.charts.rainfallChart = new Chart(rainfallCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Rainfall (mm)',
                    data: [],
                    backgroundColor: '#1976D2',
                    borderColor: '#1565C0',
                    borderWidth: 1
                }]},
                options: getChartOptions('mm')
            });

            // Forecast chart
            const forecastCtx = document.getElementById('forecast-chart').getContext('2d');
            AppState.charts.forecastChart = new Chart(forecastCtx, {
                type: 'line',
                data: { labels: [], datasets: [{
                    label: 'Water Level (cm)',
                    data: [],
                    fill: false,
                    backgroundColor: '#1976D2',
                    borderColor: '#1976D2',
                    tension: 0.4,
                    borderWidth: 3
                }]},
                options: getChartOptions('cm')
            });

            function getChartOptions(unit) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: unit } } },
                    plugins: { legend: { display: false } }
                };
            }
        }

        // Event Listeners
        function initEventListeners() {
            // Theme and language toggles
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('language-toggle').addEventListener('click', toggleLanguage);

            // Search functionality
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            document.getElementById('location-search').addEventListener('keypress', e => {
                if (e.key === 'Enter') handleSearch();
            });

            // Map controls
            document.getElementById('locate-me').addEventListener('click', locateUser);
            document.getElementById('zoom-in').addEventListener('click', () => AppState.map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => AppState.map.zoomOut());

            // Emergency actions
            document.getElementById('view-evac-routes').addEventListener('click', showEvacuationRoutes);
            document.getElementById('call-emergency').addEventListener('click', showEmergencyContacts);

            // Install prompt
            window.addEventListener('beforeinstallprompt', e => {
                e.preventDefault();
                AppState.deferredPrompt = e;
                showInstallPrompt();
            });

            document.getElementById('install-btn').addEventListener('click', () => {
                hideInstallPrompt();
                if (AppState.deferredPrompt) {
                    AppState.deferredPrompt.prompt();
                    AppState.deferredPrompt.userChoice.then(choiceResult => {
                        logEvent(choiceResult.outcome === 'accepted' ? 'install_accepted' : 'install_declined');
                        AppState.deferredPrompt = null;
                    });
                }
            });

            document.getElementById('dismiss-btn').addEventListener('click', () => {
                hideInstallPrompt();
                logEvent('install_dismissed');
            });

            // Notification prompts
            document.getElementById('enable-notifications').addEventListener('click', enableNotifications);
            document.getElementById('dismiss-notifications').addEventListener('click', () => {
                hideNotificationPrompt();
                logEvent('notifications_dismissed');
            });

            // Modal controls
            document.getElementById('emergency-modal-close').addEventListener('click', hideEmergencyModal);
            document.getElementById('emergency-modal-confirm').addEventListener('click', hideEmergencyModal);
            document.getElementById('bottom-sheet-close').addEventListener('click', hideBottomSheet);
            document.getElementById('bottom-sheet-overlay').addEventListener('click', hideBottomSheet);

            // Permission dialogs
            document.getElementById('grant-location').addEventListener('click', grantLocationPermission);
            document.getElementById('deny-location').addEventListener('click', denyLocationPermission);
            document.getElementById('tracking-confirm').addEventListener('click', saveTrackingPreferences);
            document.getElementById('tracking-cancel').addEventListener('click', hideTrackingDialog);

            // Online/offline detection
            window.addEventListener('online', handleOnlineStatusChange);
            window.addEventListener('offline', handleOnlineStatusChange);
        }

        // Permission Management
        async function requestPermissions() {
            if (AppState.preferences.locationPermission === 'unset') {
                await showLocationPermissionDialog();
            }

            if (AppState.preferences.notifications === 'unset' && 
                !['denied', 'granted'].includes(Notification.permission)) {
                showNotificationPrompt();
            }
        }

        async function showLocationPermissionDialog() {
            return new Promise(resolve => {
                const dialog = document.getElementById('location-permission-dialog');
                dialog.style.display = 'block';

                const cleanup = () => {
                    document.getElementById('grant-location').removeEventListener('click', onGrant);
                    document.getElementById('deny-location').removeEventListener('click', onDeny);
                };

                const onGrant = async () => {
                    cleanup();
                    dialog.style.display = 'none';
                    await grantLocationPermission();
                    resolve(true);
                };

                const onDeny = () => {
                    cleanup();
                    dialog.style.display = 'none';
                    denyLocationPermission();
                    resolve(false);
                };

                document.getElementById('grant-location').addEventListener('click', onGrant);
                document.getElementById('deny-location').addEventListener('click', onDeny);
            });
        }

        async function grantLocationPermission() {
            try {
                const position = await getCurrentPosition();
                AppState.preferences.locationPermission = 'granted';
                localStorage.setItem('locationPermission', 'granted');

                // Update UI with user's location
                AppState.currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    name: 'Your Location'
                };

                // Center map on user's location
                AppState.map.setView([position.coords.latitude, position.coords.longitude], 14);
                updateUserMarker(position.coords.latitude, position.coords.longitude);
                updateLocationInfo();

                logEvent('location_permission_granted');
            } catch (error) {
                console.error('Error getting location:', error);
                AppState.preferences.locationPermission = 'denied';
                localStorage.setItem('locationPermission', 'denied');
                logEvent('location_permission_denied');
            }
        }

        function denyLocationPermission() {
            AppState.preferences.locationPermission = 'denied';
            localStorage.setItem('locationPermission', 'denied');
            logEvent('location_permission_denied');
        }

        function updateUserMarker(lat, lng) {
            AppState.userMarker.setLatLng([lat, lng]).addTo(AppState.map);
        }

        function getCurrentPosition(timeout = 10000) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    { enableHighAccuracy: true, timeout, maximumAge: 0 }
                );
            });
        }

        // Tracking Preferences
        function showTrackingDialog() {
            document.getElementById('tracking-dialog').style.display = 'block';
        }

        function hideTrackingDialog() {
            document.getElementById('tracking-dialog').style.display = 'none';
        }

        function saveTrackingPreferences() {
            const selectedOption = document.querySelector('input[name="tracking"]:checked').value;
            AppState.preferences.tracking = selectedOption;
            localStorage.setItem('tracking', selectedOption);
            localStorage.setItem('trackingSet', 'true');
            hideTrackingDialog();
            logEvent('tracking_preferences_saved', { preference: selectedOption });
        }

        // Notification Management
        function showNotificationPrompt() {
            document.getElementById('notification-prompt').style.display = 'flex';
        }

        function hideNotificationPrompt() {
            document.getElementById('notification-prompt').style.display = 'none';
        }

        function enableNotifications() {
            Notification.requestPermission().then(permission => {
                AppState.preferences.notifications = permission;
                localStorage.setItem('notifications', permission);
                hideNotificationPrompt();
                logEvent(permission === 'granted' ? 'notifications_enabled' : 'notifications_denied');
            });
        }

        // UI Components
        function showInstallPrompt() {
            document.getElementById('install-prompt').style.display = 'flex';
        }

        function hideInstallPrompt() {
            document.getElementById('install-prompt').style.display = 'none';
        }

        function showEmergencyModal(title, content) {
            document.getElementById('emergency-modal-title').textContent = title;
            document.getElementById('emergency-modal-body').innerHTML = content;
            document.getElementById('emergency-modal').style.display = 'flex';
        }

        function hideEmergencyModal() {
            document.getElementById('emergency-modal').style.display = 'none';
        }

        function showBottomSheet(title, content) {
            document.getElementById('bottom-sheet-title').textContent = title;
            document.getElementById('bottom-sheet-content').innerHTML = content;
            document.getElementById('bottom-sheet').classList.add('active');
            document.getElementById('bottom-sheet-overlay').style.display = 'block';
        }

        function hideBottomSheet() {
            document.getElementById('bottom-sheet').classList.remove('active');
            document.getElementById('bottom-sheet-overlay').style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'road-alert';
            errorDiv.innerHTML = `
                <i class="material-icons">error</i>
                <div>
                    <div class="road-name">Error</div>
                    <div class="road-status">${message}</div>
                </div>
            `;
            document.querySelector('.dashboard')?.prepend(errorDiv);
        }

        // Network Status
        function handleOnlineStatusChange() {
            AppState.offlineMode = !navigator.onLine;
            document.getElementById('offline-indicator').style.display = AppState.offlineMode ? 'block' : 'none';
            
            if (navigator.onLine) loadData();
            logEvent('connection_change', { online: navigator.onLine });
        }

        function checkConnectivity() {
            handleOnlineStatusChange();
        }

        // Data Management
        async function loadInitialData() {
            showLoading(true);
            try {
                // Check for cached data first
                const cachedData = getCachedData();
                if (cachedData) {
                    updateAppState(cachedData);
                    updateUI();
                }

                // Then load fresh data
                await loadData();
            } catch (error) {
                console.error('Error loading initial data:', error);
                showError('Failed to load initial data. Using cached data if available.');
            } finally {
                showLoading(false);
            }
        }

        async function loadData() {
            if (AppState.offlineMode) return;

            showLoading(true);
            try {
                const [floodData, rainfallData, predictions, roads, evacuation, sensors] = await Promise.all([
                    fetchData(AppConfig.API_ENDPOINTS.FLOOD_DATA, processFloodData),
                    fetchData(AppConfig.API_ENDPOINTS.RAINFALL, processRainfallData),
                    fetchData(AppConfig.API_ENDPOINTS.PREDICTIONS, processPredictions),
                    fetchData(AppConfig.API_ENDPOINTS.ROADS, processRoadData),
                    fetchData(AppConfig.API_ENDPOINTS.EVACUATION, processEvacuationData),
                    fetchData(AppConfig.API_ENDPOINTS.SENSORS, processSensorData)
                ]);

                const processedData = {
                    floodData,
                    rainfallData,
                    predictions,
                    affectedRoads: roads,
                    evacuationCenters: evacuation,
                    sensorData: sensors,
                    lastUpdate: new Date(),
                    dataStatus: 'live'
                };

                updateAppState(processedData);
                updateUI();
                cacheData(processedData);
                checkForEmergencies();
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                AppState.dataStatus = 'error';
                showError('Failed to load latest data. Using cached data if available.');
                return false;
            } finally {
                showLoading(false);
            }
        }

        async function fetchData(endpoint, processor) {
            const url = `${AppConfig.API_BASE_URL}${endpoint}`;
            const response = await fetchWithRetry(url);
            const data = await response.json();
            return processor(data);
        }

        async function fetchWithRetry(url, options = {}, retries = AppConfig.MAX_RETRIES) {
            try {
                const response = await fetchWithTimeout(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchWithRetry(url, options, retries - 1);
                }
                throw error;
            }
        }

        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = AppConfig.TIMEOUT } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(resource, {
                ...options,
                signal: controller.signal,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AppConfig.API_KEY}`
                }
            });

            clearTimeout(id);
            return response;
        }

        // Data Processing
        function processFloodData(data) {
            if (!data?.locations) throw new Error('Invalid flood data format');
            return {
                locations: data.locations.map(location => ({
                    ...location,
                    coordinates: location.coordinates,
                    riskLevel: calculateRiskLevel(location.waterLevel),
                    lastUpdated: new Date(location.lastUpdated)
                })),
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function processRainfallData(data) {
            if (!data?.daily || !data?.hourly) throw new Error('Invalid rainfall data format');
            return {
                daily: data.daily,
                hourly: data.hourly,
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function processPredictions(data) {
            if (!data?.timeToFlood || !data?.riskLevel) throw new Error('Invalid predictions format');
            return {
                ...data,
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function processRoadData(data) {
            if (!data?.roads) throw new Error('Invalid road data format');
            return {
                roads: data.roads.map(road => ({
                    ...road,
                    lastUpdated: new Date(road.lastUpdated)
                })),
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function processEvacuationData(data) {
            if (!data?.centers) throw new Error('Invalid evacuation data format');
            return {
                centers: data.centers.map(center => ({
                    ...center,
                    lastUpdated: new Date(center.lastUpdated)
                })),
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function processSensorData(data) {
            if (!data?.sensors) throw new Error('Invalid sensor data format');
            return {
                sensors: data.sensors.map(sensor => ({
                    ...sensor,
                    lastUpdated: new Date(sensor.lastUpdated)
                })),
                lastUpdated: new Date(data.lastUpdated)
            };
        }

        function calculateRiskLevel(waterLevel) {
            if (waterLevel >= AppConfig.RISK_LEVELS.EXTREME.threshold) return 'extreme';
            if (waterLevel >= AppConfig.RISK_LEVELS.HIGH.threshold) return 'high';
            if (waterLevel >= AppConfig.RISK_LEVELS.MODERATE.threshold) return 'moderate';
            return 'low';
        }

        // Data Caching
        function getCachedData() {
            const cachedData = localStorage.getItem('floodDataCache');
            if (!cachedData) return null;

            try {
                const parsedData = JSON.parse(cachedData);
                const cacheAge = new Date() - new Date(parsedData.lastUpdate);
                if (cacheAge > AppConfig.CACHE_TTL) {
                    localStorage.removeItem('floodDataCache');
                    return null;
                }
                return parsedData;
            } catch (e) {
                console.error('Error parsing cached data:', e);
                return null;
            }
        }

        function cacheData(data) {
            try {
                localStorage.setItem('floodDataCache', JSON.stringify(data));
            } catch (e) {
                console.error('Error caching data:', e);
            }
        }

        // State Management
        function updateAppState(newState) {
            AppState.floodData = newState.floodData || AppState.floodData;
            AppState.rainfallData = newState.rainfallData || AppState.rainfallData;
            AppState.predictions = newState.predictions || AppState.predictions;
            AppState.affectedRoads = newState.affectedRoads || AppState.affectedRoads;
            AppState.evacuationCenters = newState.evacuationCenters || AppState.evacuationCenters;
            AppState.sensorData = newState.sensorData || AppState.sensorData;
            AppState.lastUpdate = newState.lastUpdate || AppState.lastUpdate;
            AppState.dataStatus = newState.dataStatus || AppState.dataStatus;
        }

        // UI Updates
        function updateUI() {
            updateLocationInfo();
            updateFloodLayer();
            updateEvacuationLayer();
            updateCharts();
            updateRoadAlerts();
            updateHotspotsList();
            updateEvacuationCentersList();
            updateSensorData();
            updatePredictions();
            updateLastUpdated();
        }

        function updateLocationInfo() {
            if (!AppState.currentLocation) {
                const center = AppState.map.getCenter();
                AppState.currentLocation = {
                    lat: center.lat,
                    lng: center.lng,
                    name: 'Current View'
                };
            }

            const nearestLocation = findNearestLocation(AppState.currentLocation);
            if (nearestLocation) {
                AppState.selectedLocation = nearestLocation;
                
                const locationInfo = document.getElementById('location-info');
                locationInfo.style.display = 'block';
                document.getElementById('selected-location').textContent = nearestLocation.name;
                document.getElementById('current-risk').textContent = nearestLocation.riskLevel.toUpperCase();
                document.getElementById('current-risk').className = `data-value ${nearestLocation.riskLevel}-risk`;
                document.getElementById('rainfall-value').textContent = `${nearestLocation.rainfall} mm/hr`;
                document.getElementById('water-level').textContent = `${nearestLocation.waterLevel} cm`;
                document.getElementById('flood-depth').textContent = getFloodDepthDescription(nearestLocation.waterLevel);
                document.getElementById('location-updated').textContent = `Updated: ${formatTime(nearestLocation.lastUpdated)}`;
            }
        }

        function getFloodDepthDescription(waterLevel) {
            if (waterLevel >= 100) return 'Dangerously Deep (100cm+)';
            if (waterLevel >= 60) return 'Waist-high (60-100cm)';
            if (waterLevel >= 30) return 'Knee-high (30-60cm)';
            if (waterLevel >= 15) return 'Ankle-high (15-30cm)';
            return 'Minimal (<15cm)';
        }

        function findNearestLocation(coords) {
            if (!AppState.floodData?.locations) return null;

            let nearest = null;
            let minDistance = Infinity;

            AppState.floodData.locations.forEach(location => {
                if (!location.coordinates) return;

                const center = getPolygonCenter(location.coordinates);
                const distance = calculateDistance(
                    coords.lat, coords.lng,
                    center.lat, center.lng
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = location;
                }
            });

            return nearest;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        function getPolygonCenter(coordinates) {
            let latSum = 0, lngSum = 0, count = 0;
            coordinates.forEach(point => {
                if (Array.isArray(point[0])) {
                    point.forEach(p => {
                        latSum += p[0];
                        lngSum += p[1];
                        count++;
                    });
                } else {
                    latSum += point[0];
                    lngSum += point[1];
                    count++;
                }
            });
            return { lat: latSum / count, lng: lngSum / count };
        }

        function updateFloodLayer() {
            if (!AppState.floodData || !AppState.map) return;

            AppState.floodLayer.clearLayers();
            AppState.floodData.locations.forEach(location => {
                if (!location.coordinates) return;

                const color = AppConfig.RISK_LEVELS[location.riskLevel]?.color || '#1976D2';
                const polygon = L.polygon(location.coordinates, {
                    color,
                    fillOpacity: AppConfig.MAP_CONFIG.FLOOD_LAYER_OPACITY,
                    weight: 2
                }).addTo(AppState.floodLayer);

                polygon.bindPopup(`
                    <h4>${location.name}</h4>
                    <p>Water Level: ${location.waterLevel} cm</p>
                    <p>Risk: <span class="${location.riskLevel}-risk">${location.riskLevel.toUpperCase()}</span></p>
                    <p>Updated: ${formatTime(location.lastUpdated)}</p>
                    <button onclick="window.zoomToLocation('${location.id}')">View Details</button>
                `);
            });
        }

        function updateEvacuationLayer() {
            if (!AppState.evacuationCenters || !AppState.map) return;

            AppState.evacuationLayer.clearLayers();
            AppState.evacuationCenters.centers.forEach(center => {
                if (!center.coordinates) return;

                const icon = L.divIcon({
                    className: 'evacuation-icon',
                    html: `<i class="material-icons" style="color: ${AppConfig.MAP_CONFIG.EVAC_MARKER_COLOR}; font-size: 24px;">place</i>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                const marker = L.marker(center.coordinates, { icon }).addTo(AppState.evacuationLayer);
                marker.bindPopup(`
                    <h4>${center.name}</h4>
                    <p>Capacity: ${center.capacity} people</p>
                    <p>Current: ${center.currentOccupancy} people</p>
                    <p>Distance: ${center.distance}</p>
                `);
            });
        }

        function updateCharts() {
            if (!AppState.rainfallData) return;

            // Rainfall chart
            AppState.charts.rainfallChart.data.labels = AppState.rainfallData.daily.map(d => d.day);
            AppState.charts.rainfallChart.data.datasets[0].data = AppState.rainfallData.daily.map(d => d.rainfall);
            AppState.charts.rainfallChart.update();

            // Forecast chart
            AppState.charts.forecastChart.data.labels = AppState.rainfallData.hourly.map(h => h.hour);
            AppState.charts.forecastChart.data.datasets[0].data = AppState.rainfallData.hourly.map(h => h.level);
            AppState.charts.forecastChart.update();
        }

        function updateRoadAlerts() {
            if (!AppState.affectedRoads) return;

            const container = document.getElementById('road-alerts');
            container.innerHTML = '';

            AppState.affectedRoads.roads.forEach(road => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'road-alert';
                alertDiv.innerHTML = `
                    <i class="material-icons">warning</i>
                    <div>
                        <div class="road-name">${road.name}</div>
                        <div class="road-status">${road.status}</div>
                    </div>
                `;
                alertDiv.addEventListener('click', () => {
                    showBottomSheet(road.name, `
                        <p><strong>Status:</strong> ${road.status}</p>
                        <p><strong>Last Updated:</strong> ${formatTime(road.lastUpdated)}</p>
                        <button class="modal-btn modal-btn-primary" onclick="window.zoomToRoad('${road.id}')">View on Map</button>
                    `);
                });
                container.appendChild(alertDiv);
            });
        }

        function updateHotspotsList() {
            if (!AppState.floodData) return;

            const container = document.getElementById('hotspots-list');
            container.innerHTML = '';

            const hotspots = [...AppState.floodData.locations]
                .sort((a, b) => b.waterLevel - a.waterLevel)
                .slice(0, 5);

            hotspots.forEach(location => {
                const hotspotDiv = document.createElement('div');
                hotspotDiv.className = 'sensor-item';
                hotspotDiv.innerHTML = `
                    <div class="sensor-icon">
                        <i class="material-icons">warning</i>
                    </div>
                    <div class="sensor-info">
                        <h4>${location.name}</h4>
                        <div class="sensor-value ${location.riskLevel}-risk">${location.waterLevel} cm (${location.riskLevel.toUpperCase()})</div>
                    </div>
                `;
                hotspotDiv.addEventListener('click', () => {
                    window.zoomToLocation(location.id);
                });
                container.appendChild(hotspotDiv);
            });
        }

        function updateEvacuationCentersList() {
            if (!AppState.evacuationCenters) return;

            const container = document.getElementById('evacuation-centers');
            container.innerHTML = '';

            AppState.evacuationCenters.centers.forEach(center => {
                const centerDiv = document.createElement('div');
                centerDiv.className = 'sensor-item';
                centerDiv.innerHTML = `
                    <div class="sensor-icon">
                        <i class="material-icons">place</i>
                    </div>
                    <div class="sensor-info">
                        <h4>${center.name}</h4>
                        <div class="sensor-value">${center.distance} â€¢ ${center.currentOccupancy}/${center.capacity}</div>
                    </div>
                `;
                centerDiv.addEventListener('click', () => {
                    showBottomSheet(center.name, `
                        <p><strong>Distance:</strong> ${center.distance}</p>
                        <p><strong>Capacity:</strong> ${center.currentOccupancy}/${center.capacity} people</p>
                        <p><strong>Status:</strong> ${center.currentOccupancy >= center.capacity ? 'Full' : 'Available'}</p>
                        <button class="modal-btn modal-btn-primary" onclick="window.zoomToEvacuationCenter('${center.id}')">View on Map</button>
                    `);
                });
                container.appendChild(centerDiv);
            });
        }

        function updateSensorData() {
            if (!AppState.sensorData) return;

            const sensorTypes = {
                'rain-rate': 'water_drop',
                'rise-velocity': 'trending_up',
                'last-heavy-rain': 'calendar_today',
                'vs-average': 'compare'
            };

            Object.keys(sensorTypes).forEach(id => {
                const sensor = AppState.sensorData.sensors.find(s => s.type === id);
                if (sensor) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = `${sensor.value} ${sensor.unit || ''}`;
                    }
                }
            });
        }

        function updatePredictions() {
            if (!AppState.predictions) return;

            document.getElementById('prediction-time').textContent = AppState.predictions.timeToFlood;
            document.getElementById('prediction-level').textContent = AppState.predictions.riskLevel.toUpperCase();
            document.getElementById('prediction-level').className = `prediction-level ${AppState.predictions.riskLevel}-risk`;
            document.getElementById('prediction-details').textContent = `Confidence: ${AppState.predictions.confidence}%`;
        }

        function updateLastUpdated() {
            if (AppState.lastUpdate) {
                document.getElementById('update-time').textContent = formatDateTime(AppState.lastUpdate);
            }
        }

        // Emergency Management
        function checkForEmergencies() {
            if (!AppState.selectedLocation) return;
            if (['high', 'extreme'].includes(AppState.selectedLocation.riskLevel)) {
                showEmergencyAlert(AppState.selectedLocation);
            }
        }

        function showEmergencyAlert(location) {
            const emergencyCard = document.getElementById('emergency-card');
            const emergencyContent = document.getElementById('emergency-alert-content');

            emergencyContent.innerHTML = `
                <p>Flood warning for ${location.name}. Water level is ${location.waterLevel} cm (${location.riskLevel.toUpperCase()} risk).</p>
                <p>${getEmergencyAdvice(location.riskLevel)}</p>
            `;

            emergencyCard.style.display = 'block';
            emergencyCard.classList.add('animate__animated', 'animate__shakeX');
            setTimeout(() => {
                emergencyCard.classList.remove('animate__animated', 'animate__shakeX');
            }, 1000);

            // Show notification if permission granted
            if (Notification.permission === 'granted') {
                new Notification('FLOOD WARNING', {
                    body: `Flood warning for ${location.name}. Water level is ${location.waterLevel} cm.`,
                    icon: 'icons/icon-192x192.png'
                });
            }

            logEvent('emergency_alert_shown', {
                location: location.name,
                waterLevel: location.waterLevel,
                riskLevel: location.riskLevel
            });
        }

        function getEmergencyAdvice(riskLevel) {
            switch (riskLevel) {
                case 'extreme': return 'Immediate evacuation recommended. Move to higher ground or designated evacuation center.';
                case 'high': return 'Prepare to evacuate. Gather essential items and monitor water levels closely.';
                case 'moderate': return 'Stay alert. Avoid low-lying areas and prepare emergency supplies.';
                default: return 'Monitor situation. Be prepared to move if conditions worsen.';
            }
        }

        // User Interactions
        async function handleSearch() {
            const searchInput = document.getElementById('location-search');
            const query = searchInput.value.trim();
            if (!query) return;

            document.getElementById('search-text').style.display = 'none';
            document.getElementById('search-spinner').style.display = 'inline-block';

            try {
                const response = await fetch(`${AppConfig.API_BASE_URL}${AppConfig.API_ENDPOINTS.GEOLOCATION}?query=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${AppConfig.API_KEY}` }
                });
                
                if (!response.ok) throw new Error('Location not found');
                
                const location = await response.json();
                AppState.currentLocation = {
                    lat: location.latitude,
                    lng: location.longitude,
                    name: location.name
                };

                AppState.map.setView([location.latitude, location.longitude], 14);
                updateLocationInfo();
                logEvent('location_searched', { query, found: true });
                
            } catch (error) {
                console.error('Search error:', error);
                showBottomSheet('Search Results', `
                    <p>No matches found for "${query}".</p>
                    <p>Try searching for nearby barangays or cities.</p>
                `);
                logEvent('location_searched', { query, found: false, error: error.message });
            } finally {
                document.getElementById('search-text').style.display = 'inline';
                document.getElementById('search-spinner').style.display = 'none';
            }
        }

        async function locateUser() {
            if (AppState.preferences.locationPermission === 'denied') {
                showBottomSheet('Location Access', `
                    <p>You've previously denied location access.</p>
                    <p>Please enable location permissions in your browser settings to use this feature.</p>
                `);
                return;
            }

            showLoading(true);
            try {
                const position = await getCurrentPosition();
                AppState.currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    name: 'Your Location'
                };

                AppState.map.setView([position.coords.latitude, position.coords.longitude], 14);
                updateUserMarker(position.coords.latitude, position.coords.longitude);
                updateLocationInfo();
                logEvent('location_updated', {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                });
            } catch (error) {
                console.error('Location error:', error);
                showBottomSheet('Location Error', `<p>Unable to determine your location.</p><p>${error.message}</p>`);
                logEvent('location_error', { error: error.message });
            } finally {
                showLoading(false);
            }
        }

        function showEvacuationRoutes() {
            if (!AppState.currentLocation || !AppState.evacuationCenters) return;
            const nearestEvacCenter = findNearestEvacuationCenter(AppState.currentLocation);

            if (nearestEvacCenter) {
                showBottomSheet('Nearest Evacuation Center', `
                    <p><strong>Name:</strong> ${nearestEvacCenter.name}</p>
                    <p><strong>Distance:</strong> ${nearestEvacCenter.distance}</p>
                    <p><strong>Capacity:</strong> ${nearestEvacCenter.currentOccupancy}/${nearestEvacCenter.capacity}</p>
                    <p><strong>Status:</strong> ${nearestEvacCenter.currentOccupancy >= nearestEvacCenter.capacity ? 'Full' : 'Available'}</p>
                    <button class="modal-btn modal-btn-primary" onclick="window.zoomToEvacuationCenter('${nearestEvacCenter.id}')">View on Map</button>
                `);
                logEvent('evacuation_routes_viewed', {
                    center: nearestEvacCenter.name,
                    distance: nearestEvacCenter.distance
                });
            }
        }

        function findNearestEvacuationCenter(coords) {
            if (!AppState.evacuationCenters?.centers) return null;
            
            let nearest = null;
            let minDistance = Infinity;

            AppState.evacuationCenters.centers.forEach(center => {
                if (!center.coordinates) return;
                const distance = calculateDistance(
                    coords.lat, coords.lng,
                    center.coordinates[0], center.coordinates[1]
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = center;
                }
            });

            return nearest;
        }

        function showEmergencyContacts() {
            const contactsHTML = AppConfig.EMERGENCY_CONTACTS.map(contact => 
                `<p><strong>${contact.name}:</strong> ${contact.number}</p>`
            ).join('');
            
            showBottomSheet('Emergency Contacts', contactsHTML);
            logEvent('emergency_contacts_viewed');
        }

        // Utility Functions
        function formatTime(date) {
            if (!(date instanceof Date)) date = new Date(date);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTime(date) {
            if (!(date instanceof Date)) date = new Date(date);
            return date.toLocaleString([], {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function logEvent(eventName, metadata = {}) {
            if (AppState.preferences.tracking === 'essential') return;

            const eventData = {
                event: eventName,
                timestamp: new Date().toISOString(),
                location: AppState.currentLocation,
                ...metadata
            };

            console.log('Event:', eventData);
            
            // In production, send to analytics endpoint
            if (AppState.preferences.tracking !== 'essential' && !AppState.offlineMode) {
                fetch(`${AppConfig.API_BASE_URL}/analytics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppConfig.API_KEY}`
                    },
                    body: JSON.stringify(eventData)
                }).catch(console.error);
            }
        }

        // Global Functions
        window.zoomToLocation = function(locationId) {
            const location = AppState.floodData.locations.find(loc => loc.id === locationId);
            if (location?.coordinates) {
                AppState.map.fitBounds(location.coordinates);
                AppState.currentLocation = {
                    lat: location.coordinates[0][0],
                    lng: location.coordinates[0][1],
                    name: location.name
                };
                updateLocationInfo();
                hideBottomSheet();
            }
        };

        window.zoomToRoad = function(roadId) {
            const road = AppState.affectedRoads.roads.find(r => r.id === roadId);
            if (road?.coordinates) {
                AppState.map.fitBounds(road.coordinates);
                hideBottomSheet();
            }
        };

        window.zoomToEvacuationCenter = function(centerId) {
            const center = AppState.evacuationCenters.centers.find(c => c.id === centerId);
            if (center?.coordinates) {
                AppState.map.setView(center.coordinates, 15);
                hideBottomSheet();
            }
        };

        window.showLoading = showLoading;
    </script>
</body>
</html>