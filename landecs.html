<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NearCheck Lite - Geolocation Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<style>
/* Base Styles */
:root {
  --primary-color: #4a6bff;
  --primary-dark: #3a56cc;
  --primary-light: #6b84ff;
  --secondary-color: #6c757d;
  --success-color: #28a745;
  --danger-color: #dc3545;
  --warning-color: #ffc107;
  --info-color: #17a2b8;
  --light-color: #f8f9fa;
  --dark-color: #343a40;
  --white: #ffffff;
  --gray-100: #f8f9fa;
  --gray-200: #e9ecef;
  --gray-300: #dee2e6;
  --gray-400: #ced4da;
  --gray-500: #adb5bd;
  --gray-600: #6c757d;
  --gray-700: #495057;
  --gray-800: #343a40;
  --gray-900: #212529;
  --border-radius: 8px;
  --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'poppins', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: var(--gray-800);
  background-color: var(--gray-100);
}

a {
  text-decoration: none;
  color: var(--primary-color);
}

button {
  cursor: pointer;
  font-family: inherit;
}

input, select, textarea {
  font-family: inherit;
  font-size: inherit;
}

.hidden {
  display: none !important;
}

/* Utility Classes */
.text-center {
  text-align: center;
}

.text-right {
  text-align: right;
}

.text-left {
  text-align: left;
}

.flex {
  display: flex;
}

.flex-col {
  flex-direction: column;
}

.items-center {
  align-items: center;
}

.justify-center {
  justify-content: center;
}

.justify-between {
  justify-content: space-between;
}

.gap-1 {
  gap: 0.25rem;
}

.gap-2 {
  gap: 0.5rem;
}

.gap-3 {
  gap: 1rem;
}

.gap-4 {
  gap: 1.5rem;
}

.gap-5 {
  gap: 2rem;
}

.mt-1 {
  margin-top: 0.25rem;
}

.mt-2 {
  margin-top: 0.5rem;
}

.mt-3 {
  margin-top: 1rem;
}

.mt-4 {
  margin-top: 1.5rem;
}

.mt-5 {
  margin-top: 2rem;
}

.mb-1 {
  margin-bottom: 0.25rem;
}

.mb-2 {
  margin-bottom: 0.5rem;
}

.mb-3 {
  margin-bottom: 1rem;
}

.mb-4 {
  margin-bottom: 1.5rem;
}

.mb-5 {
  margin-bottom: 2rem;
}

.p-1 {
  padding: 0.25rem;
}

.p-2 {
  padding: 0.5rem;
}

.p-3 {
  padding: 1rem;
}

.p-4 {
  padding: 1.5rem;
}

.p-5 {
  padding: 2rem;
}

.rounded {
  border-radius: var(--border-radius);
}

.rounded-full {
  border-radius: 9999px;
}

.shadow {
  box-shadow: var(--box-shadow);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  border: none;
  font-weight: 500;
  transition: var(--transition);
}

.primary-btn {
  background-color: var(--primary-color);
  color: var(--white);
}

.primary-btn:hover {
  background-color: var(--primary-dark);
}

.secondary-btn {
  background-color: var(--gray-200);
  color: var(--gray-800);
}

.secondary-btn:hover {
  background-color: var(--gray-300);
}

.danger-btn {
  background-color: var(--danger-color);
  color: var(--white);
}

.danger-btn:hover {
  background-color: #c82333;
}

.icon-btn {
  background: none;
  border: none;
  color: var(--gray-600);
  padding: 0.5rem;
  border-radius: 50%;
  transition: var(--transition);
}

.icon-btn:hover {
  background-color: var(--gray-200);
  color: var(--gray-800);
}

.text-btn {
  background: none;
  border: none;
  color: var(--primary-color);
  padding: 0;
  font-weight: 500;
}

.text-btn:hover {
  text-decoration: underline;
}

.role-btn {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: var(--border-radius);
  border: 1px solid var(--gray-300);
  background-color: var(--white);
  transition: var(--transition);
}

.role-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Forms */
.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.checkbox-group input {
  width: auto;
}

/* Auth Container */
#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.auth-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 2rem;
  background-color: var(--white);
}

.auth-content {
  max-width: 400px;
  width: 100%;
  background-color: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  overflow: hidden;
}

.auth-header {
  padding: 2rem;
  text-align: center;
  background-color: var(--primary-color);
  color: var(--white);
}

.auth-header .logo {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.auth-header .tagline {
  font-size: 1rem;
  opacity: 0.9;
}

.auth-section {
  padding: 2rem;
}

.auth-section h2 {
  margin-bottom: 1.5rem;
  text-align: center;
}

.greeting {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.role-prompt {
  color: var(--gray-600);
  margin-bottom: 1.5rem;
}

.role-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.auth-footer {
  margin-top: 1.5rem;
  text-align: center;
}

.terms-notice {
  font-size: 0.75rem;
  color: var(--gray-600);
  margin-top: 1rem;
}

.username-preview {
  font-size: 0.875rem;
  color: var(--gray-600);
  margin-top: 0.5rem;
}

/* Main App Layout */
#main-app {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 250px;
  background-color: var(--white);
  border-right: 1px solid var(--gray-200);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-200);
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary-color);
  color: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}

.avatar.large {
  width: 80px;
  height: 80px;
  font-size: 2rem;
}

.display-name {
  font-weight: 600;
}

.user-role {
  font-size: 0.875rem;
  color: var(--gray-600);
}

.sidebar-menu {
  flex: 1;
  padding: 1rem 0;
}

.sidebar-menu ul {
  list-style: none;
}

.sidebar-menu li {
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  transition: var(--transition);
}

.sidebar-menu li:hover {
  background-color: var(--gray-100);
}

.sidebar-menu li.active {
  background-color: var(--primary-light);
  color: var(--primary-dark);
  font-weight: 600;
}

.sidebar-menu li i {
  width: 20px;
  text-align: center;
}

.sidebar-footer {
  padding: 1rem;
  border-top: 1px solid var(--gray-200);
}

.main-content {
  flex: 1;
  background-color: var(--gray-100);
  overflow-y: auto;
}

.content-section {
  padding: 2rem;
  display: none;
}

.content-section.active {
  display: block;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.section-header h1 {
  font-size: 1.75rem;
  font-weight: 600;
}

.header-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.search-container {
  position: relative;
}

.search-container input {
  padding: 0.5rem 1rem 0.5rem 2rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--border-radius);
}

.search-container i {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-500);
}

/* Dashboard */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--gray-600);
  font-size: 0.875rem;
}

.carousel {
  margin-bottom: 2rem;
}

.carousel-inner {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.section-card {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  cursor: pointer;
}

.section-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.section-card h3 {
  margin-bottom: 0.5rem;
}

.section-card p {
  color: var(--gray-600);
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

.section-card .section-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--gray-500);
}

/* Sections List */
#sections-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}

.section-item {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 1rem;
  box-shadow: var(--box-shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-item-info h3 {
  margin-bottom: 0.25rem;
}

.section-item-info p {
  color: var(--gray-600);
  font-size: 0.875rem;
}

.section-item-actions {
  display: flex;
  gap: 0.5rem;
}

/* Attendance */
.attendance-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.section-selector,
.date-selector {
  flex: 1;
  min-width: 200px;
}

.attendance-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.summary-card {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 1rem;
  text-align: center;
  box-shadow: var(--box-shadow);
}

.summary-card.present {
  border-top: 4px solid var(--success-color);
}

.summary-card.absent {
  border-top: 4px solid var(--danger-color);
}

.summary-card.excused {
  border-top: 4px solid var(--warning-color);
}

.summary-value {
  font-size: 1.5rem;
  font-weight: 700;
}

.summary-label {
  color: var(--gray-600);
  font-size: 0.875rem;
}

#attendance-list-container {
  background-color: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  overflow: hidden;
}

#attendance-list {
  width: 100%;
  border-collapse: collapse;
}

#attendance-list th,
#attendance-list td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid var(--gray-200);
}

#attendance-list th {
  font-weight: 600;
  background-color: var(--gray-100);
}

#attendance-list tr:last-child td {
  border-bottom: none;
}

.status-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-badge.present {
  background-color: rgba(40, 167, 69, 0.1);
  color: var(--success-color);
}

.status-badge.absent {
  background-color: rgba(220, 53, 69, 0.1);
  color: var(--danger-color);
}

.status-badge.excused {
  background-color: rgba(255, 193, 7, 0.1);
  color: var(--warning-color);
}

.status-badge.late {
  background-color: rgba(23, 162, 184, 0.1);
  color: var(--info-color);
}

/* Settings */
.settings-container {
  max-width: 800px;
  margin: 0 auto;
}

.settings-group {
  margin-bottom: 2rem;
}

.settings-group h2 {
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--gray-200);
}

.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background-color: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin-bottom: 0.75rem;
  transition: var(--transition);
}

.settings-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.settings-item-content {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.settings-item-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary-light);
  color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-item-title {
  font-weight: 600;
}

.settings-item-description {
  font-size: 0.875rem;
  color: var(--gray-600);
}

.settings-item-action {
  background: none;
  border: none;
  color: var(--gray-500);
}

/* Modals */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.modal.active {
  opacity: 1;
  pointer-events: all;
}

.modal-content {
  background-color: var(--white);
  border-radius: var(--border-radius);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(20px);
  transition: transform 0.3s ease;
}

.modal.active .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--gray-500);
  cursor: pointer;
}

.modal-body {
  padding: 1.5rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.warning-message {
  display: flex;
  gap: 1rem;
  background-color: rgba(220, 53, 69, 0.1);
  padding: 1rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
}

.warning-message i {
  color: var(--danger-color);
  font-size: 1.5rem;
}

.warning-message p {
  color: var(--danger-color);
}

.info-message {
  display: flex;
  gap: 1rem;
  background-color: rgba(23, 162, 184, 0.1);
  padding: 1rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
}

.info-message i {
  color: var(--info-color);
  font-size: 1.5rem;
}

.info-message p {
  color: var(--info-color);
}

.success-message {
  text-align: center;
  padding: 2rem;
}

.success-message i {
  color: var(--success-color);
  font-size: 3rem;
  margin-bottom: 1rem;
}

.error-message {
  text-align: center;
  padding: 2rem;
}

.error-message i {
  color: var(--danger-color);
  font-size: 3rem;
  margin-bottom: 1rem;
}

/* Bottom Sheets */
.bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: var(--white);
  border-radius: var(--border-radius) var(--border-radius) 0 0;
  box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 1000;
  max-height: 90vh;
  overflow-y: auto;
}

.bottom-sheet.active {
  transform: translateY(0);
}

.sheet-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background-color: var(--white);
  z-index: 10;
}

.sheet-header h3 {
  margin: 0;
}

.sheet-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--gray-500);
  cursor: pointer;
}

.sheet-body {
  padding: 1.5rem;
}

.sheet-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--gray-200);
  display: flex;
  gap: 1rem;
  position: sticky;
  bottom: 0;
  background-color: var(--white);
  z-index: 10;
}

/* Progress Bar */
.progress-bar {
  height: 8px;
  background-color: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.progress-fill {
  height: 100%;
  background-color: var(--primary-color);
  width: 0;
  transition: width 0.3s ease;
}

.progress-text {
  text-align: center;
  color: var(--gray-600);
  font-size: 0.875rem;
}

/* QR Code */
.qr-code-container {
  display: flex;
  justify-content: center;
  padding: 1rem;
  background-color: var(--white);
  border-radius: var(--border-radius);
  margin-bottom: 1rem;
}

/* Profile Editor */
.profile-avatar-preview {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
}

.profile-edit-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 2rem;
}

.edit-option button {
  width: 100%;
}

.emoji-categories {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

.emoji-categories button {
  background: none;
  border: none;
  padding: 0.5rem;
  white-space: nowrap;
  border-radius: var(--border-radius);
}

.emoji-categories button:hover {
  background-color: var(--gray-200);
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  padding: 0.5rem;
}

.emoji-grid span {
  font-size: 1.5rem;
  text-align: center;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: var(--border-radius);
}

.emoji-grid span:hover {
  background-color: var(--gray-200);
}

/* Notifications */
#notification-container {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1100;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.notification {
  padding: 1rem;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  display: flex;
  align-items: center;
  gap: 1rem;
  max-width: 350px;
  transform: translateX(100%);
  opacity: 0;
  transition: all 0.3s ease;
}

.notification.show {
  transform: translateX(0);
  opacity: 1;
}

.notification i {
  font-size: 1.5rem;
}

.notification.success {
  background-color: var(--white);
  border-left: 4px solid var(--success-color);
}

.notification.error {
  background-color: var(--white);
  border-left: 4px solid var(--danger-color);
}

.notification.warning {
  background-color: var(--white);
  border-left: 4px solid var(--warning-color);
}

.notification.info {
  background-color: var(--white);
  border-left: 4px solid var(--info-color);
}

.notification-close {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--gray-500);
  cursor: pointer;
}

/* Responsive Design */
@media (max-width: 768px) {
  #main-app {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--gray-200);
  }
  
  .sidebar-menu ul {
    display: flex;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  
  .sidebar-menu li {
    white-space: nowrap;
  }
  
  .stats-container {
    grid-template-columns: 1fr;
  }
  
  .attendance-summary {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
  }
  
  .profile-edit-options {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .auth-container {
    padding: 1rem;
  }
  
  .auth-header {
    padding: 1.5rem;
  }
  
  .auth-section {
    padding: 1.5rem;
  }
  
  .role-buttons {
    grid-template-columns: 1fr;
  }
  
  .content-section {
    padding: 1rem;
  }
  
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .header-actions {
    width: 100%;
  }
  
  .search-container {
    flex: 1;
  }
  
  .modal-body {
    padding: 1rem;
  }
  
  .sheet-body {
    padding: 1rem;
  }
  
  .sheet-footer {
    padding: 1rem;
  }
}
</style>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        <!-- Auth Screens -->
        <div id="auth-container" class="auth-container">
            <div class="auth-content">
                <div class="auth-header">
                    <div class="logo">NearCheck Lite</div>
                    <div class="tagline">Attendance. Smarter than ever.</div>
                </div>
                
                <!-- Role Selection -->
                <div id="role-selection" class="auth-section">
                    <div class="greeting">Hi there! Let's get you started.</div>
                    <div class="role-prompt">Choose your role to get started</div>
                    <div class="role-buttons">
                        <button id="teacher-role-btn" class="role-btn">Teacher</button>
                        <button id="student-role-btn" class="role-btn">Student</button>
                    </div>
                    <div class="auth-footer">
                        <button id="auth-signin-btn" class="text-btn">Already have an account? Sign In</button>
                        <div class="terms-notice">By continuing to NearCheck Lite you agree with our <a href="#" id="terms-link">Terms</a> and <a href="#" id="privacy-link">Privacy Policy</a></div>
                    </div>
                </div>
                
                <!-- Teacher Sign Up -->
                <div id="teacher-signup" class="auth-section hidden">
                    <h2>Teacher Sign Up</h2>
                    <form id="teacher-signup-form">
                        <div class="form-group">
                            <label for="teacher-fullname">Full Name</label>
                            <input type="text" id="teacher-fullname" required>
                            <div class="username-preview">
                                <span>Your username will be: </span>
                                <span id="teacher-username-preview"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="teacher-email">Email</label>
                            <input type="email" id="teacher-email" required>
                        </div>
                        <div class="form-group">
                            <label for="teacher-password">Password</label>
                            <input type="password" id="teacher-password" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label for="teacher-confirm-password">Confirm Password</label>
                            <input type="password" id="teacher-confirm-password" required minlength="8">
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="teacher-age-confirm" required>
                            <label for="teacher-age-confirm">I confirm that I am 20 years old or above</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="teacher-terms" required>
                            <label for="teacher-terms">I agree to NearCheck Lite's Terms and Privacy Policy</label>
                        </div>
                        <button type="submit" class="primary-btn">Continue</button>
                    </form>
                    <button id="teacher-signup-back" class="text-btn">Back</button>
                </div>
                
                <!-- Student Sign Up -->
                <div id="student-signup" class="auth-section hidden">
                    <h2>Student Sign Up</h2>
                    <form id="student-signup-form">
                        <div class="form-group">
                            <label for="student-fullname">Full Name</label>
                            <input type="text" id="student-fullname" required>
                            <div class="username-preview">
                                <span>Your username will be: </span>
                                <span id="student-username-preview"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="student-email">Email</label>
                            <input type="email" id="student-email" required>
                        </div>
                        <div class="form-group">
                            <label for="student-password">Password</label>
                            <input type="password" id="student-password" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label for="student-confirm-password">Confirm Password</label>
                            <input type="password" id="student-confirm-password" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label for="student-section-id">Section ID (optional)</label>
                            <input type="text" id="student-section-id" placeholder="Enter if you have an invitation">
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="student-age-confirm" required>
                            <label for="student-age-confirm">I confirm that I am 13 years old or above</label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="student-terms" required>
                            <label for="student-terms">I agree to NearCheck Lite's Terms and Privacy Policy</label>
                        </div>
                        <button type="submit" class="primary-btn">Continue</button>
                    </form>
                    <button id="student-signup-back" class="text-btn">Back</button>
                </div>
                
                <!-- Sign In -->
                <div id="signin" class="auth-section hidden">
                    <h2>Sign In</h2>
                    <form id="signin-form">
                        <div class="form-group">
                            <label for="signin-identifier">Email or Username</label>
                            <input type="text" id="signin-identifier" required>
                        </div>
                        <div class="form-group">
                            <label for="signin-password">Password</label>
                            <input type="password" id="signin-password" required>
                        </div>
                        <button type="submit" class="primary-btn">Continue</button>
                    </form>
                    <button id="forgot-password-btn" class="text-btn">Forgot Password?</button>
                    <button id="signin-back" class="text-btn">Back</button>
                </div>
                
                <!-- Forgot Password -->
                <div id="forgot-password" class="auth-section hidden">
                    <h2>Reset Password</h2>
                    <form id="forgot-password-form">
                        <div class="form-group">
                            <label for="reset-email">Email</label>
                            <input type="email" id="reset-email" required>
                        </div>
                        <button type="submit" class="primary-btn">Send Reset Link</button>
                    </form>
                    <button id="forgot-password-back" class="text-btn">Back to Sign In</button>
                </div>
            </div>
        </div>
        
        <!-- Main App Interface (hidden until auth) -->
        <div id="main-app" class="hidden">
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <div class="user-profile">
                        <div id="user-avatar" class="avatar"></div>
                        <div class="user-info">
                            <div id="user-display-name" class="display-name"></div>
                            <div id="user-role" class="user-role"></div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-menu">
                    <ul>
                        <li class="active" data-section="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </li>
                        <li data-section="sections">
                            <i class="fas fa-users-class"></i>
                            <span>My Sections</span>
                        </li>
                        <li data-section="attendance">
                            <i class="fas fa-clipboard-check"></i>
                            <span>Attendance</span>
                        </li>
                        <li data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </li>
                        <li id="deleted-sections-menu" class="hidden" data-section="deleted-sections">
                            <i class="fas fa-trash-restore"></i>
                            <span>Deleted Sections</span>
                        </li>
                    </ul>
                </div>
                
                <div class="sidebar-footer">
                    <button id="signout-btn" class="text-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div id="main-content" class="main-content">
                <!-- Dashboard -->
                <div id="dashboard-section" class="content-section">
                    <div class="section-header">
                        <h1 id="greeting"></h1>
                        <div class="header-actions">
                            <button id="refresh-btn" class="icon-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-dashboard" class="hidden">
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-value" id="total-sections">0</div>
                                <div class="stat-label">Sections</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="total-students">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="active-sessions">0</div>
                                <div class="stat-label">Active Sessions</div>
                            </div>
                        </div>
                        
                        <h2>Your Sections</h2>
                        <div id="teacher-sections-carousel" class="carousel">
                            <div class="carousel-inner">
                                <!-- Sections will be added here dynamically -->
                            </div>
                            <button id="create-section-btn" class="primary-btn">
                                <i class="fas fa-plus"></i> Create New Section
                            </button>
                        </div>
                    </div>
                    
                    <div id="student-dashboard" class="hidden">
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-value" id="enrolled-sections">0</div>
                                <div class="stat-label">Sections</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="total-checkins">0</div>
                                <div class="stat-label">Check-ins</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="active-checkins">0</div>
                                <div class="stat-label">Active</div>
                            </div>
                        </div>
                        
                        <h2>Your Enrolled Sections</h2>
                        <div id="student-sections-carousel" class="carousel">
                            <div class="carousel-inner">
                                <!-- Sections will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sections Management -->
                <div id="sections-section" class="content-section hidden">
                    <div class="section-header">
                        <h1>My Sections</h1>
                        <div class="header-actions">
                            <div class="search-container">
                                <input type="text" id="search-sections" placeholder="Search sections...">
                                <i class="fas fa-search"></i>
                            </div>
                            <button id="refresh-sections-btn" class="icon-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-sections-view" class="hidden">
                        <div id="sections-list">
                            <!-- Sections will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div id="student-sections-view" class="hidden">
                        <div id="enrolled-sections-list">
                            <!-- Enrolled sections will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Attendance -->
                <div id="attendance-section" class="content-section hidden">
                    <div class="section-header">
                        <h1>Attendance</h1>
                        <div class="header-actions">
                            <div class="search-container">
                                <input type="text" id="search-attendance" placeholder="Search...">
                                <i class="fas fa-search"></i>
                            </div>
                            <button id="refresh-attendance-btn" class="icon-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-attendance-view" class="hidden">
                        <div class="attendance-controls">
                            <div class="section-selector">
                                <label for="attendance-section-select">Section:</label>
                                <select id="attendance-section-select">
                                    <!-- Sections will be populated here -->
                                </select>
                            </div>
                            <div class="date-selector">
                                <label for="attendance-date-select">Date:</label>
                                <input type="date" id="attendance-date-select">
                            </div>
                            <button id="download-attendance-btn" class="secondary-btn">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                        
                        <div id="attendance-summary">
                            <div class="summary-card present">
                                <div class="summary-value" id="present-count">0</div>
                                <div class="summary-label">Present</div>
                            </div>
                            <div class="summary-card absent">
                                <div class="summary-value" id="absent-count">0</div>
                                <div class="summary-label">Absent</div>
                            </div>
                            <div class="summary-card excused">
                                <div class="summary-value" id="excused-count">0</div>
                                <div class="summary-label">Excused</div>
                            </div>
                        </div>
                        
                        <div id="attendance-list-container">
                            <table id="attendance-list">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance records will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="student-attendance-view" class="hidden">
                        <div class="section-selector">
                            <label for="student-attendance-section-select">Section:</label>
                            <select id="student-attendance-section-select">
                                <!-- Sections will be populated here -->
                            </select>
                        </div>
                        
                        <div id="student-attendance-summary">
                            <div class="summary-card">
                                <div class="summary-value" id="student-total-checkins">0</div>
                                <div class="summary-label">Total Check-ins</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-value" id="student-percentage">0%</div>
                                <div class="summary-label">Attendance Rate</div>
                            </div>
                        </div>
                        
                        <div id="student-attendance-list-container">
                            <table id="student-attendance-list">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance records will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Settings -->
                <div id="settings-section" class="content-section hidden">
                    <div class="section-header">
                        <h1>Settings</h1>
                    </div>
                    
                    <div class="settings-container">
                        <div class="settings-group">
                            <h2>Account</h2>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Profile</div>
                                        <div class="settings-item-description">Update your display identity</div>
                                    </div>
                                </div>
                                <button id="edit-profile-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Email</div>
                                        <div class="settings-item-description">Change or add backup email</div>
                                    </div>
                                </div>
                                <button id="edit-email-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Password</div>
                                        <div class="settings-item-description">Change your password</div>
                                    </div>
                                </div>
                                <button id="change-password-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h2>Preferences</h2>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Location</div>
                                        <div class="settings-item-description">Manage location permissions</div>
                                    </div>
                                </div>
                                <button id="location-settings-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Notifications</div>
                                        <div class="settings-item-description">Manage notification preferences</div>
                                    </div>
                                </div>
                                <button id="notification-settings-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h2>About</h2>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-info-circle"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">About NearCheck Lite</div>
                                        <div class="settings-item-description">Version 1.0.0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Privacy Policy</div>
                                    </div>
                                </div>
                                <button id="privacy-policy-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-content">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">Terms of Service</div>
                                    </div>
                                </div>
                                <button id="terms-of-service-btn" class="settings-item-action">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Deleted Sections (Teacher Only) -->
                <div id="deleted-sections-section" class="content-section hidden">
                    <div class="section-header">
                        <h1>Deleted Sections</h1>
                        <div class="header-actions">
                            <button id="refresh-deleted-sections-btn" class="icon-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="deleted-sections-list">
                        <!-- Deleted sections will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modals and Bottom Sheets -->
        
        <!-- Create Section Modal -->
        <div id="create-section-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Section</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="create-section-form">
                        <div class="form-group">
                            <label for="section-name">Section Name</label>
                            <input type="text" id="section-name" required>
                        </div>
                        <div class="form-group">
                            <label for="section-subject">Subject</label>
                            <input type="text" id="section-subject" required>
                        </div>
                        <div class="form-group">
                            <label for="section-schedule">Schedule</label>
                            <select id="section-schedule" required>
                                <option value="MWF">Monday, Wednesday, Friday</option>
                                <option value="TTH">Tuesday, Thursday</option>
                                <option value="MWFAM">MWF Morning</option>
                                <option value="MWFPM">MWF Afternoon</option>
                                <option value="TTHAM">TTH Morning</option>
                                <option value="TTHPM">TTH Afternoon</option>
                                <option value="custom">Custom Schedule</option>
                            </select>
                        </div>
                        <div id="custom-schedule-fields" class="hidden">
                            <div class="form-group">
                                <label>Days</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="day-monday" value="Monday">
                                    <label for="day-monday">Monday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="day-tuesday" value="Tuesday">
                                    <label for="day-tuesday">Tuesday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="day-wednesday" value="Wednesday">
                                    <label for="day-wednesday">Wednesday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="day-thursday" value="Thursday">
                                    <label for="day-thursday">Thursday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="day-friday" value="Friday">
                                    <label for="day-friday">Friday</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="custom-time">Time</label>
                                <input type="time" id="custom-time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="section-radius">Check-in Radius</label>
                            <select id="section-radius" required>
                                <option value="5">NearSnap (5m)</option>
                                <option value="10" selected>NearStandard (10m)</option>
                                <option value="20">NearFlex (20m)</option>
                                <option value="50">NearMax (50m)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <button type="button" id="get-location-btn" class="secondary-btn">
                                <i class="fas fa-map-marker-alt"></i> Use Current Location
                            </button>
                            <div id="location-status">
                                <i class="fas fa-info-circle"></i>
                                <span>Location not set yet</span>
                            </div>
                            <input type="hidden" id="section-latitude">
                            <input type="hidden" id="section-longitude">
                        </div>
                        <button type="submit" class="primary-btn">Create Section</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Section Details Modal -->
        <div id="section-details-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="section-details-title"></h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="section-info">
                        <div class="info-item">
                            <span class="info-label">Subject:</span>
                            <span id="section-details-subject" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Schedule:</span>
                            <span id="section-details-schedule" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location:</span>
                            <span id="section-details-location" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Radius:</span>
                            <span id="section-details-radius" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Created:</span>
                            <span id="section-details-created" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Students:</span>
                            <span id="section-details-students" class="info-value"></span>
                        </div>
                    </div>
                    
                    <div id="teacher-section-actions" class="section-actions hidden">
                        <button id="start-session-btn" class="primary-btn">
                            <i class="fas fa-play"></i> Start Session
                        </button>
                        <button id="invite-students-btn" class="secondary-btn">
                            <i class="fas fa-user-plus"></i> Invite Students
                        </button>
                        <button id="edit-section-btn" class="secondary-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button id="delete-section-btn" class="danger-btn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    
                    <div id="student-section-actions" class="section-actions hidden">
                        <button id="check-in-btn" class="primary-btn disabled">
                            <i class="fas fa-check-circle"></i> Check In
                        </button>
                        <div id="check-in-status">
                            <i class="fas fa-info-circle"></i>
                            <span>No active session</span>
                        </div>
                        <button id="leave-section-btn" class="danger-btn">
                            <i class="fas fa-sign-out-alt"></i> Leave Section
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Start Session Modal -->
        <div id="start-session-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Start Attendance Session</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="start-session-form">
                        <div class="form-group">
                            <label for="session-duration">Duration</label>
                            <select id="session-duration" required>
                                <option value="15">15 minutes</option>
                                <option value="30" selected>30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div id="custom-duration-field" class="form-group hidden">
                            <label for="custom-duration">Custom Duration (minutes)</label>
                            <input type="number" id="custom-duration" min="5" max="150" value="30">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <div id="session-location-status">
                                <i class="fas fa-info-circle"></i>
                                <span>Using section's default location</span>
                            </div>
                            <button type="button" id="update-session-location-btn" class="secondary-btn">
                                <i class="fas fa-map-marker-alt"></i> Update Location
                            </button>
                            <input type="hidden" id="session-latitude">
                            <input type="hidden" id="session-longitude">
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="enable-auto-checkin" checked>
                            <label for="enable-auto-checkin">Enable NearID+ Auto Check-In for students</label>
                        </div>
                        <button type="submit" class="primary-btn">Start Session</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Active Session Modal -->
        <div id="active-session-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Active Session</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="session-info">
                        <div class="info-item">
                            <span class="info-label">Section:</span>
                            <span id="active-session-section" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Started:</span>
                            <span id="active-session-started" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ends in:</span>
                            <span id="active-session-ends" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location:</span>
                            <span id="active-session-location" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Radius:</span>
                            <span id="active-session-radius" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Students:</span>
                            <span id="active-session-students" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Checked in:</span>
                            <span id="active-session-checked-in" class="info-value"></span>
                        </div>
                    </div>
                    
                    <div class="session-actions">
                        <button id="end-session-btn" class="primary-btn">
                            <i class="fas fa-stop"></i> End Session
                        </button>
                        <button id="view-attendance-btn" class="secondary-btn">
                            <i class="fas fa-clipboard-list"></i> View Attendance
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Invite Students Modal -->
        <div id="invite-students-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Invite Students</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="invite-methods">
                        <div class="invite-method">
                            <h3>Invite Link</h3>
                            <div class="invite-link-container">
                                <input type="text" id="invite-link" readonly>
                                <button id="copy-invite-link-btn" class="secondary-btn">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="invite-method">
                            <h3>QR Code</h3>
                            <div id="invite-qr-code" class="qr-code-container"></div>
                            <button id="download-qr-btn" class="secondary-btn">
                                <i class="fas fa-download"></i> Download QR
                            </button>
                        </div>
                        <div class="invite-method">
                            <h3>Section ID</h3>
                            <div class="section-id-container">
                                <input type="text" id="section-id-display" readonly>
                                <button id="copy-section-id-btn" class="secondary-btn">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Section Modal -->
        <div id="edit-section-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Section</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-section-form">
                        <div class="form-group">
                            <label for="edit-section-name">Section Name</label>
                            <input type="text" id="edit-section-name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-section-subject">Subject</label>
                            <input type="text" id="edit-section-subject" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-section-schedule">Schedule</label>
                            <select id="edit-section-schedule" required>
                                <option value="MWF">Monday, Wednesday, Friday</option>
                                <option value="TTH">Tuesday, Thursday</option>
                                <option value="MWFAM">MWF Morning</option>
                                <option value="MWFPM">MWF Afternoon</option>
                                <option value="TTHAM">TTH Morning</option>
                                <option value="TTHPM">TTH Afternoon</option>
                                <option value="custom">Custom Schedule</option>
                            </select>
                        </div>
                        <div id="edit-custom-schedule-fields" class="hidden">
                            <div class="form-group">
                                <label>Days</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-day-monday" value="Monday">
                                    <label for="edit-day-monday">Monday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-day-tuesday" value="Tuesday">
                                    <label for="edit-day-tuesday">Tuesday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-day-wednesday" value="Wednesday">
                                    <label for="edit-day-wednesday">Wednesday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-day-thursday" value="Thursday">
                                    <label for="edit-day-thursday">Thursday</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-day-friday" value="Friday">
                                    <label for="edit-day-friday">Friday</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="edit-custom-time">Time</label>
                                <input type="time" id="edit-custom-time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-section-radius">Check-in Radius</label>
                            <select id="edit-section-radius" required>
                                <option value="5">NearSnap (5m)</option>
                                <option value="10">NearStandard (10m)</option>
                                <option value="20">NearFlex (20m)</option>
                                <option value="50">NearMax (50m)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <div id="edit-location-status">
                                <i class="fas fa-info-circle"></i>
                                <span>Current location set</span>
                            </div>
                            <button type="button" id="edit-location-btn" class="secondary-btn">
                                <i class="fas fa-map-marker-alt"></i> Update Location
                            </button>
                            <input type="hidden" id="edit-section-latitude">
                            <input type="hidden" id="edit-section-longitude">
                        </div>
                        <button type="submit" class="primary-btn">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Delete Section Confirmation -->
        <div id="delete-section-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Delete Section</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="warning-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>This action cannot be undone. All section data, including student information and attendance records, will be permanently deleted after 30 days.</p>
                    </div>
                    <form id="delete-section-form">
                        <div class="form-group">
                            <label for="delete-section-password">Confirm your password to continue</label>
                            <input type="password" id="delete-section-password" required>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="confirm-delete-section" required>
                            <label for="confirm-delete-section">I understand this action is irreversible</label>
                        </div>
                        <div id="delete-countdown">
                            <p>Please wait <span id="delete-timer">10</span> seconds to confirm</p>
                        </div>
                        <button type="submit" id="confirm-delete-btn" class="danger-btn" disabled>
                            <i class="fas fa-trash"></i> Delete Section
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Restore Section Modal -->
        <div id="restore-section-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Restore Section</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to restore this section? All previous data will be recovered.</p>
                    <div class="modal-actions">
                        <button id="cancel-restore-btn" class="secondary-btn">Cancel</button>
                        <button id="confirm-restore-btn" class="primary-btn">Restore</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Check-In Bottom Sheet -->
        <div id="check-in-sheet" class="bottom-sheet hidden">
            <div class="sheet-header">
                <h3>Check In</h3>
                <button class="sheet-close">&times;</button>
            </div>
            <div class="sheet-body">
                <div id="check-in-status-message">
                    <i class="fas fa-info-circle"></i>
                    <span>Checking your location...</span>
                </div>
                <div id="check-in-progress" class="hidden">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="progress-text">Verifying location...</div>
                </div>
                <div id="check-in-success" class="hidden">
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i>
                        <h4>Checked In Successfully!</h4>
                        <p id="check-in-time"></p>
                    </div>
                </div>
                <div id="check-in-failure" class="hidden">
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4 id="check-in-error-title"></h4>
                        <p id="check-in-error-message"></p>
                    </div>
                </div>
            </div>
            <div class="sheet-footer">
                <button id="check-in-action-btn" class="primary-btn hidden">Try Again</button>
                <button id="check-in-close-btn" class="secondary-btn">Close</button>
            </div>
        </div>
        
        <!-- Auto Check-In Prompt -->
        <div id="auto-checkin-sheet" class="bottom-sheet hidden">
            <div class="sheet-header">
                <h3>Auto Check-In</h3>
            </div>
            <div class="sheet-body">
                <div class="info-message">
                    <i class="fas fa-info-circle"></i>
                    <p>Enable NearID+ Auto Check-In to automatically mark your attendance when you're near your teacher during active sessions.</p>
                </div>
                <div class="permission-request">
                    <p>This requires allowing NearCheck Lite to access your location in the background for up to 12 hours.</p>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="understand-auto-checkin">
                    <label for="understand-auto-checkin">I understand this feature requires background location access</label>
                </div>
            </div>
            <div class="sheet-footer">
                <button id="enable-auto-checkin-btn" class="primary-btn">Enable</button>
                <button id="decline-auto-checkin-btn" class="secondary-btn">Not Now</button>
            </div>
        </div>
        
        <!-- Location Permission Bottom Sheet -->
        <div id="location-sheet" class="bottom-sheet hidden">
            <div class="sheet-header">
                <h3>Location Permission</h3>
            </div>
            <div class="sheet-body">
                <div class="permission-description">
                    <p>NearCheck Lite requires permission to access your current device location to securely verify attendance for your assigned sections.</p>
                </div>
                <div class="permission-status">
                    <h4>Permission Status</h4>
                    <div id="location-permission-status" class="status-message">
                        <i class="fas fa-info-circle"></i>
                        <span>Checking permission status...</span>
                    </div>
                </div>
                <div id="unsupported-browser" class="hidden">
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>This browser doesn't support location access. To continue using NearCheck Lite, please switch to a browser that allows location permissions.</p>
                    </div>
                    <div id="browser-download-options" class="download-options">
                        <!-- Will be populated based on user's device -->
                    </div>
                    <div class="continue-option">
                        <p>You can continue with limited features</p>
                        <button id="continue-without-location" class="secondary-btn">Continue</button>
                    </div>
                </div>
            </div>
            <div class="sheet-footer" id="location-sheet-footer">
                <button id="enable-location-btn" class="primary-btn">Enable</button>
                <button id="location-later-btn" class="secondary-btn">Later</button>
            </div>
        </div>
        
        <!-- Profile Editor Modal -->
        <div id="profile-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Profile</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-avatar-preview">
                        <div id="profile-avatar-preview" class="avatar large"></div>
                    </div>
                    <div class="profile-edit-options">
                        <div class="edit-option">
                            <button id="edit-emoji-btn" class="secondary-btn">
                                <i class="far fa-smile"></i> Emoji
                            </button>
                        </div>
                        <div class="edit-option">
                            <button id="edit-text-btn" class="secondary-btn">
                                <i class="fas fa-font"></i> Text (1-2 chars)
                            </button>
                        </div>
                    </div>
                    <div id="emoji-picker" class="hidden">
                        <div class="emoji-categories">
                            <button data-category="smileys">😀 Smileys</button>
                            <button data-category="animals">🐻 Animals</button>
                            <button data-category="food">🍎 Food</button>
                            <button data-category="activities">⚽ Activities</button>
                            <button data-category="objects">💡 Objects</button>
                        </div>
                        <div class="emoji-grid">
                            <!-- Emojis will be populated here -->
                        </div>
                    </div>
                    <div id="text-picker" class="hidden">
                        <div class="form-group">
                            <label for="profile-text-input">Enter 1-2 characters</label>
                            <input type="text" id="profile-text-input" maxlength="2">
                        </div>
                    </div>
                    <div id="profile-change-message" class="hidden">
                        <i class="fas fa-info-circle"></i>
                        <span>You can change your profile again in <span id="change-cooldown">24 hours</span>.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-profile-btn" class="primary-btn" disabled>Save Changes</button>
                    <button id="cancel-profile-btn" class="secondary-btn">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Email Modal -->
        <div id="email-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Change Email</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="change-email-form">
                        <div class="form-group">
                            <label for="current-email">Current Email</label>
                            <input type="email" id="current-email" readonly>
                        </div>
                        <div class="form-group">
                            <label for="new-email">New Email</label>
                            <input type="email" id="new-email" required>
                        </div>
                        <div class="form-group">
                            <label for="email-password">Confirm Password</label>
                            <input type="password" id="email-password" required>
                        </div>
                        <button type="submit" class="primary-btn">Update Email</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Change Password Modal -->
        <div id="password-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Change Password</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label for="confirm-new-password">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" required minlength="8">
                        </div>
                        <button type="submit" class="primary-btn">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Student Profile Modal -->
        <div id="student-profile-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Student Profile</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-header">
                        <div id="student-avatar" class="avatar large"></div>
                        <div class="profile-info">
                            <div id="student-display-name" class="display-name"></div>
                            <div class="profile-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="student-joined-date"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="attendance-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="student-total-attendance">0</div>
                            <div class="stat-label">Total Attendance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="student-attendance-rate">0%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>
                    
                    <div id="teacher-student-actions" class="hidden">
                        <div class="form-group">
                            <label for="student-status-select">Mark Status</label>
                            <select id="student-status-select">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="excused">Excused</option>
                                <option value="late">Late</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-status-date">Date</label>
                            <input type="date" id="student-status-date">
                        </div>
                        <button id="save-student-status-btn" class="primary-btn">Save</button>
                        <button id="remove-student-btn" class="danger-btn">Remove from Section</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Teacher Profile Modal -->
        <div id="teacher-profile-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Teacher Profile</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-header">
                        <div id="teacher-avatar" class="avatar large"></div>
                        <div class="profile-info">
                            <div id="teacher-display-name" class="display-name"></div>
                            <div class="profile-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="teacher-joined-date"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="teacher-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="teacher-total-sections">0</div>
                            <div class="stat-label">Sections</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="teacher-total-students">0</div>
                            <div class="stat-label">Students</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification System -->
        <div id="notification-container"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVP8zaUj2iDrooLbRQNypHqB8QNTLhGDE",
            authDomain: "attendance-fe1c8.firebaseapp.com",
            projectId: "attendance-fe1c8",
            storageBucket: "attendance-fe1c8.appspot.com",
            messagingSenderId: "903463376704",
            appId: "1:903463376704:web:d004c563d56aa286df8ca5",
            measurementId: "G-YY5GQZPSRK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const realtimeDb = firebase.database();
        const analytics = firebase.analytics();

        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Prevent opening developer tools
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                (e.ctrlKey && e.shiftKey && e.key === 'J') || 
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });

        // App State
        let currentUser = null;
        let userRole = null;
        let userData = null;
        let userSections = [];
        let userEnrolledSections = [];
        let deletedSections = [];
        let activeSessions = [];
        let currentSection = null;
        let currentSession = null;
        let currentStudentProfile = null;
        let currentTeacherProfile = null;
        let locationWatchId = null;
        let autoCheckInEnabled = false;
        let lastProfileChange = null;
        let emojiList = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠'],
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿', '🦔'],
            food: ['🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶', '🌽', '🥕', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🥪', '🥙', '🧆', '🌮', '🌯', '🥗', '🥘', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '☕', '🍵', '🧃', '🥤', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊', '🥄', '🍴', '🍽', '🥣', '🥡', '🥢', '🧂'],
            activities: ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛷', '⛸', '🥌', '🎿', '⛷', '🏂', '🪂', '🏋️', '🤼', '🤸', '⛹️', '🤺', '🤾', '🏌️', '🏇', '🧘', '🏄', '🏊', '🤽', '🚣', '🧗', '🚵', '🚴', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖', '🏵', '🎗', '🎫', '🎟', '🎪', '🤹', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🪗', '🎸', '🪕', '🎻', '🎲', '♟', '🎯', '🎳', '🎮', '🎰', '🧩'],
            objects: ['⌚', '📱', '📲', '💻', '⌨️', '🖥', '🖨', '🖱', '🖲', '🕹', '🗜', '💽', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽', '🎞', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙', '🎚', '🎛', '🧭', '⏱', '⏲', '⏰', '🕰', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯', '🧯', '🪔', '🧨', '🎇', '🎆', '🧨', '✨', '🎈', '🎉', '🎊', '🎎', '🎏', '🎐', '🎑', '🧧', '🎀', '🎁', '🎫', '🎟', '🎪', '🛍', '🧸', '🎾', '🏸', '🎳', '🏏', '🎯', '🧩', '🧵', '🧶', '🪢', '🪡', '🧥', '🥼', '🦺', '👚', '👕', '👖', '🩲', '🩳', '👔', '👗', '👙', '👘', '🥻', '🩱', '🧦', '🧤', '🧣', '🎩', '🧢', '👒', '🎓', '⛑', '🪖', '👑', '💍', '👝', '👛', '👜', '💼', '🎒', '🧳', '👓', '🕶', '🥽', '🥼', '🌂', '🧵', '🧶']
        };

        // DOM Elements
        const elements = {
            // Auth Elements
            authContainer: document.getElementById('auth-container'),
            roleSelection: document.getElementById('role-selection'),
            teacherRoleBtn: document.getElementById('teacher-role-btn'),
            studentRoleBtn: document.getElementById('student-role-btn'),
            authSigninBtn: document.getElementById('auth-signin-btn'),
            teacherSignup: document.getElementById('teacher-signup'),
            studentSignup: document.getElementById('student-signup'),
            signin: document.getElementById('signin'),
            forgotPassword: document.getElementById('forgot-password'),
            teacherSignupForm: document.getElementById('teacher-signup-form'),
            studentSignupForm: document.getElementById('student-signup-form'),
            signinForm: document.getElementById('signin-form'),
            forgotPasswordForm: document.getElementById('forgot-password-form'),
            teacherSignupBack: document.getElementById('teacher-signup-back'),
            studentSignupBack: document.getElementById('student-signup-back'),
            signinBack: document.getElementById('signin-back'),
            forgotPasswordBtn: document.getElementById('forgot-password-btn'),
            forgotPasswordBack: document.getElementById('forgot-password-back'),
            teacherFullname: document.getElementById('teacher-fullname'),
            teacherEmail: document.getElementById('teacher-email'),
            teacherPassword: document.getElementById('teacher-password'),
            teacherConfirmPassword: document.getElementById('teacher-confirm-password'),
            teacherUsernamePreview: document.getElementById('teacher-username-preview'),
            studentFullname: document.getElementById('student-fullname'),
            studentEmail: document.getElementById('student-email'),
            studentPassword: document.getElementById('student-password'),
            studentConfirmPassword: document.getElementById('student-confirm-password'),
            studentUsernamePreview: document.getElementById('student-username-preview'),
            studentSectionId: document.getElementById('student-section-id'),
            termsLink: document.getElementById('terms-link'),
            privacyLink: document.getElementById('privacy-link'),
            
            // Main App Elements
            mainApp: document.getElementById('main-app'),
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            userAvatar: document.getElementById('user-avatar'),
            userDisplayName: document.getElementById('user-display-name'),
            userRole: document.getElementById('user-role'),
            signoutBtn: document.getElementById('signout-btn'),
            deletedSectionsMenu: document.getElementById('deleted-sections-menu'),
            
            // Dashboard Elements
            dashboardSection: document.getElementById('dashboard-section'),
            greeting: document.getElementById('greeting'),
            refreshBtn: document.getElementById('refresh-btn'),
            teacherDashboard: document.getElementById('teacher-dashboard'),
            studentDashboard: document.getElementById('student-dashboard'),
            totalSections: document.getElementById('total-sections'),
            totalStudents: document.getElementById('total-students'),
            activeSessions: document.getElementById('active-sessions'),
            teacherSectionsCarousel: document.getElementById('teacher-sections-carousel'),
            createSectionBtn: document.getElementById('create-section-btn'),
            enrolledSections: document.getElementById('enrolled-sections'),
            totalCheckins: document.getElementById('total-checkins'),
            activeCheckins: document.getElementById('active-checkins'),
            studentSectionsCarousel: document.getElementById('student-sections-carousel'),
            
            // Sections Elements
            sectionsSection: document.getElementById('sections-section'),
            searchSections: document.getElementById('search-sections'),
            refreshSectionsBtn: document.getElementById('refresh-sections-btn'),
            teacherSectionsView: document.getElementById('teacher-sections-view'),
            studentSectionsView: document.getElementById('student-sections-view'),
            sectionsList: document.getElementById('sections-list'),
            enrolledSectionsList: document.getElementById('enrolled-sections-list'),
            
            // Attendance Elements
            attendanceSection: document.getElementById('attendance-section'),
            searchAttendance: document.getElementById('search-attendance'),
            refreshAttendanceBtn: document.getElementById('refresh-attendance-btn'),
            teacherAttendanceView: document.getElementById('teacher-attendance-view'),
            studentAttendanceView: document.getElementById('student-attendance-view'),
            attendanceSectionSelect: document.getElementById('attendance-section-select'),
            attendanceDateSelect: document.getElementById('attendance-date-select'),
            downloadAttendanceBtn: document.getElementById('download-attendance-btn'),
            presentCount: document.getElementById('present-count'),
            absentCount: document.getElementById('absent-count'),
            excusedCount: document.getElementById('excused-count'),
            attendanceList: document.getElementById('attendance-list'),
            studentAttendanceSectionSelect: document.getElementById('student-attendance-section-select'),
            studentTotalCheckins: document.getElementById('student-total-checkins'),
            studentPercentage: document.getElementById('student-percentage'),
            studentAttendanceList: document.getElementById('student-attendance-list'),
            
            // Settings Elements
            settingsSection: document.getElementById('settings-section'),
            editProfileBtn: document.getElementById('edit-profile-btn'),
            editEmailBtn: document.getElementById('edit-email-btn'),
            changePasswordBtn: document.getElementById('change-password-btn'),
            locationSettingsBtn: document.getElementById('location-settings-btn'),
            notificationSettingsBtn: document.getElementById('notification-settings-btn'),
            privacyPolicyBtn: document.getElementById('privacy-policy-btn'),
            termsOfServiceBtn: document.getElementById('terms-of-service-btn'),
            
            // Deleted Sections Elements
            deletedSectionsSection: document.getElementById('deleted-sections-section'),
            refreshDeletedSectionsBtn: document.getElementById('refresh-deleted-sections-btn'),
            deletedSectionsList: document.getElementById('deleted-sections-list'),
            
            // Modals
            createSectionModal: document.getElementById('create-section-modal'),
            sectionDetailsModal: document.getElementById('section-details-modal'),
            startSessionModal: document.getElementById('start-session-modal'),
            activeSessionModal: document.getElementById('active-session-modal'),
            inviteStudentsModal: document.getElementById('invite-students-modal'),
            editSectionModal: document.getElementById('edit-section-modal'),
            deleteSectionModal: document.getElementById('delete-section-modal'),
            restoreSectionModal: document.getElementById('restore-section-modal'),
            profileModal: document.getElementById('profile-modal'),
            emailModal: document.getElementById('email-modal'),
            passwordModal: document.getElementById('password-modal'),
            studentProfileModal: document.getElementById('student-profile-modal'),
            teacherProfileModal: document.getElementById('teacher-profile-modal'),
            
            // Create Section Modal Elements
            createSectionForm: document.getElementById('create-section-form'),
            sectionName: document.getElementById('section-name'),
            sectionSubject: document.getElementById('section-subject'),
            sectionSchedule: document.getElementById('section-schedule'),
            customScheduleFields: document.getElementById('custom-schedule-fields'),
            sectionRadius: document.getElementById('section-radius'),
            getLocationBtn: document.getElementById('get-location-btn'),
            locationStatus: document.getElementById('location-status'),
            sectionLatitude: document.getElementById('section-latitude'),
            sectionLongitude: document.getElementById('section-longitude'),
            
            // Section Details Modal Elements
            sectionDetailsTitle: document.getElementById('section-details-title'),
            sectionDetailsSubject: document.getElementById('section-details-subject'),
            sectionDetailsSchedule: document.getElementById('section-details-schedule'),
            sectionDetailsLocation: document.getElementById('section-details-location'),
            sectionDetailsRadius: document.getElementById('section-details-radius'),
            sectionDetailsCreated: document.getElementById('section-details-created'),
            sectionDetailsStudents: document.getElementById('section-details-students'),
            teacherSectionActions: document.getElementById('teacher-section-actions'),
            studentSectionActions: document.getElementById('student-section-actions'),
            startSessionBtn: document.getElementById('start-session-btn'),
            inviteStudentsBtn: document.getElementById('invite-students-btn'),
            editSectionBtn: document.getElementById('edit-section-btn'),
            deleteSectionBtn: document.getElementById('delete-section-btn'),
            checkInBtn: document.getElementById('check-in-btn'),
            checkInStatus: document.getElementById('check-in-status'),
            leaveSectionBtn: document.getElementById('leave-section-btn'),
            
            // Start Session Modal Elements
            startSessionForm: document.getElementById('start-session-form'),
            sessionDuration: document.getElementById('session-duration'),
            customDurationField: document.getElementById('custom-duration-field'),
            customDuration: document.getElementById('custom-duration'),
            sessionLocationStatus: document.getElementById('session-location-status'),
            updateSessionLocationBtn: document.getElementById('update-session-location-btn'),
            sessionLatitude: document.getElementById('session-latitude'),
            sessionLongitude: document.getElementById('session-longitude'),
            enableAutoCheckin: document.getElementById('enable-auto-checkin'),
            
            // Active Session Modal Elements
            activeSessionSection: document.getElementById('active-session-section'),
            activeSessionStarted: document.getElementById('active-session-started'),
            activeSessionEnds: document.getElementById('active-session-ends'),
            activeSessionLocation: document.getElementById('active-session-location'),
            activeSessionRadius: document.getElementById('active-session-radius'),
            activeSessionStudents: document.getElementById('active-session-students'),
            activeSessionCheckedIn: document.getElementById('active-session-checked-in'),
            endSessionBtn: document.getElementById('end-session-btn'),
            viewAttendanceBtn: document.getElementById('view-attendance-btn'),
            
            // Invite Students Modal Elements
            inviteLink: document.getElementById('invite-link'),
            copyInviteLinkBtn: document.getElementById('copy-invite-link-btn'),
            inviteQrCode: document.getElementById('invite-qr-code'),
            downloadQrBtn: document.getElementById('download-qr-btn'),
            sectionIdDisplay: document.getElementById('section-id-display'),
            copySectionIdBtn: document.getElementById('copy-section-id-btn'),
            
            // Edit Section Modal Elements
            editSectionForm: document.getElementById('edit-section-form'),
            editSectionName: document.getElementById('edit-section-name'),
            editSectionSubject: document.getElementById('edit-section-subject'),
            editSectionSchedule: document.getElementById('edit-section-schedule'),
            editCustomScheduleFields: document.getElementById('edit-custom-schedule-fields'),
            editSectionRadius: document.getElementById('edit-section-radius'),
            editLocationStatus: document.getElementById('edit-location-status'),
            editLocationBtn: document.getElementById('edit-location-btn'),
            editSectionLatitude: document.getElementById('edit-section-latitude'),
            editSectionLongitude: document.getElementById('edit-section-longitude'),
            
            // Delete Section Modal Elements
            deleteSectionForm: document.getElementById('delete-section-form'),
            deleteSectionPassword: document.getElementById('delete-section-password'),
            confirmDeleteSection: document.getElementById('confirm-delete-section'),
            deleteCountdown: document.getElementById('delete-countdown'),
            deleteTimer: document.getElementById('delete-timer'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            
            // Restore Section Modal Elements
            cancelRestoreBtn: document.getElementById('cancel-restore-btn'),
            confirmRestoreBtn: document.getElementById('confirm-restore-btn'),
            
            // Check-In Bottom Sheet Elements
            checkInSheet: document.getElementById('check-in-sheet'),
            checkInStatusMessage: document.getElementById('check-in-status-message'),
            checkInProgress: document.getElementById('check-in-progress'),
            checkInSuccess: document.getElementById('check-in-success'),
            checkInFailure: document.getElementById('check-in-failure'),
            checkInTime: document.getElementById('check-in-time'),
            checkInErrorTitle: document.getElementById('check-in-error-title'),
            checkInErrorMessage: document.getElementById('check-in-error-message'),
            checkInActionBtn: document.getElementById('check-in-action-btn'),
            checkInCloseBtn: document.getElementById('check-in-close-btn'),
            
            // Auto Check-In Bottom Sheet Elements
            autoCheckinSheet: document.getElementById('auto-checkin-sheet'),
            understandAutoCheckin: document.getElementById('understand-auto-checkin'),
            enableAutoCheckinBtn: document.getElementById('enable-auto-checkin-btn'),
            declineAutoCheckinBtn: document.getElementById('decline-auto-checkin-btn'),
            
            // Location Permission Bottom Sheet Elements
            locationSheet: document.getElementById('location-sheet'),
            locationPermissionStatus: document.getElementById('location-permission-status'),
            unsupportedBrowser: document.getElementById('unsupported-browser'),
            browserDownloadOptions: document.getElementById('browser-download-options'),
            continueWithoutLocation: document.getElementById('continue-without-location'),
            locationSheetFooter: document.getElementById('location-sheet-footer'),
            enableLocationBtn: document.getElementById('enable-location-btn'),
            locationLaterBtn: document.getElementById('location-later-btn'),
            
            // Profile Modal Elements
            profileAvatarPreview: document.getElementById('profile-avatar-preview'),
            editEmojiBtn: document.getElementById('edit-emoji-btn'),
            editTextBtn: document.getElementById('edit-text-btn'),
            emojiPicker: document.getElementById('emoji-picker'),
            textPicker: document.getElementById('text-picker'),
            profileTextInput: document.getElementById('profile-text-input'),
            profileChangeMessage: document.getElementById('profile-change-message'),
            changeCooldown: document.getElementById('change-cooldown'),
            saveProfileBtn: document.getElementById('save-profile-btn'),
            cancelProfileBtn: document.getElementById('cancel-profile-btn'),
            
            // Email Modal Elements
            changeEmailForm: document.getElementById('change-email-form'),
            currentEmail: document.getElementById('current-email'),
            newEmail: document.getElementById('new-email'),
            emailPassword: document.getElementById('email-password'),
            
            // Password Modal Elements
            changePasswordForm: document.getElementById('change-password-form'),
            currentPassword: document.getElementById('current-password'),
            newPassword: document.getElementById('new-password'),
            confirmNewPassword: document.getElementById('confirm-new-password'),
            
            // Student Profile Modal Elements
            studentAvatar: document.getElementById('student-avatar'),
            studentDisplayName: document.getElementById('student-display-name'),
            studentJoinedDate: document.getElementById('student-joined-date'),
            studentTotalAttendance: document.getElementById('student-total-attendance'),
            studentAttendanceRate: document.getElementById('student-attendance-rate'),
            teacherStudentActions: document.getElementById('teacher-student-actions'),
            studentStatusSelect: document.getElementById('student-status-select'),
            studentStatusDate: document.getElementById('student-status-date'),
            saveStudentStatusBtn: document.getElementById('save-student-status-btn'),
            removeStudentBtn: document.getElementById('remove-student-btn'),
            
            // Teacher Profile Modal Elements
            teacherAvatar: document.getElementById('teacher-avatar'),
            teacherDisplayName: document.getElementById('teacher-display-name'),
            teacherJoinedDate: document.getElementById('teacher-joined-date'),
            teacherTotalSections: document.getElementById('teacher-total-sections'),
            teacherTotalStudents: document.getElementById('teacher-total-students'),
            
            // Notification Container
            notificationContainer: document.getElementById('notification-container')
        };

        // Initialize the app
        function initApp() {
            // Set up event listeners
            setupEventListeners();
            
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserData();
                } else {
                    // User is signed out
                    showAuthScreen();
                }
            });
            
            // Initialize emoji picker
            initEmojiPicker();
            
            // Set current date for attendance
            elements.attendanceDateSelect.valueAsDate = new Date();
            elements.studentStatusDate.valueAsDate = new Date();
            
            // Check for invitation link
            checkForInvitationLink();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth screen events
            elements.teacherRoleBtn.addEventListener('click', () => showTeacherSignup());
            elements.studentRoleBtn.addEventListener('click', () => showStudentSignup());
            elements.authSigninBtn.addEventListener('click', () => showSignin());
            elements.teacherSignupBack.addEventListener('click', () => showRoleSelection());
            elements.studentSignupBack.addEventListener('click', () => showRoleSelection());
            elements.signinBack.addEventListener('click', () => showRoleSelection());
            elements.forgotPasswordBtn.addEventListener('click', () => showForgotPassword());
            elements.forgotPasswordBack.addEventListener('click', () => showSignin());
            
            // Teacher signup form
            elements.teacherSignupForm.addEventListener('submit', handleTeacherSignup);
            elements.teacherFullname.addEventListener('input', updateTeacherUsernamePreview);
            elements.teacherEmail.addEventListener('input', updateTeacherUsernamePreview);
            
            // Student signup form
            elements.studentSignupForm.addEventListener('submit', handleStudentSignup);
            elements.studentFullname.addEventListener('input', updateStudentUsernamePreview);
            elements.studentEmail.addEventListener('input', updateStudentUsernamePreview);
            
            // Signin form
            elements.signinForm.addEventListener('submit', handleSignin);
            
            // Forgot password form
            elements.forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            
            // Main app events
            elements.signoutBtn.addEventListener('click', handleSignout);
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    navigateTo(section);
                });
            });
            
            // Refresh buttons
            elements.refreshBtn.addEventListener('click', refreshDashboard);
            elements.refreshSectionsBtn.addEventListener('click', refreshSections);
            elements.refreshAttendanceBtn.addEventListener('click', refreshAttendance);
            elements.refreshDeletedSectionsBtn.addEventListener('click', refreshDeletedSections);
            
            // Dashboard actions
            elements.createSectionBtn.addEventListener('click', () => showModal(elements.createSectionModal));
            
            // Create section modal
            elements.createSectionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.createSectionModal));
            elements.createSectionForm.addEventListener('submit', handleCreateSection);
            elements.sectionSchedule.addEventListener('change', toggleCustomScheduleFields);
            elements.getLocationBtn.addEventListener('click', getCurrentLocationForSection);
            
            // Section details modal
            elements.sectionDetailsModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.sectionDetailsModal));
            elements.startSessionBtn.addEventListener('click', () => showModal(elements.startSessionModal));
            elements.inviteStudentsBtn.addEventListener('click', () => showModal(elements.inviteStudentsModal));
            elements.editSectionBtn.addEventListener('click', () => showEditSectionModal());
            elements.deleteSectionBtn.addEventListener('click', () => showModal(elements.deleteSectionModal));
            elements.checkInBtn.addEventListener('click', () => showCheckInSheet());
            elements.leaveSectionBtn.addEventListener('click', confirmLeaveSection);
            
            // Start session modal
            elements.startSessionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.startSessionModal));
            elements.startSessionForm.addEventListener('submit', handleStartSession);
            elements.sessionDuration.addEventListener('change', toggleCustomDurationField);
            elements.updateSessionLocationBtn.addEventListener('click', getCurrentLocationForSession);
            
            // Active session modal
            elements.activeSessionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.activeSessionModal));
            elements.endSessionBtn.addEventListener('click', endCurrentSession);
            elements.viewAttendanceBtn.addEventListener('click', viewSessionAttendance);
            
            // Invite students modal
            elements.inviteStudentsModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.inviteStudentsModal));
            elements.copyInviteLinkBtn.addEventListener('click', copyInviteLink);
            elements.downloadQrBtn.addEventListener('click', downloadQrCode);
            elements.copySectionIdBtn.addEventListener('click', copySectionId);
            
            // Edit section modal
            elements.editSectionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.editSectionModal));
            elements.editSectionForm.addEventListener('submit', handleEditSection);
            elements.editSectionSchedule.addEventListener('change', toggleEditCustomScheduleFields);
            elements.editLocationBtn.addEventListener('click', getCurrentLocationForEditSection);
            
            // Delete section modal
            elements.deleteSectionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.deleteSectionModal));
            elements.deleteSectionForm.addEventListener('submit', handleDeleteSection);
            elements.confirmDeleteSection.addEventListener('change', toggleDeleteButton);
            
            // Restore section modal
            elements.restoreSectionModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.restoreSectionModal));
            elements.cancelRestoreBtn.addEventListener('click', () => hideModal(elements.restoreSectionModal));
            elements.confirmRestoreBtn.addEventListener('click', restoreSelectedSection);
            
            // Check-in bottom sheet
            elements.checkInSheet.querySelector('.sheet-close').addEventListener('click', () => hideBottomSheet(elements.checkInSheet));
            elements.checkInActionBtn.addEventListener('click', handleCheckIn);
            elements.checkInCloseBtn.addEventListener('click', () => hideBottomSheet(elements.checkInSheet));
            
            // Auto check-in bottom sheet
            elements.enableAutoCheckinBtn.addEventListener('click', enableAutoCheckIn);
            elements.declineAutoCheckinBtn.addEventListener('click', () => hideBottomSheet(elements.autoCheckinSheet));
            
            // Location permission bottom sheet
            elements.enableLocationBtn.addEventListener('click', requestLocationPermission);
            elements.locationLaterBtn.addEventListener('click', () => hideBottomSheet(elements.locationSheet));
            elements.continueWithoutLocation.addEventListener('click', () => hideBottomSheet(elements.locationSheet));
            
            // Profile modal
            elements.profileModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.profileModal));
            elements.editEmojiBtn.addEventListener('click', () => showEmojiPicker());
            elements.editTextBtn.addEventListener('click', () => showTextPicker());
            elements.profileTextInput.addEventListener('input', validateProfileText);
            elements.saveProfileBtn.addEventListener('click', saveProfileChanges);
            elements.cancelProfileBtn.addEventListener('click', () => hideModal(elements.profileModal));
            
            // Email modal
            elements.emailModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.emailModal));
            elements.changeEmailForm.addEventListener('submit', handleChangeEmail);
            
            // Password modal
            elements.passwordModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.passwordModal));
            elements.changePasswordForm.addEventListener('submit', handleChangePassword);
            
            // Settings buttons
            elements.editProfileBtn.addEventListener('click', () => showModal(elements.profileModal));
            elements.editEmailBtn.addEventListener('click', () => showModal(elements.emailModal));
            elements.changePasswordBtn.addEventListener('click', () => showModal(elements.passwordModal));
            elements.locationSettingsBtn.addEventListener('click', showLocationSettings);
            elements.notificationSettingsBtn.addEventListener('click', showNotificationSettings);
            elements.privacyPolicyBtn.addEventListener('click', showPrivacyPolicy);
            elements.termsOfServiceBtn.addEventListener('click', showTermsOfService);
            
            // Search functionality
            elements.searchSections.addEventListener('input', filterSections);
            elements.searchAttendance.addEventListener('input', filterAttendance);
            
            // Download attendance
            elements.downloadAttendanceBtn.addEventListener('click', downloadAttendance);
            
            // Student profile modal
            elements.studentProfileModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.studentProfileModal));
            elements.saveStudentStatusBtn.addEventListener('click', saveStudentStatus);
            elements.removeStudentBtn.addEventListener('click', confirmRemoveStudent);
            
            // Teacher profile modal
            elements.teacherProfileModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.teacherProfileModal));
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modal);
                    }
                });
            });
            
            // Close bottom sheets when clicking outside
            document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                sheet.addEventListener('click', (e) => {
                    if (e.target === sheet) {
                        hideBottomSheet(sheet);
                    }
                });
            });
            
            // Prevent form submission on Enter key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                }
            });
        }

        // Auth screen functions
        function showAuthScreen() {
            elements.mainApp.classList.add('hidden');
            elements.authContainer.classList.remove('hidden');
            showRoleSelection();
        }

        function showRoleSelection() {
            hideAllAuthSections();
            elements.roleSelection.classList.remove('hidden');
        }

        function showTeacherSignup() {
            hideAllAuthSections();
            elements.teacherSignup.classList.remove('hidden');
            elements.teacherFullname.focus();
        }

        function showStudentSignup() {
            hideAllAuthSections();
            elements.studentSignup.classList.remove('hidden');
            elements.studentFullname.focus();
        }

        function showSignin() {
            hideAllAuthSections();
            elements.signin.classList.remove('hidden');
            elements.signinForm.querySelector('input').focus();
        }

        function showForgotPassword() {
            hideAllAuthSections();
            elements.forgotPassword.classList.remove('hidden');
            elements.resetEmail.focus();
        }

        function hideAllAuthSections() {
            document.querySelectorAll('.auth-section').forEach(section => {
                section.classList.add('hidden');
            });
        }

        // Username generation
        function updateTeacherUsernamePreview() {
            const fullname = elements.teacherFullname.value.trim();
            const email = elements.teacherEmail.value.trim();
            
            if (fullname && email) {
                const username = generateUsername(fullname, email, 'teacher');
                elements.teacherUsernamePreview.textContent = username;
            } else {
                elements.teacherUsernamePreview.textContent = '';
            }
        }

        function updateStudentUsernamePreview() {
            const fullname = elements.studentFullname.value.trim();
            const email = elements.studentEmail.value.trim();
            
            if (fullname && email) {
                const username = generateUsername(fullname, email, 'student');
                elements.studentUsernamePreview.textContent = username;
            } else {
                elements.studentUsernamePreview.textContent = '';
            }
        }

        function generateUsername(fullname, email, role) {
            // Simple username generation - in a real app, this would be more robust
            const namePart = fullname.split(' ')[0].toLowerCase();
            const emailPart = email.split('@')[0];
            const randomId = Math.random().toString(36).substring(2, 6);
            
            if (role === 'teacher') {
                return `${namePart}@nearcheck/teacher-${randomId}`;
            } else {
                return `${namePart}@nearcheck/student-${randomId}`;
            }
        }

        // Form handlers
        async function handleTeacherSignup(e) {
            e.preventDefault();
            
            const fullname = elements.teacherFullname.value.trim();
            const email = elements.teacherEmail.value.trim();
            const password = elements.teacherPassword.value;
            const confirmPassword = elements.teacherConfirmPassword.value;
            const ageConfirm = elements.teacherAgeConfirm.checked;
            const termsConfirm = elements.teacherTerms.checked;
            
            // Validate form
            if (!fullname || !email || !password || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            if (!ageConfirm) {
                showNotification('You must confirm you are 20 years or older', 'error');
                return;
            }
            
            if (!termsConfirm) {
                showNotification('You must agree to the terms and privacy policy', 'error');
                return;
            }
            
            try {
                // Create user with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate username
                const username = generateUsername(fullname, email, 'teacher');
                
                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    fullname: fullname,
                    email: email,
                    username: username,
                    role: 'teacher',
                    displayName: fullname.split(' ')[0],
                    avatarColor: generateRandomColor(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Send email verification
                await user.sendEmailVerification();
                
                showNotification('Account created successfully! Please check your email for verification.', 'success');
                
                // Sign in the user
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleStudentSignup(e) {
            e.preventDefault();
            
            const fullname = elements.studentFullname.value.trim();
            const email = elements.studentEmail.value.trim();
            const password = elements.studentPassword.value;
            const confirmPassword = elements.studentConfirmPassword.value;
            const sectionId = elements.studentSectionId.value.trim();
            const ageConfirm = elements.studentAgeConfirm.checked;
            const termsConfirm = elements.studentTerms.checked;
            
            // Validate form
            if (!fullname || !email || !password || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            if (!ageConfirm) {
                showNotification('You must confirm you are 13 years or older', 'error');
                return;
            }
            
            if (!termsConfirm) {
                showNotification('You must agree to the terms and privacy policy', 'error');
                return;
            }
            
            try {
                // Create user with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate username
                let username = generateUsername(fullname, email, 'student');
                
                // Create user document in Firestore
                const userData = {
                    uid: user.uid,
                    fullname: fullname,
                    email: email,
                    username: username,
                    role: 'student',
                    displayName: fullname.split(' ')[0],
                    avatarColor: generateRandomColor(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // If section ID was provided during signup, add it to the user data
                if (sectionId) {
                    userData.sectionId = sectionId;
                }
                
                await db.collection('users').doc(user.uid).set(userData);
                
                // Send email verification
                await user.sendEmailVerification();
                
                showNotification('Account created successfully! Please check your email for verification.', 'success');
                
                // Sign in the user
                await auth.signInWithEmailAndPassword(email, password);
                
                // If section ID was provided, join the section
                if (sectionId) {
                    joinSection(sectionId);
                }
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleSignin(e) {
            e.preventDefault();
            
            const identifier = elements.signinIdentifier.value.trim();
            const password = elements.signinPassword.value;
            
            if (!identifier || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                // Check if identifier is email or username
                let email = identifier;
                
                // If identifier contains @ but not @nearcheck, assume it's an email
                if (!identifier.includes('@nearcheck') && identifier.includes('@')) {
                    email = identifier;
                } else {
                    // Look up email by username
                    const usersQuery = await db.collection('users').where('username', '==', identifier).limit(1).get();
                    
                    if (usersQuery.empty) {
                        showNotification('Invalid username or password', 'error');
                        return;
                    }
                    
                    email = usersQuery.docs[0].data().email;
                }
                
                // Sign in with email and password
                await auth.signInWithEmailAndPassword(email, password);
                
                // Update last login time
                await db.collection('users').doc(currentUser.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            
            const email = elements.resetEmail.value.trim();
            
            if (!email) {
                showNotification('Please enter your email', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showNotification('Password reset email sent. Please check your inbox.', 'success');
                showSignin();
            } catch (error) {
                handleAuthError(error);
            }
        }

        function handleAuthError(error) {
            console.error('Auth error:', error);
            
            let message = 'An error occurred. Please try again.';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    message = 'Email is already in use by another account.';
                    break;
                case 'auth/invalid-email':
                    message = 'Please enter a valid email address.';
                    break;
                case 'auth/weak-password':
                    message = 'Password should be at least 8 characters.';
                    break;
                case 'auth/user-not-found':
                    message = 'No account found with this email.';
                    break;
                case 'auth/wrong-password':
                    message = 'Invalid password. Please try again.';
                    break;
                case 'auth/too-many-requests':
                    message = 'Too many attempts. Please try again later.';
                    break;
                case 'auth/network-request-failed':
                    message = 'Network error. Please check your connection.';
                    break;
            }
            
            showNotification(message, 'error');
        }

        async function handleSignout() {
            try {
                // Stop any active location tracking
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                await auth.signOut();
                showNotification('Signed out successfully', 'success');
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Error signing out. Please try again.', 'error');
            }
        }

        // User data functions
        async function loadUserData() {
            try {
                // Get user document from Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    showNotification('User data not found', 'error');
                    await auth.signOut();
                    return;
                }
                
                userData = userDoc.data();
                userRole = userData.role;
                
                // Update UI based on user role
                updateUserInterface();
                
                // Load user sections
                await loadUserSections();
                
                // Load deleted sections if teacher
                if (userRole === 'teacher') {
                    await loadDeletedSections();
                }
                
                // Show main app
                showMainApp();
                
                // Check for pending section invitation
                checkPendingSectionInvitation();
                
                // Check for active sessions
                checkActiveSessions();
                
                // Show greeting based on time
                updateGreeting();
                
                // Show location permission if not granted
                checkLocationPermission();
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data. Please try again.', 'error');
            }
        }

        function updateUserInterface() {
            // Update avatar and display name
            elements.userAvatar.textContent = userData.displayName.length <= 2 ? userData.displayName : userData.displayName.charAt(0);
            elements.userAvatar.style.backgroundColor = userData.avatarColor;
            elements.userDisplayName.textContent = userData.displayName;
            elements.userRole.textContent = userRole === 'teacher' ? 'Teacher' : 'Student';
            
            // Show/hide teacher or student views
            if (userRole === 'teacher') {
                elements.teacherDashboard.classList.remove('hidden');
                elements.studentDashboard.classList.add('hidden');
                elements.teacherSectionsView.classList.remove('hidden');
                elements.studentSectionsView.classList.add('hidden');
                elements.teacherAttendanceView.classList.remove('hidden');
                elements.studentAttendanceView.classList.add('hidden');
                elements.deletedSectionsMenu.classList.remove('hidden');
            } else {
                elements.teacherDashboard.classList.add('hidden');
                elements.studentDashboard.classList.remove('hidden');
                elements.teacherSectionsView.classList.add('hidden');
                elements.studentSectionsView.classList.remove('hidden');
                elements.teacherAttendanceView.classList.add('hidden');
                elements.studentAttendanceView.classList.remove('hidden');
                elements.deletedSectionsMenu.classList.add('hidden');
            }
        }

        function showMainApp() {
            elements.authContainer.classList.add('hidden');
            elements.mainApp.classList.remove('hidden');
            
            // Default to dashboard view
            navigateTo('dashboard');
        }

        // Navigation
        function navigateTo(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(`${section}-section`);
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
                
                // Add active class to menu item
                const menuItem = document.querySelector(`.sidebar-menu li[data-section="${section}"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
                
                // Load section data if needed
                switch (section) {
                    case 'dashboard':
                        refreshDashboard();
                        break;
                    case 'sections':
                        refreshSections();
                        break;
                    case 'attendance':
                        refreshAttendance();
                        break;
                    case 'deleted-sections':
                        refreshDeletedSections();
                        break;
                }
            }
        }

        // Dashboard functions
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour < 12) {
                greeting = 'Good morning';
            } else if (hour < 18) {
                greeting = 'Good afternoon';
            } else {
                greeting = 'Good evening';
            }
            
            if (userData && userData.displayName) {
                greeting += `, ${userData.displayName}`;
            }
            
            elements.greeting.textContent = greeting;
        }

        async function refreshDashboard() {
            if (userRole === 'teacher') {
                await loadTeacherDashboard();
            } else {
                await loadStudentDashboard();
            }
        }

        async function loadTeacherDashboard() {
            try {
                // Count sections
                elements.totalSections.textContent = userSections.length;
                
                // Count students across all sections
                let totalStudents = 0;
                for (const section of userSections) {
                    const studentsQuery = await db.collection('sections').doc(section.id).collection('students').get();
                    totalStudents += studentsQuery.size;
                }
                elements.totalStudents.textContent = totalStudents;
                
                // Count active sessions
                const activeSessionsQuery = await db.collection('sessions').where('teacherId', '==', currentUser.uid).where('ended', '==', false).get();
                elements.activeSessions.textContent = activeSessionsQuery.size;
                
                // Load sections carousel
                loadTeacherSectionsCarousel();
            } catch (error) {
                console.error('Error loading teacher dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }

        async function loadStudentDashboard() {
            try {
                // Count enrolled sections
                elements.enrolledSections.textContent = userEnrolledSections.length;
                
                // Count total check-ins
                let totalCheckins = 0;
                let activeCheckins = 0;
                
                for (const section of userEnrolledSections) {
                    const attendanceQuery = await db.collection('sections').doc(section.id).collection('attendance')
                        .where('studentId', '==', currentUser.uid).get();
                    
                    totalCheckins += attendanceQuery.size;
                    
                    // Check for active sessions in this section
                    const activeSessionQuery = await db.collection('sessions').where('sectionId', '==', section.id)
                        .where('ended', '==', false).limit(1).get();
                    
                    if (!activeSessionQuery.empty) {
                        activeCheckins++;
                    }
                }
                
                elements.totalCheckins.textContent = totalCheckins;
                elements.activeCheckins.textContent = activeCheckins;
                
                // Load sections carousel
                loadStudentSectionsCarousel();
            } catch (error) {
                console.error('Error loading student dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }

        function loadTeacherSectionsCarousel() {
            const carouselInner = elements.teacherSectionsCarousel.querySelector('.carousel-inner');
            carouselInner.innerHTML = '';
            
            if (userSections.length === 0) {
                carouselInner.innerHTML = '<div class="empty-state">You haven\'t created any sections yet.</div>';
                return;
            }
            
            userSections.forEach(section => {
                const sectionCard = createSectionCard(section);
                carouselInner.appendChild(sectionCard);
            });
        }

        function loadStudentSectionsCarousel() {
            const carouselInner = elements.studentSectionsCarousel.querySelector('.carousel-inner');
            carouselInner.innerHTML = '';
            
            if (userEnrolledSections.length === 0) {
                carouselInner.innerHTML = '<div class="empty-state">You haven\'t joined any sections yet.</div>';
                return;
            }
            
            userEnrolledSections.forEach(section => {
                const sectionCard = createSectionCard(section);
                carouselInner.appendChild(sectionCard);
            });
        }

        function createSectionCard(section) {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.setAttribute('data-section-id', section.id);
            
            const name = document.createElement('h3');
            name.textContent = section.name;
            
            const subject = document.createElement('p');
            subject.className = 'subject';
            subject.textContent = section.subject;
            
            const schedule = document.createElement('p');
            schedule.className = 'schedule';
            schedule.textContent = formatSchedule(section.schedule);
            
            card.appendChild(name);
            card.appendChild(subject);
            card.appendChild(schedule);
            
            card.addEventListener('click', () => {
                currentSection = section;
                showSectionDetails();
            });
            
            return card;
        }

        function formatSchedule(schedule) {
            if (schedule === 'MWF') return 'Mon, Wed, Fri';
            if (schedule === 'TTH') return 'Tue, Thu';
            if (schedule === 'MWFAM') return 'Mon, Wed, Fri (Morning)';
            if (schedule === 'MWFPM') return 'Mon, Wed, Fri (Afternoon)';
            if (schedule === 'TTHAM') return 'Tue, Thu (Morning)';
            if (schedule === 'TTHPM') return 'Tue, Thu (Afternoon)';
            if (typeof schedule === 'object' && schedule.days && schedule.time) {
                return `${schedule.days.join(', ')} at ${schedule.time}`;
            }
            return schedule;
        }

        // Section functions
        async function loadUserSections() {
            try {
                if (userRole === 'teacher') {
                    // Load sections created by teacher
                    const sectionsQuery = await db.collection('sections').where('teacherId', '==', currentUser.uid)
                        .where('deleted', '==', false).orderBy('createdAt', 'desc').get();
                    
                    userSections = sectionsQuery.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } else {
                    // Load sections student is enrolled in
                    const enrollmentsQuery = await db.collection('enrollments').where('studentId', '==', currentUser.uid).get();
                    
                    userEnrolledSections = [];
                    
                    for (const enrollment of enrollmentsQuery.docs) {
                        const sectionDoc = await db.collection('sections').doc(enrollment.data().sectionId).get();
                        
                        if (sectionDoc.exists && !sectionDoc.data().deleted) {
                            userEnrolledSections.push({
                                id: sectionDoc.id,
                                ...sectionDoc.data()
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user sections:', error);
                showNotification('Error loading sections', 'error');
            }
        }

        async function refreshSections() {
            await loadUserSections();
            
            if (userRole === 'teacher') {
                loadTeacherSectionsList();
            } else {
                loadStudentSectionsList();
            }
        }

        function loadTeacherSectionsList() {
            elements.sectionsList.innerHTML = '';
            
            if (userSections.length === 0) {
                elements.sectionsList.innerHTML = '<div class="empty-state">You haven\'t created any sections yet.</div>';
                return;
            }
            
            userSections.forEach(section => {
                const sectionItem = createSectionListItem(section);
                elements.sectionsList.appendChild(sectionItem);
            });
        }

        function loadStudentSectionsList() {
            elements.enrolledSectionsList.innerHTML = '';
            
            if (userEnrolledSections.length === 0) {
                elements.enrolledSectionsList.innerHTML = '<div class="empty-state">You haven\'t joined any sections yet.</div>';
                return;
            }
            
            userEnrolledSections.forEach(section => {
                const sectionItem = createSectionListItem(section);
                elements.enrolledSectionsList.appendChild(sectionItem);
            });
        }

        function createSectionListItem(section) {
            const item = document.createElement('div');
            item.className = 'section-list-item';
            item.setAttribute('data-section-id', section.id);
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = section.name.charAt(0);
            avatar.style.backgroundColor = stringToColor(section.name);
            
            const info = document.createElement('div');
            info.className = 'info';
            
            const name = document.createElement('h3');
            name.textContent = section.name;
            
            const meta = document.createElement('div');
            meta.className = 'meta';
            
            const subject = document.createElement('span');
            subject.className = 'subject';
            subject.textContent = section.subject;
            
            const schedule = document.createElement('span');
            schedule.className = 'schedule';
            schedule.textContent = formatSchedule(section.schedule);
            
            meta.appendChild(subject);
            meta.appendChild(schedule);
            
            info.appendChild(name);
            info.appendChild(meta);
            
            item.appendChild(avatar);
            item.appendChild(info);
            
            item.addEventListener('click', () => {
                currentSection = section;
                showSectionDetails();
            });
            
            return item;
        }

        function filterSections() {
            const searchTerm = elements.searchSections.value.toLowerCase();
            
            if (userRole === 'teacher') {
                const items = elements.sectionsList.querySelectorAll('.section-list-item');
                
                items.forEach(item => {
                    const name = item.querySelector('h3').textContent.toLowerCase();
                    const subject = item.querySelector('.subject').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || subject.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                const items = elements.enrolledSectionsList.querySelectorAll('.section-list-item');
                
                items.forEach(item => {
                    const name = item.querySelector('h3').textContent.toLowerCase();
                    const subject = item.querySelector('.subject').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || subject.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        }

        function showSectionDetails() {
            if (!currentSection) return;
            
            // Update modal title
            elements.sectionDetailsTitle.textContent = currentSection.name;
            
            // Update section info
            elements.sectionDetailsSubject.textContent = currentSection.subject;
            elements.sectionDetailsSchedule.textContent = formatSchedule(currentSection.schedule);
            elements.sectionDetailsLocation.textContent = currentSection.location ? currentSection.location.name : 'Location not set';
            elements.sectionDetailsRadius.textContent = `${currentSection.radius}m (${getRadiusName(currentSection.radius)})`;
            elements.sectionDetailsCreated.textContent = formatDate(currentSection.createdAt.toDate());
            
            // Show appropriate actions based on user role
            if (userRole === 'teacher') {
                elements.teacherSectionActions.classList.remove('hidden');
                elements.studentSectionActions.classList.add('hidden');
                
                // Load student count
                loadSectionStudentCount();
            } else {
                elements.teacherSectionActions.classList.add('hidden');
                elements.studentSectionActions.classList.remove('hidden');
                
                // Check if there's an active session for this section
                checkActiveSessionForStudent();
            }
            
            showModal(elements.sectionDetailsModal);
        }

        async function loadSectionStudentCount() {
            try {
                const studentsQuery = await db.collection('sections').doc(currentSection.id).collection('students').get();
                elements.sectionDetailsStudents.textContent = `${studentsQuery.size} students`;
            } catch (error) {
                console.error('Error loading student count:', error);
                elements.sectionDetailsStudents.textContent = 'Error loading student count';
            }
        }

        async function checkActiveSessionForStudent() {
            try {
                // Check if there's an active session for this section
                const sessionQuery = await db.collection('sessions').where('sectionId', '==', currentSection.id)
                    .where('ended', '==', false).limit(1).get();
                
                if (!sessionQuery.empty) {
                    const session = sessionQuery.docs[0].data();
                    currentSession = {
                        id: sessionQuery.docs[0].id,
                        ...session
                    };
                    
                    elements.checkInBtn.classList.remove('disabled');
                    elements.checkInStatus.innerHTML = '<i class="fas fa-check-circle"></i> Active session in progress';
                    
                    // Check if auto check-in is enabled
                    checkAutoCheckInStatus();
                } else {
                    currentSession = null;
                    elements.checkInBtn.classList.add('disabled');
                    elements.checkInStatus.innerHTML = '<i class="fas fa-info-circle"></i> No active session';
                }
            } catch (error) {
                console.error('Error checking active session:', error);
                elements.checkInStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error checking session status';
            }
        }

        function getRadiusName(radius) {
            switch (radius) {
                case 5: return 'NearSnap';
                case 10: return 'NearStandard';
                case 20: return 'NearFlex';
                case 50: return 'NearMax';
                default: return 'Custom';
            }
        }

        // Create section functions
        function toggleCustomScheduleFields() {
            if (elements.sectionSchedule.value === 'custom') {
                elements.customScheduleFields.classList.remove('hidden');
            } else {
                elements.customScheduleFields.classList.add('hidden');
            }
        }

        function getCurrentLocationForSection() {
            elements.locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Save coordinates
                        elements.sectionLatitude.value = latitude;
                        elements.sectionLongitude.value = longitude;
                        
                        // Reverse geocode to get location name
                        reverseGeocode(latitude, longitude).then(locationName => {
                            elements.locationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location set: ${locationName}`;
                        }).catch(error => {
                            console.error('Geocoding error:', error);
                            elements.locationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location set (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
                        });
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        elements.locationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error getting location';
                        showLocationSettings();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                elements.locationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Geolocation not supported';
                showLocationSettings();
            }
        }

        async function reverseGeocode(latitude, longitude) {
            // In a real app, you would use a geocoding service like Google Maps or Mapbox
            // For this example, we'll just return the coordinates
            return `(${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
        }

        async function handleCreateSection(e) {
            e.preventDefault();
            
            const name = elements.sectionName.value.trim();
            const subject = elements.sectionSubject.value.trim();
            const scheduleType = elements.sectionSchedule.value;
            const radius = parseInt(elements.sectionRadius.value);
            const latitude = parseFloat(elements.sectionLatitude.value);
            const longitude = parseFloat(elements.sectionLongitude.value);
            
            if (!name || !subject) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (isNaN(latitude) || isNaN(longitude)) {
                showNotification('Please set a location for the section', 'error');
                return;
            }
            
            let schedule;
            
            if (scheduleType === 'custom') {
                const days = [];
                if (elements.dayMonday.checked) days.push('Monday');
                if (elements.dayTuesday.checked) days.push('Tuesday');
                if (elements.dayWednesday.checked) days.push('Wednesday');
                if (elements.dayThursday.checked) days.push('Thursday');
                if (elements.dayFriday.checked) days.push('Friday');
                
                const time = elements.customTime.value;
                
                if (days.length === 0 || !time) {
                    showNotification('Please select at least one day and time for custom schedule', 'error');
                    return;
                }
                
                schedule = {
                    days: days,
                    time: time
                };
            } else {
                schedule = scheduleType;
            }
            
            try {
                // Create section document
                const sectionRef = await db.collection('sections').add({
                    name: name,
                    subject: subject,
                    schedule: schedule,
                    radius: radius,
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        name: await reverseGeocode(latitude, longitude)
                    },
                    teacherId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deleted: false
                });
                
                showNotification('Section created successfully', 'success');
                
                // Add teacher as a student in their own section (for attendance purposes)
                await db.collection('sections').doc(sectionRef.id).collection('students').doc(currentUser.uid).set({
                    studentId: currentUser.uid,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create enrollment record
                await db.collection('enrollments').add({
                    sectionId: sectionRef.id,
                    studentId: currentUser.uid,
                    enrolledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Refresh sections list
                await refreshSections();
                
                // Hide modal
                hideModal(elements.createSectionModal);
                
                // Show the new section
                currentSection = {
                    id: sectionRef.id,
                    name: name,
                    subject: subject,
                    schedule: schedule,
                    radius: radius,
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        name: await reverseGeocode(latitude, longitude)
                    },
                    teacherId: currentUser.uid,
                    createdAt: new Date()
                };
                
                showSectionDetails();
            } catch (error) {
                console.error('Error creating section:', error);
                showNotification('Error creating section. Please try again.', 'error');
            }
        }

        // Session functions
        function toggleCustomDurationField() {
            if (elements.sessionDuration.value === 'custom') {
                elements.customDurationField.classList.remove('hidden');
            } else {
                elements.customDurationField.classList.add('hidden');
            }
        }

        function getCurrentLocationForSession() {
            elements.sessionLocationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Save coordinates
                        elements.sessionLatitude.value = latitude;
                        elements.sessionLongitude.value = longitude;
                        
                        // Reverse geocode to get location name
                        reverseGeocode(latitude, longitude).then(locationName => {
                            elements.sessionLocationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location updated: ${locationName}`;
                        }).catch(error => {
                            console.error('Geocoding error:', error);
                            elements.sessionLocationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location updated (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
                        });
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        elements.sessionLocationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error getting location';
                        showLocationSettings();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                elements.sessionLocationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Geolocation not supported';
                showLocationSettings();
            }
        }

        async function handleStartSession(e) {
            e.preventDefault();
            
            if (!currentSection) {
                showNotification('No section selected', 'error');
                return;
            }
            
            let duration;
            
            if (elements.sessionDuration.value === 'custom') {
                duration = parseInt(elements.customDuration.value);
                
                if (isNaN(duration) || duration < 5 || duration > 150) {
                    showNotification('Duration must be between 5 and 150 minutes', 'error');
                    return;
                }
            } else {
                duration = parseInt(elements.sessionDuration.value);
            }
            
            // Use custom location if set, otherwise use section's default location
            let latitude, longitude, locationName;
            
            if (elements.sessionLatitude.value && elements.sessionLongitude.value) {
                latitude = parseFloat(elements.sessionLatitude.value);
                longitude = parseFloat(elements.sessionLongitude.value);
                locationName = await reverseGeocode(latitude, longitude);
            } else {
                latitude = currentSection.location.latitude;
                longitude = currentSection.location.longitude;
                locationName = currentSection.location.name;
            }
            
            const enableAutoCheckIn = elements.enableAutoCheckin.checked;
            
            try {
                // Create session document
                const sessionRef = await db.collection('sessions').add({
                    sectionId: currentSection.id,
                    sectionName: currentSection.name,
                    teacherId: currentUser.uid,
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    endTime: null,
                    duration: duration,
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        name: locationName
                    },
                    radius: currentSection.radius,
                    enableAutoCheckIn: enableAutoCheckIn,
                    ended: false
                });
                
                showNotification('Session started successfully', 'success');
                
                // Hide modal
                hideModal(elements.startSessionModal);
                
                // Update current session
                currentSession = {
                    id: sessionRef.id,
                    sectionId: currentSection.id,
                    sectionName: currentSection.name,
                    teacherId: currentUser.uid,
                    startTime: new Date(),
                    endTime: null,
                    duration: duration,
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        name: locationName
                    },
                    radius: currentSection.radius,
                    enableAutoCheckIn: enableAutoCheckIn,
                    ended: false
                };
                
                // Show active session modal
                showActiveSession();
                
                // Listen for attendance changes
                listenForAttendanceChanges();
            } catch (error) {
                console.error('Error starting session:', error);
                showNotification('Error starting session. Please try again.', 'error');
            }
        }

        function showActiveSession() {
            if (!currentSession) return;
            
            // Update session info
            elements.activeSessionSection.textContent = currentSession.sectionName;
            elements.activeSessionStarted.textContent = formatDateTime(currentSession.startTime);
            elements.activeSessionLocation.textContent = currentSession.location.name;
            elements.activeSessionRadius.textContent = `${currentSession.radius}m (${getRadiusName(currentSession.radius)})`;
            
            // Calculate and update end time
            const endTime = new Date(currentSession.startTime.getTime() + currentSession.duration * 60000);
            elements.activeSessionEnds.textContent = formatDateTime(endTime);
            
            // Update countdown timer
            updateSessionCountdown();
            
            // Load student count
            loadSessionStudentCount();
            
            // Load checked-in count
            loadSessionCheckedInCount();
            
            showModal(elements.activeSessionModal);
        }

        function updateSessionCountdown() {
            if (!currentSession) return;
            
            const now = new Date();
            const endTime = new Date(currentSession.startTime.getTime() + currentSession.duration * 60000);
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                // Session has ended
                elements.activeSessionEnds.textContent = 'Session ended';
                endCurrentSession();
                return;
            }
            
            const minutesLeft = Math.floor(timeLeft / 60000);
            const secondsLeft = Math.floor((timeLeft % 60000) / 1000);
            
            elements.activeSessionEnds.textContent = `Ends in ${minutesLeft}m ${secondsLeft}s`;
            
            // Update every second
            setTimeout(updateSessionCountdown, 1000);
        }

        async function loadSessionStudentCount() {
            try {
                const studentsQuery = await db.collection('sections').doc(currentSection.id).collection('students').get();
                elements.activeSessionStudents.textContent = `${studentsQuery.size} students`;
            } catch (error) {
                console.error('Error loading student count:', error);
                elements.activeSessionStudents.textContent = 'Error loading student count';
            }
        }

        async function loadSessionCheckedInCount() {
            try {
                const attendanceQuery = await db.collection('sections').doc(currentSection.id).collection('attendance')
                    .where('sessionId', '==', currentSession.id).get();
                
                elements.activeSessionCheckedIn.textContent = `${attendanceQuery.size} checked in`;
            } catch (error) {
                console.error('Error loading attendance count:', error);
                elements.activeSessionCheckedIn.textContent = 'Error loading attendance';
            }
        }

        function listenForAttendanceChanges() {
            if (!currentSession || !currentSection) return;
            
            db.collection('sections').doc(currentSection.id).collection('attendance')
                .where('sessionId', '==', currentSession.id)
                .onSnapshot(snapshot => {
                    elements.activeSessionCheckedIn.textContent = `${snapshot.size} checked in`;
                }, error => {
                    console.error('Attendance listener error:', error);
                });
        }

        async function endCurrentSession() {
            if (!currentSession) return;
            
            try {
                // Update session document
                await db.collection('sessions').doc(currentSession.id).update({
                    ended: true,
                    endTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Session ended successfully', 'success');
                
                // Stop location tracking if active
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                // Hide modal
                hideModal(elements.activeSessionModal);
                
                // Reset current session
                currentSession = null;
                
                // Refresh dashboard
                refreshDashboard();
            } catch (error) {
                console.error('Error ending session:', error);
                showNotification('Error ending session. Please try again.', 'error');
            }
        }

        function viewSessionAttendance() {
            if (!currentSession || !currentSection) return;
            
            // Set the attendance section and date
            elements.attendanceSectionSelect.value = currentSection.id;
            elements.attendanceDateSelect.valueAsDate = currentSession.startTime;
            
            // Navigate to attendance section
            navigateTo('attendance');
            
            // Hide modal
            hideModal(elements.activeSessionModal);
        }

        // Invite students functions
        function showInviteStudentsModal() {
            if (!currentSection) return;
            
            // Generate invite link
            const inviteLink = `${window.location.origin}?invite=${currentSection.id}`;
            elements.inviteLink.value = inviteLink;
            
            // Generate QR code
            const qr = qrcode(0, 'L');
            qr.addData(inviteLink);
            qr.make();
            elements.inviteQrCode.innerHTML = qr.createImgTag(4);
            
            // Set section ID
            elements.sectionIdDisplay.value = currentSection.id;
            
            showModal(elements.inviteStudentsModal);
        }

        function copyInviteLink() {
            elements.inviteLink.select();
            document.execCommand('copy');
            showNotification('Invite link copied to clipboard', 'success');
        }

        function downloadQrCode() {
            const qrImg = elements.inviteQrCode.querySelector('img');
            if (!qrImg) return;
            
            const link = document.createElement('a');
            link.href = qrImg.src;
            link.download = `NearCheck-${currentSection.name}-QR.png`;
            link.click();
        }

        function copySectionId() {
            elements.sectionIdDisplay.select();
            document.execCommand('copy');
            showNotification('Section ID copied to clipboard', 'success');
        }

        // Edit section functions
        function showEditSectionModal() {
            if (!currentSection) return;
            
            // Fill form with current section data
            elements.editSectionName.value = currentSection.name;
            elements.editSectionSubject.value = currentSection.subject;
            
            // Set schedule
            if (typeof currentSection.schedule === 'string') {
                elements.editSectionSchedule.value = currentSection.schedule;
                elements.editCustomScheduleFields.classList.add('hidden');
            } else {
                elements.editSectionSchedule.value = 'custom';
                elements.editCustomScheduleFields.classList.remove('hidden');
                
                // Check days
                elements.editDayMonday.checked = currentSection.schedule.days.includes('Monday');
                elements.editDayTuesday.checked = currentSection.schedule.days.includes('Tuesday');
                elements.editDayWednesday.checked = currentSection.schedule.days.includes('Wednesday');
                elements.editDayThursday.checked = currentSection.schedule.days.includes('Thursday');
                elements.editDayFriday.checked = currentSection.schedule.days.includes('Friday');
                
                // Set time
                elements.editCustomTime.value = currentSection.schedule.time;
            }
            
            // Set radius
            elements.editSectionRadius.value = currentSection.radius;
            
            // Set location
            elements.editSectionLatitude.value = currentSection.location.latitude;
            elements.editSectionLongitude.value = currentSection.location.longitude;
            elements.editLocationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Current location: ${currentSection.location.name}`;
            
            showModal(elements.editSectionModal);
        }

        function toggleEditCustomScheduleFields() {
            if (elements.editSectionSchedule.value === 'custom') {
                elements.editCustomScheduleFields.classList.remove('hidden');
            } else {
                elements.editCustomScheduleFields.classList.add('hidden');
            }
        }

        function getCurrentLocationForEditSection() {
            elements.editLocationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Save coordinates
                        elements.editSectionLatitude.value = latitude;
                        elements.editSectionLongitude.value = longitude;
                        
                        // Reverse geocode to get location name
                        reverseGeocode(latitude, longitude).then(locationName => {
                            elements.editLocationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location updated: ${locationName}`;
                        }).catch(error => {
                            console.error('Geocoding error:', error);
                            elements.editLocationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location updated (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
                        });
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        elements.editLocationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error getting location';
                        showLocationSettings();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                elements.editLocationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Geolocation not supported';
                showLocationSettings();
            }
        }

        async function handleEditSection(e) {
            e.preventDefault();
            
            const name = elements.editSectionName.value.trim();
            const subject = elements.editSectionSubject.value.trim();
            const scheduleType = elements.editSectionSchedule.value;
            const radius = parseInt(elements.editSectionRadius.value);
            const latitude = parseFloat(elements.editSectionLatitude.value);
            const longitude = parseFloat(elements.editSectionLongitude.value);
            
            if (!name || !subject) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (isNaN(latitude) || isNaN(longitude)) {
                showNotification('Please set a location for the section', 'error');
                return;
            }
            
            let schedule;
            
            if (scheduleType === 'custom') {
                const days = [];
                if (elements.editDayMonday.checked) days.push('Monday');
                if (elements.editDayTuesday.checked) days.push('Tuesday');
                if (elements.editDayWednesday.checked) days.push('Wednesday');
                if (elements.editDayThursday.checked) days.push('Thursday');
                if (elements.editDayFriday.checked) days.push('Friday');
                
                const time = elements.editCustomTime.value;
                
                if (days.length === 0 || !time) {
                    showNotification('Please select at least one day and time for custom schedule', 'error');
                    return;
                }
                
                schedule = {
                    days: days,
                    time: time
                };
            } else {
                schedule = scheduleType;
            }
            
            try {
                // Update section document
                await db.collection('sections').doc(currentSection.id).update({
                    name: name,
                    subject: subject,
                    schedule: schedule,
                    radius: radius,
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        name: await reverseGeocode(latitude, longitude)
                    }
                });
                
                showNotification('Section updated successfully', 'success');
                
                // Update current section data
                currentSection.name = name;
                currentSection.subject = subject;
                currentSection.schedule = schedule;
                currentSection.radius = radius;
                currentSection.location = {
                    latitude: latitude,
                    longitude: longitude,
                    name: await reverseGeocode(latitude, longitude)
                };
                
                // Refresh sections list
                await refreshSections();
                
                // Hide modal
                hideModal(elements.editSectionModal);
                
                // Update section details
                showSectionDetails();
            } catch (error) {
                console.error('Error updating section:', error);
                showNotification('Error updating section. Please try again.', 'error');
            }
        }

        // Delete section functions
        function toggleDeleteButton() {
            if (elements.confirmDeleteSection.checked) {
                // Start 10-second countdown
                let seconds = 10;
                elements.deleteTimer.textContent = seconds;
                elements.deleteCountdown.classList.remove('hidden');
                
                const timer = setInterval(() => {
                    seconds--;
                    elements.deleteTimer.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(timer);
                        elements.confirmDeleteBtn.disabled = false;
                        elements.deleteCountdown.classList.add('hidden');
                    }
                }, 1000);
            } else {
                elements.confirmDeleteBtn.disabled = true;
            }
        }

        async function handleDeleteSection(e) {
            e.preventDefault();
            
            const password = elements.deleteSectionPassword.value;
            
            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    password
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Mark section as deleted
                await db.collection('sections').doc(currentSection.id).update({
                    deleted: true,
                    deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Section deleted successfully. You can restore it within 30 days.', 'success');
                
                // Refresh sections list
                await refreshSections();
                await loadDeletedSections();
                
                // Hide modal
                hideModal(elements.deleteSectionModal);
                hideModal(elements.sectionDetailsModal);
            } catch (error) {
                console.error('Error deleting section:', error);
                
                if (error.code === 'auth/wrong-password') {
                    showNotification('Incorrect password. Please try again.', 'error');
                } else {
                    showNotification('Error deleting section. Please try again.', 'error');
                }
            }
        }

        // Deleted sections functions
        async function loadDeletedSections() {
            try {
                const sectionsQuery = await db.collection('sections').where('teacherId', '==', currentUser.uid)
                    .where('deleted', '==', true).orderBy('deletedAt', 'desc').get();
                
                deletedSections = sectionsQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                loadDeletedSectionsList();
            } catch (error) {
                console.error('Error loading deleted sections:', error);
                showNotification('Error loading deleted sections', 'error');
            }
        }

        function loadDeletedSectionsList() {
            elements.deletedSectionsList.innerHTML = '';
            
            if (deletedSections.length === 0) {
                elements.deletedSectionsList.innerHTML = '<div class="empty-state">No deleted sections found.</div>';
                return;
            }
            
            deletedSections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'deleted-section-item';
                item.setAttribute('data-section-id', section.id);
                
                const info = document.createElement('div');
                info.className = 'info';
                
                const name = document.createElement('h3');
                name.textContent = section.name;
                
                const meta = document.createElement('div');
                meta.className = 'meta';
                
                const deletedAt = document.createElement('span');
                deletedAt.textContent = `Deleted ${formatDate(section.deletedAt.toDate())}`;
                
                const daysLeft = document.createElement('span');
                const deletionDate = section.deletedAt.toDate();
                const purgeDate = new Date(deletionDate);
                purgeDate.setDate(purgeDate.getDate() + 30);
                const daysRemaining = Math.ceil((purgeDate - new Date()) / (1000 * 60 * 60 * 24));
                daysLeft.textContent = `${daysRemaining} days until permanent deletion`;
                
                meta.appendChild(deletedAt);
                meta.appendChild(daysLeft);
                
                info.appendChild(name);
                info.appendChild(meta);
                
                const actions = document.createElement('div');
                actions.className = 'actions';
                
                const restoreBtn = document.createElement('button');
                restoreBtn.className = 'secondary-btn';
                restoreBtn.innerHTML = '<i class="fas fa-trash-restore"></i> Restore';
                restoreBtn.addEventListener('click', () => {
                    currentSection = section;
                    showModal(elements.restoreSectionModal);
                });
                
                actions.appendChild(restoreBtn);
                
                item.appendChild(info);
                item.appendChild(actions);
                
                elements.deletedSectionsList.appendChild(item);
            });
        }

        async function refreshDeletedSections() {
            await loadDeletedSections();
        }

        async function restoreSelectedSection() {
            if (!currentSection) return;
            
            try {
                // Update section document
                await db.collection('sections').doc(currentSection.id).update({
                    deleted: false,
                    deletedAt: null
                });
                
                showNotification('Section restored successfully', 'success');
                
                // Refresh sections lists
                await refreshSections();
                await refreshDeletedSections();
                
                // Hide modal
                hideModal(elements.restoreSectionModal);
            } catch (error) {
                console.error('Error restoring section:', error);
                showNotification('Error restoring section. Please try again.', 'error');
            }
        }

        // Check-in functions
        function showCheckInSheet() {
            if (!currentSection || !currentSession) return;
            
            // Reset sheet state
            elements.checkInStatusMessage.classList.remove('hidden');
            elements.checkInProgress.classList.add('hidden');
            elements.checkInSuccess.classList.add('hidden');
            elements.checkInFailure.classList.add('hidden');
            elements.checkInActionBtn.classList.add('hidden');
            
            elements.checkInStatusMessage.innerHTML = '<i class="fas fa-info-circle"></i> Checking your location...';
            
            showBottomSheet(elements.checkInSheet);
            
            // Start check-in process
            handleCheckIn();
        }

        async function handleCheckIn() {
            if (!currentSection || !currentSession) return;
            
            // Show progress
            elements.checkInStatusMessage.classList.add('hidden');
            elements.checkInProgress.classList.remove('hidden');
            
            try {
                // Get current location
                const position = await getCurrentPosition();
                
                // Calculate distance from session location
                const distance = calculateDistance(
                    position.coords.latitude,
                    position.coords.longitude,
                    currentSession.location.latitude,
                    currentSession.location.longitude
                );
                
                // Check if within radius
                if (distance <= currentSession.radius) {
                    // Record attendance
                    await recordAttendance('present');
                    
                    // Show success
                    elements.checkInProgress.classList.add('hidden');
                    elements.checkInSuccess.classList.remove('hidden');
                    elements.checkInTime.textContent = formatTime(new Date());
                    elements.checkInActionBtn.classList.add('hidden');
                } else {
                    // Too far away
                    elements.checkInProgress.classList.add('hidden');
                    elements.checkInFailure.classList.remove('hidden');
                    elements.checkInErrorTitle.textContent = 'Too Far Away';
                    elements.checkInErrorMessage.textContent = `You are ${Math.round(distance)}m away from the section location (required: ${currentSession.radius}m).`;
                    elements.checkInActionBtn.classList.remove('hidden');
                    elements.checkInActionBtn.textContent = 'Try Again';
                }
            } catch (error) {
                console.error('Check-in error:', error);
                
                elements.checkInProgress.classList.add('hidden');
                elements.checkInFailure.classList.remove('hidden');
                elements.checkInErrorTitle.textContent = 'Check-In Failed';
                elements.checkInErrorMessage.textContent = getLocationError(error);
                elements.checkInActionBtn.classList.remove('hidden');
                elements.checkInActionBtn.textContent = 'Try Again';
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => resolve(position),
                    error => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula to calculate distance between two coordinates in meters
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }

        function getLocationError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    return 'Location permission denied. Please enable location access in settings.';
                case error.POSITION_UNAVAILABLE:
                    return 'Location information is unavailable.';
                case error.TIMEOUT:
                    return 'The request to get location timed out.';
                case error.UNKNOWN_ERROR:
                    return 'An unknown error occurred while getting location.';
                default:
                    return 'Error getting your location. Please try again.';
            }
        }

        async function recordAttendance(status) {
            try {
                // Check if already checked in
                const existingCheckIn = await db.collection('sections').doc(currentSection.id).collection('attendance')
                    .where('sessionId', '==', currentSession.id)
                    .where('studentId', '==', currentUser.uid)
                    .limit(1)
                    .get();
                
                if (!existingCheckIn.empty) {
                    // Update existing record
                    await db.collection('sections').doc(currentSection.id).collection('attendance')
                        .doc(existingCheckIn.docs[0].id)
                        .update({
                            status: status,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } else {
                    // Create new record
                    await db.collection('sections').doc(currentSection.id).collection('attendance').add({
                        sessionId: currentSession.id,
                        studentId: currentUser.uid,
                        status: status,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error recording attendance:', error);
                throw error;
            }
        }

        // Auto check-in functions
        function checkAutoCheckInStatus() {
            if (!currentSession || !currentSession.enableAutoCheckIn) return;
            
            // Check if auto check-in is already enabled for this user
            const autoCheckInEnabled = localStorage.getItem(`autoCheckIn-${currentSection.id}`) === 'true';
            
            if (!autoCheckInEnabled) {
                // Show prompt
                showBottomSheet(elements.autoCheckinSheet);
            } else {
                // Start auto check-in
                startAutoCheckIn();
            }
        }

        function enableAutoCheckIn() {
            if (!currentSection || !currentSession) return;
            
            // Save preference
            localStorage.setItem(`autoCheckIn-${currentSection.id}`, 'true');
            
            // Hide sheet
            hideBottomSheet(elements.autoCheckinSheet);
            
            // Start auto check-in
            startAutoCheckIn();
        }

        function startAutoCheckIn() {
            if (!currentSection || !currentSession || locationWatchId) return;
            
            // Start watching location
            locationWatchId = navigator.geolocation.watchPosition(
                async position => {
                    // Calculate distance
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        currentSession.location.latitude,
                        currentSession.location.longitude
                    );
                    
                    // If within radius, check in
                    if (distance <= currentSession.radius) {
                        try {
                            await recordAttendance('present');
                            
                            // Show notification if app is in foreground
                            showNotification('Auto check-in successful', 'success');
                        } catch (error) {
                            console.error('Auto check-in error:', error);
                        }
                    }
                },
                error => {
                    console.error('Auto check-in location error:', error);
                },
                { enableHighAccuracy: true, maximumAge: 10000 }
            );
            
            // Set timeout to stop tracking after 12 hours
            setTimeout(() => {
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                    
                    // Clear preference
                    localStorage.removeItem(`autoCheckIn-${currentSection.id}`);
                }
            }, 12 * 60 * 60 * 1000); // 12 hours
        }

        // Location permission functions
        function checkLocationPermission() {
            if (!navigator.permissions) {
                // Browser doesn't support permissions API
                updateLocationPermissionStatus('unknown');
                return;
            }
            
            navigator.permissions.query({ name: 'geolocation' }).then(result => {
                updateLocationPermissionStatus(result.state);
                
                // Listen for changes
                result.onchange = () => {
                    updateLocationPermissionStatus(result.state);
                };
            }).catch(error => {
                console.error('Permission query error:', error);
                updateLocationPermissionStatus('unknown');
            });
        }

        function updateLocationPermissionStatus(state) {
            let statusText, statusClass;
            
            switch (state) {
                case 'granted':
                    statusText = 'Granted — Location permission is active and accessible.';
                    statusClass = 'granted';
                    break;
                case 'denied':
                    statusText = 'Denied — User declined permission.';
                    statusClass = 'denied';
                    break;
                case 'prompt':
                    statusText = 'Not determined — Permission not yet requested.';
                    statusClass = 'prompt';
                    break;
                default:
                    statusText = 'Unavailable — Browser does not support location access.';
                    statusClass = 'unavailable';
            }
            
            elements.locationPermissionStatus.innerHTML = `<i class="fas fa-info-circle"></i> ${statusText}`;
            elements.locationPermissionStatus.className = `status-message ${statusClass}`;
            
            // Show appropriate buttons
            if (state === 'unavailable' || state === 'unknown') {
                elements.unsupportedBrowser.classList.remove('hidden');
                elements.locationSheetFooter.classList.add('hidden');
                
                // Show download options based on user agent
                showBrowserDownloadOptions();
            } else {
                elements.unsupportedBrowser.classList.add('hidden');
                elements.locationSheetFooter.classList.remove('hidden');
            }
        }

        function showBrowserDownloadOptions() {
            elements.browserDownloadOptions.innerHTML = '';
            
            const userAgent = navigator.userAgent;
            
            if (/android/i.test(userAgent)) {
                // Android device - recommend Chrome
                const chromeBtn = document.createElement('button');
                chromeBtn.className = 'secondary-btn';
                chromeBtn.innerHTML = '<i class="fab fa-chrome"></i> Download Chrome';
                chromeBtn.addEventListener('click', () => {
                    window.open('https://play.google.com/store/apps/details?id=com.android.chrome', '_blank');
                });
                
                elements.browserDownloadOptions.appendChild(chromeBtn);
            } else if (/iphone|ipad|ipod/i.test(userAgent)) {
                // iOS device - recommend Safari (already installed)
                const safariText = document.createElement('p');
                safariText.textContent = 'Safari is already installed on your device.';
                elements.browserDownloadOptions.appendChild(safariText);
            } else if (/windows/i.test(userAgent)) {
                // Windows device - recommend Edge
                const edgeBtn = document.createElement('button');
                edgeBtn.className = 'secondary-btn';
                edgeBtn.innerHTML = '<i class="fab fa-edge"></i> Download Edge';
                edgeBtn.addEventListener('click', () => {
                    window.open('https://www.microsoft.com/en-us/edge', '_blank');
                });
                
                elements.browserDownloadOptions.appendChild(edgeBtn);
            } else if (/macintosh/i.test(userAgent)) {
                // Mac device - recommend Safari
                const safariBtn = document.createElement('button');
                safariBtn.className = 'secondary-btn';
                safariBtn.innerHTML = '<i class="fab fa-safari"></i> Use Safari';
                safariBtn.addEventListener('click', () => {
                    window.open('https://www.apple.com/safari/', '_blank');
                });
                
                elements.browserDownloadOptions.appendChild(safariBtn);
            } else {
                // Other devices - generic recommendation
                const text = document.createElement('p');
                text.textContent = 'Please use a modern browser that supports geolocation.';
                elements.browserDownloadOptions.appendChild(text);
            }
        }

        function showLocationSettings() {
            showBottomSheet(elements.locationSheet);
        }

        function requestLocationPermission() {
            elements.locationPermissionStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting permission...';
            
            navigator.geolocation.getCurrentPosition(
                () => {
                    // Success
                    updateLocationPermissionStatus('granted');
                    hideBottomSheet(elements.locationSheet);
                },
                error => {
                    // Error
                    if (error.code === error.PERMISSION_DENIED) {
                        updateLocationPermissionStatus('denied');
                    } else {
                        updateLocationPermissionStatus('unknown');
                    }
                },
                { enableHighAccuracy: true }
            );
        }

        // Profile functions
        function initEmojiPicker() {
            // Populate emoji categories
            const categoryButtons = elements.emojiPicker.querySelectorAll('.emoji-categories button');
            
            categoryButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const category = button.getAttribute('data-category');
                    showEmojiCategory(category);
                });
            });
            
            // Show first category by default
            showEmojiCategory('smileys');
        }

        function showEmojiCategory(category) {
            const emojiGrid = elements.emojiPicker.querySelector('.emoji-grid');
            emojiGrid.innerHTML = '';
            
            if (emojiList[category]) {
                emojiList[category].forEach(emoji => {
                    const emojiButton = document.createElement('button');
                    emojiButton.className = 'emoji-btn';
                    emojiButton.textContent = emoji;
                    emojiButton.addEventListener('click', () => selectEmoji(emoji));
                    emojiGrid.appendChild(emojiButton);
                });
            }
        }

        function selectEmoji(emoji) {
            elements.profileAvatarPreview.textContent = emoji;
            elements.saveProfileBtn.disabled = false;
        }

        function showEmojiPicker() {
            elements.emojiPicker.classList.remove('hidden');
            elements.textPicker.classList.add('hidden');
        }

        function showTextPicker() {
            elements.emojiPicker.classList.add('hidden');
            elements.textPicker.classList.remove('hidden');
            elements.profileTextInput.focus();
        }

        function validateProfileText() {
            const text = elements.profileTextInput.value.trim();
            elements.saveProfileBtn.disabled = text.length === 0 || text.length > 2;
        }

        function showProfileEditor() {
            // Reset form
            elements.emojiPicker.classList.add('hidden');
            elements.textPicker.classList.add('hidden');
            elements.profileTextInput.value = '';
            elements.saveProfileBtn.disabled = true;
            
            // Set current avatar
            elements.profileAvatarPreview.textContent = userData.displayName;
            elements.profileAvatarPreview.style.backgroundColor = userData.avatarColor;
            
            // Check if user can change profile
            const now = new Date();
            const lastChange = lastProfileChange ? new Date(lastProfileChange) : null;
            
            if (lastChange && (now - lastChange) < 24 * 60 * 60 * 1000) {
                const hoursLeft = 24 - Math.floor((now - lastChange) / (60 * 60 * 1000));
                elements.changeCooldown.textContent = `${hoursLeft} hours`;
                elements.profileChangeMessage.classList.remove('hidden');
            } else {
                elements.profileChangeMessage.classList.add('hidden');
            }
            
            showModal(elements.profileModal);
        }

        async function saveProfileChanges() {
            let newDisplayName;
            
            if (!elements.emojiPicker.classList.contains('hidden')) {
                // Emoji selected
                newDisplayName = elements.profileAvatarPreview.textContent;
            } else {
                // Text selected
                newDisplayName = elements.profileTextInput.value.trim().substring(0, 2);
            }
            
            if (!newDisplayName) {
                showNotification('Please select an emoji or enter text', 'error');
                return;
            }
            
            try {
                // Update user document
                await db.collection('users').doc(currentUser.uid).update({
                    displayName: newDisplayName,
                    lastProfileChange: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                userData.displayName = newDisplayName;
                lastProfileChange = new Date();
                
                // Update UI
                elements.userAvatar.textContent = newDisplayName;
                elements.userDisplayName.textContent = newDisplayName;
                
                showNotification('Profile updated successfully', 'success');
                hideModal(elements.profileModal);
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile. Please try again.', 'error');
            }
        }

        // Email functions
        async function handleChangeEmail(e) {
            e.preventDefault();
            
            const newEmail = elements.newEmail.value.trim();
            const password = elements.emailPassword.value;
            
            if (!newEmail || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (newEmail === currentUser.email) {
                showNotification('New email must be different from current email', 'error');
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    password
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update email
                await currentUser.updateEmail(newEmail);
                
                // Update user document
                await db.collection('users').doc(currentUser.uid).update({
                    email: newEmail
                });
                
                showNotification('Email updated successfully', 'success');
                hideModal(elements.emailModal);
            } catch (error) {
                console.error('Error changing email:', error);
                
                if (error.code === 'auth/wrong-password') {
                    showNotification('Incorrect password. Please try again.', 'error');
                } else if (error.code === 'auth/email-already-in-use') {
                    showNotification('Email is already in use by another account.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showNotification('Please enter a valid email address.', 'error');
                } else {
                    showNotification('Error updating email. Please try again.', 'error');
                }
            }
        }

        // Password functions
        async function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = elements.currentPassword.value;
            const newPassword = elements.newPassword.value;
            const confirmNewPassword = elements.confirmNewPassword.value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPassword);
                
                showNotification('Password updated successfully', 'success');
                hideModal(elements.passwordModal);
            } catch (error) {
                console.error('Error changing password:', error);
                
                if (error.code === 'auth/wrong-password') {
                    showNotification('Current password is incorrect', 'error');
                } else {
                    showNotification('Error updating password. Please try again.', 'error');
                }
            }
        }

        // Student profile functions
        async function showStudentProfile(studentId) {
            try {
                // Get student document
                const studentDoc = await db.collection('users').doc(studentId).get();
                
                if (!studentDoc.exists) {
                    showNotification('Student not found', 'error');
                    return;
                }
                
                const studentData = studentDoc.data();
                currentStudentProfile = {
                    id: studentId,
                    ...studentData
                };
                
                // Update profile view
                elements.studentAvatar.textContent = studentData.displayName;
                elements.studentAvatar.style.backgroundColor = studentData.avatarColor;
                elements.studentDisplayName.textContent = studentData.displayName;
                elements.studentJoinedDate.textContent = `Joined ${formatDate(studentData.createdAt.toDate())}`;
                
                // Load attendance stats
                const attendanceQuery = await db.collection('sections').doc(currentSection.id).collection('attendance')
                    .where('studentId', '==', studentId).get();
                
                const presentCount = attendanceQuery.docs.filter(doc => doc.data().status === 'present').length;
                const totalCount = attendanceQuery.size;
                const attendanceRate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
                
                elements.studentTotalAttendance.textContent = presentCount;
                elements.studentAttendanceRate.textContent = `${attendanceRate}%`;
                
                // Show teacher actions if current user is teacher
                if (userRole === 'teacher') {
                    elements.teacherStudentActions.classList.remove('hidden');
                } else {
                    elements.teacherStudentActions.classList.add('hidden');
                }
                
                showModal(elements.studentProfileModal);
            } catch (error) {
                console.error('Error loading student profile:', error);
                showNotification('Error loading student profile', 'error');
            }
        }

        async function saveStudentStatus() {
            const status = elements.studentStatusSelect.value;
            const date = elements.studentStatusDate.valueAsDate;
            
            if (!status || !date || !currentStudentProfile || !currentSection) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                // Convert date to start of day in local timezone
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                
                // Check if attendance already exists for this date
                const existingAttendance = await db.collection('sections').doc(currentSection.id).collection('attendance')
                    .where('studentId', '==', currentStudentProfile.id)
                    .where('timestamp', '>=', startOfDay)
                    .where('timestamp', '<=', endOfDay)
                    .limit(1)
                    .get();
                
                if (!existingAttendance.empty) {
                    // Update existing record
                    await db.collection('sections').doc(currentSection.id).collection('attendance')
                        .doc(existingAttendance.docs[0].id)
                        .update({
                            status: status,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } else {
                    // Create new record with a synthetic timestamp at noon
                    const timestamp = new Date(date);
                    timestamp.setHours(12, 0, 0, 0);
                    
                    await db.collection('sections').doc(currentSection.id).collection('attendance').add({
                        studentId: currentStudentProfile.id,
                        status: status,
                        timestamp: timestamp,
                        manualEntry: true,
                        teacherId: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showNotification('Attendance status updated', 'success');
                hideModal(elements.studentProfileModal);
                
                // Refresh attendance list
                refreshAttendance();
            } catch (error) {
                console.error('Error saving student status:', error);
                showNotification('Error updating attendance status', 'error');
            }
        }

        async function confirmRemoveStudent() {
            if (!currentStudentProfile || !currentSection) return;
            
            const confirmed = confirm(`Are you sure you want to remove ${currentStudentProfile.displayName} from this section?`);
            
            if (confirmed) {
                try {
                    // Remove student from section
                    await db.collection('sections').doc(currentSection.id).collection('students')
                        .doc(currentStudentProfile.id).delete();
                    
                    // Remove enrollment record
                    const enrollmentQuery = await db.collection('enrollments')
                        .where('sectionId', '==', currentSection.id)
                        .where('studentId', '==', currentStudentProfile.id)
                        .limit(1)
                        .get();
                    
                    if (!enrollmentQuery.empty) {
                        await db.collection('enrollments').doc(enrollmentQuery.docs[0].id).delete();
                    }
                    
                    showNotification('Student removed from section', 'success');
                    hideModal(elements.studentProfileModal);
                    
                    // Refresh sections
                    refreshSections();
                } catch (error) {
                    console.error('Error removing student:', error);
                    showNotification('Error removing student', 'error');
                }
            }
        }

        // Teacher profile functions
        async function showTeacherProfile(teacherId) {
            try {
                // Get teacher document
                const teacherDoc = await db.collection('users').doc(teacherId).get();
                
                if (!teacherDoc.exists) {
                    showNotification('Teacher not found', 'error');
                    return;
                }
                
                const teacherData = teacherDoc.data();
                currentTeacherProfile = {
                    id: teacherId,
                    ...teacherData
                };
                
                // Update profile view
                elements.teacherAvatar.textContent = teacherData.displayName;
                elements.teacherAvatar.style.backgroundColor = teacherData.avatarColor;
                elements.teacherDisplayName.textContent = teacherData.displayName;
                elements.teacherJoinedDate.textContent = `Joined ${formatDate(teacherData.createdAt.toDate())}`;
                
                // Load teacher stats
                const sectionsQuery = await db.collection('sections').where('teacherId', '==', teacherId).get();
                elements.teacherTotalSections.textContent = sectionsQuery.size;
                
                let totalStudents = 0;
                for (const section of sectionsQuery.docs) {
                    const studentsQuery = await db.collection('sections').doc(section.id).collection('students').get();
                    totalStudents += studentsQuery.size;
                }
                elements.teacherTotalStudents.textContent = totalStudents;
                
                showModal(elements.teacherProfileModal);
            } catch (error) {
                console.error('Error loading teacher profile:', error);
                showNotification('Error loading teacher profile', 'error');
            }
        }

        // Attendance functions
        async function refreshAttendance() {
            if (userRole === 'teacher') {
                await loadTeacherAttendance();
            } else {
                await loadStudentAttendance();
            }
        }

        async function loadTeacherAttendance() {
            try {
                // Get selected section and date
                const sectionId = elements.attendanceSectionSelect.value;
                const date = elements.attendanceDateSelect.valueAsDate;
                
                if (!sectionId || !date) {
                    elements.attendanceList.querySelector('tbody').innerHTML = '<tr><td colspan="4">Select a section and date</td></tr>';
                    return;
                }
                
                // Convert date to start of day in local timezone
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                
                // Get attendance records for selected date
                const attendanceQuery = await db.collection('sections').doc(sectionId).collection('attendance')
                    .where('timestamp', '>=', startOfDay)
                    .where('timestamp', '<=', endOfDay)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                // Get all students in section
                const studentsQuery = await db.collection('sections').doc(sectionId).collection('students').get();
                
                // Create map of student IDs to names
                const studentMap = new Map();
                for (const studentDoc of studentsQuery.docs) {
                    const studentData = studentDoc.data();
                    const userDoc = await db.collection('users').doc(studentData.studentId).get();
                    
                    if (userDoc.exists) {
                        studentMap.set(studentData.studentId, userDoc.data().displayName);
                    }
                }
                
                // Group attendance by student
                const attendanceByStudent = new Map();
                
                for (const doc of attendanceQuery.docs) {
                    const data = doc.data();
                    
                    if (!attendanceByStudent.has(data.studentId)) {
                        attendanceByStudent.set(data.studentId, {
                            status: data.status,
                            time: data.timestamp.toDate(),
                            id: doc.id
                        });
                    }
                }
                
                // Populate attendance list
                const tbody = elements.attendanceList.querySelector('tbody');
                tbody.innerHTML = '';
                
                // Count statuses
                let presentCount = 0;
                let absentCount = 0;
                let excusedCount = 0;
                
                // Add rows for each student
                for (const [studentId, studentName] of studentMap.entries()) {
                    const attendance = attendanceByStudent.get(studentId) || { status: 'absent', time: null };
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-student-id', studentId);
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = studentName;
                    
                    const statusCell = document.createElement('td');
                    statusCell.textContent = attendance.status.charAt(0).toUpperCase() + attendance.status.slice(1);
                    statusCell.className = attendance.status;
                    
                    const timeCell = document.createElement('td');
                    timeCell.textContent = attendance.time ? formatTime(attendance.time) : '--';
                    
                    const actionsCell = document.createElement('td');
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.addEventListener('click', () => {
                        showStudentProfile(studentId);
                    });
                    
                    actionsCell.appendChild(editBtn);
                    
                    row.appendChild(nameCell);
                    row.appendChild(statusCell);
                    row.appendChild(timeCell);
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                    
                    // Update counts
                    switch (attendance.status) {
                        case 'present': presentCount++; break;
                        case 'absent': absentCount++; break;
                        case 'excused': excusedCount++; break;
                    }
                }
                
                // Update summary cards
                elements.presentCount.textContent = presentCount;
                elements.absentCount.textContent = absentCount;
                elements.excusedCount.textContent = excusedCount;
                
                // Populate section dropdown if empty
                if (elements.attendanceSectionSelect.options.length <= 1) {
                    populateAttendanceSectionDropdown();
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                showNotification('Error loading attendance data', 'error');
            }
        }

        async function loadStudentAttendance() {
            try {
                // Get selected section
                const sectionId = elements.studentAttendanceSectionSelect.value;
                
                if (!sectionId) {
                    elements.studentAttendanceList.querySelector('tbody').innerHTML = '<tr><td colspan="3">Select a section</td></tr>';
                    return;
                }
                
                // Get attendance records for current student
                const attendanceQuery = await db.collection('sections').doc(sectionId).collection('attendance')
                    .where('studentId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(30) // Last 30 records
                    .get();
                
                // Populate attendance list
                const tbody = elements.studentAttendanceList.querySelector('tbody');
                tbody.innerHTML = '';
                
                let presentCount = 0;
                let totalCount = attendanceQuery.size;
                
                for (const doc of attendanceQuery.docs) {
                    const data = doc.data();
                    
                    if (data.status === 'present') {
                        presentCount++;
                    }
                    
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = formatDate(data.timestamp.toDate());
                    
                    const statusCell = document.createElement('td');
                    statusCell.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                    statusCell.className = data.status;
                    
                    const timeCell = document.createElement('td');
                    timeCell.textContent = data.timestamp ? formatTime(data.timestamp.toDate()) : '--';
                    
                    row.appendChild(dateCell);
                    row.appendChild(statusCell);
                    row.appendChild(timeCell);
                    
                    tbody.appendChild(row);
                }
                
                // Update summary
                elements.studentTotalCheckins.textContent = presentCount;
                elements.studentPercentage.textContent = totalCount > 0 ? `${Math.round((presentCount / totalCount) * 100)}%` : '0%';
                
                // Populate section dropdown if empty
                if (elements.studentAttendanceSectionSelect.options.length <= 1) {
                    populateStudentAttendanceSectionDropdown();
                }
            } catch (error) {
                console.error('Error loading student attendance:', error);
                showNotification('Error loading attendance data', 'error');
            }
        }

        function populateAttendanceSectionDropdown() {
            elements.attendanceSectionSelect.innerHTML = '<option value="">Select a section</option>';
            
            userSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.name;
                elements.attendanceSectionSelect.appendChild(option);
            });
        }

        function populateStudentAttendanceSectionDropdown() {
            elements.studentAttendanceSectionSelect.innerHTML = '<option value="">Select a section</option>';
            
            userEnrolledSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.name;
                elements.studentAttendanceSectionSelect.appendChild(option);
            });
        }

        function filterAttendance() {
            const searchTerm = elements.searchAttendance.value.toLowerCase();
            const rows = elements.attendanceList.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('td').textContent.toLowerCase();
                
                if (name.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function downloadAttendance() {
            const sectionId = elements.attendanceSectionSelect.value;
            const date = elements.attendanceDateSelect.valueAsDate;
            
            if (!sectionId || !date) {
                showNotification('Please select a section and date', 'error');
                return;
            }
            
            try {
                // Get section data
                const sectionDoc = await db.collection('sections').doc(sectionId).get();
                if (!sectionDoc.exists) {
                    showNotification('Section not found', 'error');
                    return;
                }
                
                const sectionData = sectionDoc.data();
                
                // Convert date to start of day in local timezone
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                
                // Get attendance records for selected date
                const attendanceQuery = await db.collection('sections').doc(sectionId).collection('attendance')
                    .where('timestamp', '>=', startOfDay)
                    .where('timestamp', '<=', endOfDay)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                // Get all students in section
                const studentsQuery = await db.collection('sections').doc(sectionId).collection('students').get();
                
                // Create map of student IDs to names
                const studentMap = new Map();
                for (const studentDoc of studentsQuery.docs) {
                    const studentData = studentDoc.data();
                    const userDoc = await db.collection('users').doc(studentData.studentId).get();
                    
                    if (userDoc.exists) {
                        studentMap.set(studentData.studentId, userDoc.data().displayName);
                    }
                }
                
                // Group attendance by student
                const attendanceByStudent = new Map();
                
                for (const doc of attendanceQuery.docs) {
                    const data = doc.data();
                    
                    if (!attendanceByStudent.has(data.studentId)) {
                        attendanceByStudent.set(data.studentId, {
                            status: data.status,
                            time: data.timestamp.toDate()
                        });
                    }
                }
                
                // Create CSV content
                let csvContent = 'Student Name,Status,Time\n';
                
                for (const [studentId, studentName] of studentMap.entries()) {
                    const attendance = attendanceByStudent.get(studentId) || { status: 'absent', time: null };
                    
                    csvContent += `"${studentName}","${attendance.status}","${attendance.time ? formatDateTime(attendance.time) : ''}"\n`;
                }
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${sectionData.name}_attendance_${formatDateForFilename(date)}.csv`;
                link.click();
                
                // Clean up
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('Error downloading attendance:', error);
                showNotification('Error downloading attendance data', 'error');
            }
        }

        // Section joining functions
        async function joinSection(sectionId) {
            try {
                // Check if section exists
                const sectionDoc = await db.collection('sections').doc(sectionId).get();
                
                if (!sectionDoc.exists || sectionDoc.data().deleted) {
                    showNotification('Section not found or has been deleted', 'error');
                    return;
                }
                
                const sectionData = sectionDoc.data();
                
                // Check if already enrolled
                const enrollmentQuery = await db.collection('enrollments')
                    .where('sectionId', '==', sectionId)
                    .where('studentId', '==', currentUser.uid)
                    .limit(1)
                    .get();
                
                if (!enrollmentQuery.empty) {
                    showNotification('You are already enrolled in this section', 'info');
                    return;
                }
                
                // Add student to section
                await db.collection('sections').doc(sectionId).collection('students').doc(currentUser.uid).set({
                    studentId: currentUser.uid,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create enrollment record
                await db.collection('enrollments').add({
                    sectionId: sectionId,
                    studentId: currentUser.uid,
                    enrolledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`Successfully joined ${sectionData.name}`, 'success');
                
                // Refresh sections
                await refreshSections();
                
                // Show the section
                currentSection = {
                    id: sectionId,
                    ...sectionData
                };
                
                showSectionDetails();
            } catch (error) {
                console.error('Error joining section:', error);
                showNotification('Error joining section. Please try again.', 'error');
            }
        }

        async function confirmLeaveSection() {
            if (!currentSection) return;
            
            const confirmed = confirm(`Are you sure you want to leave ${currentSection.name}?`);
            
            if (confirmed) {
                try {
                    // Remove student from section
                    await db.collection('sections').doc(currentSection.id).collection('students')
                        .doc(currentUser.uid).delete();
                    
                    // Remove enrollment record
                    const enrollmentQuery = await db.collection('enrollments')
                        .where('sectionId', '==', currentSection.id)
                        .where('studentId', '==', currentUser.uid)
                        .limit(1)
                        .get();
                    
                    if (!enrollmentQuery.empty) {
                        await db.collection('enrollments').doc(enrollmentQuery.docs[0].id).delete();
                    }
                    
                    showNotification(`You have left ${currentSection.name}`, 'success');
                    
                    // Hide modal
                    hideModal(elements.sectionDetailsModal);
                    
                    // Refresh sections
                    await refreshSections();
                } catch (error) {
                    console.error('Error leaving section:', error);
                    showNotification('Error leaving section. Please try again.', 'error');
                }
            }
        }

        // Invitation link functions
        function checkForInvitationLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sectionId = urlParams.get('invite');
            
            if (sectionId) {
                // Clear the invite parameter from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // If user is logged in, join the section
                if (currentUser) {
                    joinSection(sectionId);
                } else {
                    // Store section ID for after login
                    localStorage.setItem('pendingSectionInvite', sectionId);
                    
                    // If on student signup, pre-fill section ID
                    if (elements.studentSectionId) {
                        elements.studentSectionId.value = sectionId;
                    }
                }
            }
        }

        function checkPendingSectionInvitation() {
            const sectionId = localStorage.getItem('pendingSectionInvite');
            
            if (sectionId) {
                localStorage.removeItem('pendingSectionInvite');
                joinSection(sectionId);
            }
        }

        // Active sessions functions
        async function checkActiveSessions() {
            if (userRole === 'teacher') {
                // Check for active sessions created by this teacher
                const sessionsQuery = await db.collection('sessions').where('teacherId', '==', currentUser.uid)
                    .where('ended', '==', false).get();
                
                activeSessions = sessionsQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                if (activeSessions.length > 0) {
                    showNotification(`You have ${activeSessions.length} active session(s)`, 'info');
                }
            } else {
                // Check for active sessions in sections the student is enrolled in
                for (const section of userEnrolledSections) {
                    const sessionQuery = await db.collection('sessions').where('sectionId', '==', section.id)
                        .where('ended', '==', false).limit(1).get();
                    
                    if (!sessionQuery.empty) {
                        showNotification(`Active session in ${section.name}`, 'info');
                    }
                }
            }
        }

        // Notification functions
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                notification.classList.add('hide');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            elements.notificationContainer.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Settings functions
        function showNotificationSettings() {
            showNotification('Notification settings will be implemented in a future version', 'info');
        }

        function showPrivacyPolicy() {
            showNotification('Privacy policy will be implemented in a future version', 'info');
        }

        function showTermsOfService() {
            showNotification('Terms of service will be implemented in a future version', 'info');
        }

        // Utility functions
        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTime(date) {
            if (!date) return '';
            return `${formatDate(date)} at ${formatTime(date)}`;
        }

        function formatDateForFilename(date) {
            if (!date) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function generateRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 65%)`;
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 65%)`;
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function showBottomSheet(sheet) {
            sheet.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideBottomSheet(sheet) {
            sheet.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>