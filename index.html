<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none';">
    <meta name="theme-color" content="#7c3aed" />
    <meta name="description" content="Countify Lite - Advanced writing analytics tool with word count, character count, reading time and more" />
    <title>Countify+</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" href="/logo/countify.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://countify-black.vercel.app/css/mdui.css">
    <link rel="stylesheet" href="https://countify-black.vercel.app/css/mdui.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://countify-black.vercel.app/css/main.css" />
    <script src="https://www.paypal.com/sdk/js?client-id=BAALvw_Ri8vqAGObpMeZGYY0eLZZ3trTxQ_MdB5qdHJZrbWJAVRlgoykIK3X4P0iovnRJYksnD1WwUI6HA&components=hosted-buttons&disable-funding=venmo&currency=PHP">
    </script>
    <script src="fonts/language.js"></script>
    <link rel="manifest" href="/manifest.json" />
</head>
<style>
    @font-face {
        font-family: 'Material Icons';
        font-style: normal;
        font-weight: 400;
        src: url('/fonts/MaterialIcons-Regular.woff') format('woff2'),
            url('fonts/MaterialIcons-Regular.woff') format('woff');
    }

    .material-icons {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;
        line-height: 1;
        letter-spacing: normal;
        text-transform: none;
        display: inline-block;
        white-space: nowrap;
        direction: ltr;
        -webkit-font-feature-settings: 'liga';
        -webkit-font-smoothing: antialiased;
    }
</style>

<body>
    <div class="app">
    </div>
    <div id="autoSaveIndicator" class="auto-save-indicator">
        <span class="material-icons">check_circle</span>
        <span>Changes saved</span>
    </div>
    <script>
        paypal.HostedButtons({
            hostedButtonId: "CDAMVH4KJQPGE",
        }).render("#paypal-container-CDAMVH4KJQPGE");
    </script>
    <script>
        // PWA Installation Manager
        class PWAInstaller {
            constructor() {
                this.deferredPrompt = null;
                this.bottomSheet = null;
                this.hasShownPrompt = localStorage.getItem('pwaPromptShown') === 'true';
                this.init();
            }

            init() {
                // Check if running on HTTPS (required for PWA installation)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    console.warn('PWA installation requires HTTPS');
                    return;
                }

                // Event listeners
                window.addEventListener('beforeinstallprompt', this.handleInstallPrompt.bind(this));
                window.addEventListener('appinstalled', this.handleAppInstalled.bind(this));
                document.addEventListener('DOMContentLoaded', this.checkPWAStatus.bind(this));

                // Register Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(reg => console.log('Service Worker registered:', reg))
                        .catch(err => console.error('Service Worker registration failed:', err));
                } else {
                    console.warn('Service Worker not supported in this browser');
                }
            }

            handleInstallPrompt(e) {
                e.preventDefault();
                this.deferredPrompt = e;

                // Show bottom sheet only if not already installed and not dismissed
                if (!this.isRunningAsPWA() && !this.hasShownPrompt) {
                    this.showBottomSheet();
                }
            }

            handleAppInstalled() {
                console.log('PWA successfully installed');
                this.hideBottomSheet();
                localStorage.setItem('pwaPromptShown', 'true');
                this.deferredPrompt = null;
            }

            showBottomSheet() {
                if (this.bottomSheet) return;

                // Create bottom sheet
                this.bottomSheet = document.createElement('div');
                this.bottomSheet.id = 'pwaBottomSheet';
                this.bottomSheet.className = 'pwa-bottom-sheet';
                this.bottomSheet.setAttribute('role', 'dialog');
                this.bottomSheet.setAttribute('aria-label', 'Install App Prompt');
                this.bottomSheet.innerHTML = `
                    <div class="pwa-bottom-sheet-content">
                        <h2>Install Our App</h2>
                        <p>Enjoy a better experience by adding our app to your home screen.</p>
                        ${this.isIOS() ? `
                            <p class="ios-instructions">
                                To install, tap the <span class="material-icons">ios_share</span> Share button in Safari and select <strong>Add to Home Screen</strong>.
                            </p>
                        ` : ''}
                        <div class="pwa-bottom-sheet-actions">
                            ${!this.isIOS() ? `
                                <button id="installButton" class="pwa-install-btn">
                                    <span class="material-icons">download</span>
                                    Install App
                                </button>
                            ` : ''}
                            <button id="notNowButton" class="pwa-not-now-btn">Not Now</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(this.bottomSheet);

                // Add event listeners for buttons
                if (!this.isIOS()) {
                    const installButton = this.bottomSheet.querySelector('#installButton');
                    installButton.addEventListener('click', this.triggerInstall.bind(this));
                    installButton.focus(); // Auto-focus for accessibility
                }

                const notNowButton = this.bottomSheet.querySelector('#notNowButton');
                notNowButton.addEventListener('click', this.handleNotNow.bind(this));

                // Add keyboard navigation
                this.addKeyboardNavigation();
            }

            async triggerInstall() {
                if (!this.deferredPrompt) return;

                try {
                    const installButton = this.bottomSheet.querySelector('#installButton');
                    installButton.disabled = true;
                    this.deferredPrompt.prompt();

                    const {
                        outcome
                    } = await this.deferredPrompt.userChoice;
                    console.log(`User ${outcome} the install prompt`);
                } catch (err) {
                    console.error('Error during PWA installation:', err);
                } finally {
                    this.deferredPrompt = null;
                    this.hideBottomSheet();
                }
            }

            handleNotNow() {
                localStorage.setItem('pwaPromptShown', 'true');
                this.hasShownPrompt = true;
                this.hideBottomSheet();
            }

            hideBottomSheet() {
                if (this.bottomSheet) {
                    this.bottomSheet.classList.add('hide');
                    setTimeout(() => {
                        this.bottomSheet.remove();
                        this.bottomSheet = null;
                    }, 300); // Match CSS transition duration
                }
            }

            isRunningAsPWA() {
                return window.matchMedia('(display-mode: standalone)').matches ||
                    window.navigator.standalone === true;
            }

            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            }

            checkPWAStatus() {
                if (this.isRunningAsPWA()) {
                    console.log('App is running in standalone mode');
                    localStorage.setItem('pwaPromptShown', 'true');
                    this.hasShownPrompt = true;
                } else if (!this.hasShownPrompt && !this.isIOS()) {
                    // Wait a moment to ensure beforeinstallprompt has a chance to fire
                    setTimeout(() => {
                        if (this.deferredPrompt) {
                            this.showBottomSheet();
                        }
                    }, 1000);
                }
            }

            addKeyboardNavigation() {
                this.bottomSheet.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.handleNotNow();
                    }
                });
            }

            destroy() {
                // Cleanup event listeners
                window.removeEventListener('beforeinstallprompt', this.handleInstallPrompt.bind(this));
                window.removeEventListener('appinstalled', this.handleAppInstalled.bind(this));
                document.removeEventListener('DOMContentLoaded', this.checkPWAStatus.bind(this));
                this.hideBottomSheet();
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const installer = new PWAInstaller();

            // Optional: Cleanup on page unload
            window.addEventListener('unload', () => {
                installer.destroy();
            });
        });
    </script>
    <style>
        window.CountifyLanguage.onLanguageChange=(newLang)=> {
            // Update the app's current language state
            this.state.currentLanguage=newLang;

            // Save the new language preference
            this.saveSettings();

            // Update all UI texts
            this.updateUITexts();

            // If in voice mode, update the recognition language
            if (this.state.voiceRecognition) {
                this.state.voiceRecognition.lang=this.getVoiceRecognitionLanguage();
            }
        }

        ;
    </style>
<script>
    // Main App Class
    class CountifyApp {
        constructor() {
            this.state = {
                activities: [],
                currentActivityId: null,
                isEditing: false,
                pendingAction: null,
                activeView: 'dashboard',
                searchQuery: '',
                selectedFolder: 'all',
                theme: 'system',
                font: 'Poppins',
                textSize: 'normal',
                isSearching: false,
                showSearchResults: false,
                wattConsent: localStorage.getItem('watt-consent') === 'true',
                wattAsked: localStorage.getItem('watt-asked') === 'true',
                voiceRecognition: null,
                isVoiceModeActive: false,
                historyStack: {},
                futureStack: {},
                lastSaveTime: null,
                autoSaveInterval: null,
                currentLanguage: 'en'
            };

            this.views = ['dashboard', 'yesterday', 'deleted', 'archived', 'history'];
            this.tutorialActivities = this.getTutorialActivities();

            this.init();
        }

        getTutorialActivities() {
            if (window.CountifyLanguage) {
                const tutorial1 = window.CountifyLanguage.getTutorialContent(1);
                const tutorial2 = window.CountifyLanguage.getTutorialContent(2);
                
                return [
                    {
                        id: 'tutorial-2',
                        title: tutorial2.title,
                        content: tutorial2.content,
                        wordCount: this.countWords(tutorial2.content),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        deleted: false,
                        archived: false,
                        isTutorial: true
                    },
                    {
                        id: 'tutorial-1',
                        title: tutorial1.title,
                        content: tutorial1.content,
                        wordCount: this.countWords(tutorial1.content),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        deleted: false,
                        archived: false,
                        isTutorial: true
                    }
                ];
            }
            
            // Fallback English tutorials if language support not loaded
            return [
                {
                    id: 'tutorial-2',
                    title: 'Mastering the Countify+ Editor',
                    content: `The Countify+ editor provides a powerful yet distraction-free environment...`,
                    wordCount: 145,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    deleted: false,
                    archived: false,
                    isTutorial: true
                },
                {
                    id: 'tutorial-1',
                    title: 'Welcome to Countify+ - Your Writing Analytics Hub',
                    content: `Countify+ is your comprehensive writing analytics tool...`,
                    wordCount: 178,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    deleted: false,
                    archived: false,
                    isTutorial: true
                }
            ];
        }

        async init() {
            this.renderAppShell();
            this.setupEventListeners();
            await this.loadSettings();
            await this.loadActivities();
            this.ensureTutorialActivities();
            this.renderView();
            this.watchSystemTheme();
            this.setupRippleEffects();

            if (!this.state.wattAsked) {
                setTimeout(() => this.showWATTBanner(), 2000);
            }

            this.registerServiceWorker();
            this.initializeHistoryStack();
            this.startAutoSave();

            // Initialize language support
            if (window.CountifyLanguage) {
                window.CountifyLanguage.onLanguageChange = (newLang) => {
                    this.state.currentLanguage = newLang;
                    this.updateUITexts();
                    this.saveSettings();
                };
                this.updateUITexts();
            }
        }

        updateUITexts() {
            if (!window.CountifyLanguage) return;

            // Update all translatable elements
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                const translation = window.CountifyLanguage.getTranslation(key);
                if (translation) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translation;
                    } else {
                        el.textContent = translation;
                    }
                }
            });

            // Update select options
            const selectElements = document.querySelectorAll('select[data-translate-options]');
            selectElements.forEach(select => {
                const options = select.querySelectorAll('option');
                options.forEach(option => {
                    const key = option.getAttribute('data-translate-key');
                    if (key) {
                        const translation = window.CountifyLanguage.getTranslation(key);
                        if (translation) {
                            option.textContent = translation;
                        }
                    }
                });
            });

            // Update tutorial activities if they exist
            const tutorial1 = this.state.activities.find(a => a.id === 'tutorial-1');
            const tutorial2 = this.state.activities.find(a => a.id === 'tutorial-2');
            
            if (tutorial1) {
                const tutorialContent = window.CountifyLanguage.getTutorialContent(1);
                tutorial1.title = tutorialContent.title;
                tutorial1.content = tutorialContent.content;
                tutorial1.wordCount = this.countWords(tutorialContent.content);
            }
            
            if (tutorial2) {
                const tutorialContent = window.CountifyLanguage.getTutorialContent(2);
                tutorial2.title = tutorialContent.title;
                tutorial2.content = tutorialContent.content;
                tutorial2.wordCount = this.countWords(tutorialContent.content);
            }
        }

        initializeHistoryStack() {
            this.state.historyStack = {};
            this.state.futureStack = {};
        }

        startAutoSave() {
            if (this.state.autoSaveInterval) {
                clearInterval(this.state.autoSaveInterval);
            }

            this.state.autoSaveInterval = setInterval(() => {
                if (this.state.currentActivityId && document.getElementById('editorContent')) {
                    this.saveActivity(true);
                }
            }, 5000);
        }

        showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            if (!indicator) return;

            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('ServiceWorker registration successful');
                    }).catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        }

        ensureTutorialActivities() {
            const hasTutorial1 = this.state.activities.some(a => a.id === 'tutorial-1');
            const hasTutorial2 = this.state.activities.some(a => a.id === 'tutorial-2');

            if (!hasTutorial1) {
                this.state.activities.unshift(this.tutorialActivities[1]);
            }

            if (!hasTutorial2) {
                this.state.activities.unshift(this.tutorialActivities[0]);
            }
        }

        renderAppShell() {
            document.querySelector('.app').innerHTML = `
                <!-- Header -->
                <header class="header">
                    <button id="drawerToggle" class="btn-icon" aria-label="Open menu" style="border: none;">
                        <span class="material-icons">menu</span>
                    </button>
                    <h1 class="header-title" data-translate="app_title">
                        Countify+
                    </h1>
                    <div class="header-actions">
                        <button id="newActivityBtn" class="btn btn-primary">
                            <span class="material-icons">add</span>
                            <span class="desktop-only" data-translate="new">New</span>
                        </button>
                    </div>
                </header>

                <div class="layout-container">
                    <div id="drawerOverlay" class="drawer-overlay"></div>
                    <aside id="drawer" class="drawer">
                        ${this.renderDrawerContent()}
                    </aside>
                    <main class="main-content" id="mainContent">
                    </main>
                </div>

                <div id="editorContainer" class="editor-container">
                    ${this.renderEditorContent()}
                </div>
                <div id="confirmModal" class="modal">
                    ${this.renderModal('confirm')}
                </div>

                <div id="alertModal" class="modal">
                    ${this.renderModal('alert')}
                </div>
                <div id="contextMenu" class="context-menu">
                </div>
                <div id="voiceModeSheet" class="voice-mode-sheet">
                    ${this.renderVoiceModeSheet()}
                </div>
                <button id="fab" class="fab" aria-label="Create new activity" style="border: none;">
                    <span class="material-icons">add</span>
                </button>

                <div id="wattBanner" class="watt-banner">
                    <div class="watt-content">
                        <div class="watt-title" data-translate="privacy_tracking">Privacy & Tracking</div>  
                        <div class="watt-description" data-translate="privacy_description">
                            Countify+ processes your writing and voice locally on your device...
                        </div>
                    </div>
                    <div class="watt-actions">
                        <button id="wattDecline" class="btn btn-outline" data-translate="decline">Decline</button>
                        <button id="wattAccept" class="btn btn-primary" data-translate="i_understand">I understand</button>
                    </div>
                </div>
                <div id="autoSaveIndicator" class="auto-save-indicator" data-translate="saved">Saved</div>
            `;
        }

        renderDrawerContent() {
            return `
                <div class="drawer-header">
                    <h2 class="drawer-title" data-translate="app_title">Countify+</h2>
                    <button id="drawerClose" class="drawer-close" aria-label="Close menu">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <div class="drawer-search" style="position: relative;">
                    <div class="drawer-item" style="border: none;">
                        <span class="material-icons drawer-item-icon">search</span>
                        <input type="text" placeholder="Search activities..." 
                               style="border: none; background: none; width: 100%; color: var(--text-primary);" 
                               id="searchInput" aria-label="Search activities" data-translate-placeholder="search_placeholder">
                    </div>
                    <div id="drawerSearchResults" class="drawer-search-results">
                    </div>
                </div>

                <div class="drawer-section">
                    <div class="drawer-section-title" data-translate="views">VIEWS</div>
                    <div class="drawer-item ${this.state.activeView === 'dashboard' ? 'active' : ''}" id="dashboardView">
                        <span class="material-icons drawer-item-icon">dashboard</span>
                        <span data-translate="dashboard">Dashboard</span>
                    </div>
                    <div class="drawer-item ${this.state.activeView === 'today' ? 'active' : ''}" id="todaysActivities">
                        <span class="material-icons drawer-item-icon">today</span>
                        <span data-translate="today_activities">Today's Activities</span>
                    </div>
                    <div class="drawer-item ${this.state.activeView === 'yesterday' ? 'active' : ''}" id="yesterdaysActivities">
                        <span class="material-icons drawer-item-icon">event</span>
                        <span data-translate="yesterday_activities">Yesterday's Activities</span>
                    </div>
                    <div class="drawer-item ${this.state.activeView === 'history' ? 'active' : ''}" id="writingHistory">
                        <span class="material-icons drawer-item-icon">show_chart</span>
                        <span data-translate="writing_history">Writing History</span>
                    </div>
                </div>

                <div class="drawer-section">
                    <div class="drawer-section-title" data-translate="manage">MANAGE</div>
                    <div class="drawer-item ${this.state.activeView === 'deleted' ? 'active' : ''}" id="deletedActivities">
                        <span class="material-icons drawer-item-icon">delete</span>
                        <span data-translate="deleted_activities">Deleted Activities</span>
                    </div>
                    <div class="drawer-item ${this.state.activeView === 'archived' ? 'active' : ''}" id="archivedActivities">
                        <span class="material-icons drawer-item-icon">archive</span>
                        <span data-translate="archived_activities">Archived Activities</span>
                    </div>
                </div>

                <div class="drawer-section">
                    <div class="drawer-section-title" data-translate="settings">SETTINGS</div>
                    <div class="drawer-item" id="languageSelectorBtn">
                        <span class="material-icons drawer-item-icon">language</span>
                        <span data-translate="language">Language</span>
                        <span class="drawer-item-arrow">
                            <span class="material-icons">chevron_right</span>
                        </span>
<style>


.drawer-item-arrow {
    margin-left: auto;
    display: flex;
    align-items: center;
}
</style>
                    </div>
                    <div class="drawer-item" id="fontSelector">
                        <span class="material-icons drawer-item-icon">font_download</span>
                        <span data-translate="app_font">App Font</span>
                        <select id="fontSelect" style="margin-left: auto; border: none; background: none; color: var(--text-primary);" aria-label="Select font">
                            <option value="Poppins" ${this.state.font === 'Poppins' ? 'selected' : ''} data-translate-key="font_poppins">Poppins</option>
                            <option value="Arial" ${this.state.font === 'Arial' ? 'selected' : ''} data-translate-key="font_arial">Arial</option>
                            <option value="Helvetica" ${this.state.font === 'Helvetica' ? 'selected' : ''} data-translate-key="font_helvetica">Helvetica</option>
                            <option value="Georgia" ${this.state.font === 'Georgia' ? 'selected' : ''} data-translate-key="font_georgia">Georgia</option>
                            <option value="Times New Roman" ${this.state.font === 'Times New Roman' ? 'selected' : ''} data-translate-key="font_times">Times New Roman</option>
                            <option value="Courier New" ${this.state.font === 'Courier New' ? 'selected' : ''} data-translate-key="font_courier">Courier New</option>
                        </select>
                    </div>
<style>
#fontSelect {
    margin-left: auto;
    border: none;
    background: none;
    color: var(--text-primary);
    min-width: 70px; /* Ensure enough space for longest text */
    max-width: 70px; /* Optional: to prevent it from being too wide */
    width: auto;
    font: inherit;
    padding: 4px;
}
</style>

                    <div class="drawer-item" id="textSizeSelector">
                        <span class="material-icons drawer-item-icon">format_size</span>
                        <span data-translate="text_size">Text Size</span>
                        <select id="textSizeSelect" style="margin-left: auto; border: none; background: none; color: var(--text-primary);" aria-label="Select text size">
                            <option value="small" ${this.state.textSize === 'small' ? 'selected' : ''} data-translate-key="size_small">Small</option>
                            <option value="normal" ${this.state.textSize === 'normal' ? 'selected' : ''} data-translate-key="size_normal">Normal</option>
                            <option value="large" ${this.state.textSize === 'large' ? 'selected' : ''} data-translate-key="size_large">Large</option>
                        </select>
                    </div>
                    <div class="drawer-item" id="themeToggle">
                        <span class="material-icons drawer-item-icon">palette</span>
                        <span data-translate="app_theme">App Theme</span>
                        <select id="themeSelect" style="margin-left: auto; border: none; background: none; color: var(--text-primary);" aria-label="Select theme">
                            <option value="light" ${this.state.theme === 'light' ? 'selected' : ''} data-translate-key="theme_light">Light</option>
                            <option value="dark" ${this.state.theme === 'dark' ? 'selected' : ''} data-translate-key="theme_dark">Dark</option>
                            <option value="system" ${this.state.theme === 'system' ? 'selected' : ''} data-translate-key="theme_system">System</option>
                        </select>
                    </div>
                </div>



                <div class="drawer-section" style="text-decoration: none;">
                    <div class="drawer-section-title" data-translate="about">ABOUT</div>
                    <a style="text-decoration: none; color: var(--text-secondary); background: rgba(255, 185, 185, 0.6); " class="drawer-item" href="/functions/donation.html" target="_blank" rel="noopener noreferrer">
                        <span class="material-icons drawer-item-icon" style="color: #FF4668;">favorite</span>
                        <span style="font-weight: bold;">Support app</span>
                    </a>
                    <a style="text-decoration: none; color: var(--text-secondary); " class="drawer-item" href="/docs/privacy.html" target="_blank" rel="noopener noreferrer">
                        <span class="material-icons drawer-item-icon">lock</span>
                        <span data-translate="privacy_policy">Privacy Policy</span>
                    </a>
                    <a style="text-decoration: none; color: var(--text-secondary);" class="drawer-item" href="/docs/terms.html" target="_blank" rel="noopener noreferrer">
                        <span class="material-icons drawer-item-icon">description</span>
                        <span data-translate="terms_service">Terms of Service</span>
                    </a>
                    <div class="drawer-item">
                        <span class="material-icons drawer-item-icon"><img style="width: 100%; height: 100%;"src="/logo/countify.svg"></span>
                        <span data-translate="version">Version</span> 2.1.0
                    </div>
                    <div class="drawer-item">
                        <span class="material-icons drawer-item-icon">info</span>
                        Â© landecs 2025
                    </div>
                </div>
            `;
        }

        renderEditorContent() {
            return `
                <div class="editor-header">
                    <div class="editor-header-left">
                        <button id="editorBack" class="editor-back-btn" style="border: 2px solid #919191; border-radius: 20px;">
                            <span class="material-icons">arrow_back</span>
                            <span data-translate="back">Back</span>
                        </button>
                    </div>

                    <div class="editor-header-right">
                        <div class="editor-actions">
                            <div class="undo-redo-container">
                                <button id="undoBtn" class="undo-redo-btn" disabled>
                                    <span class="material-icons">undo</span>
                                </button>
                                <button id="redoBtn" class="undo-redo-btn" disabled>
                                    <span class="material-icons">redo</span>
                                </button>
                            </div>
                            <button id="editorSave" class="btn btn-primary" aria-label="Save activity" style="border-radius: 20px;">
                                <span class="desktop-only" data-translate="save">Save</span>
                            </button>
                            <button id="editorDelete" class="btn btn-icon" aria-label="Delete activity" 
                                    style="background-color: rgba(255, 46, 69, 0.1); 
                                           border: 1px solid #FF8B8B; 
                                           color: #FF2E45;">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="editor-header-center" style="margin: 20px;">
                    <input type="text" id="editorTitle" class="editor-title" placeholder="Untitled" aria-label="Activity title" style="margin: 10px;">
                </div>
                <div class="editor-content-container">
                    <div class="editor-analytics glass">
                        <div class="analytics-item">
                            <div class="analytics-value" id="wordCount">0</div>
                            <div class="analytics-label" data-translate="words">Words</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="charCount">0</div>
                            <div class="analytics-label" data-translate="characters">Characters</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="charNoSpacesCount">0</div>
                            <div class="analytics-label" data-translate="chars_no_spaces">Chars (no spaces)</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="sentenceCount">0</div>
                            <div class="analytics-label" data-translate="sentences">Sentences</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="paragraphCount">0</div>
                            <div class="analytics-label" data-translate="paragraphs">Paragraphs</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="readingTime">0</div>
                            <div class="analytics-label" data-translate="reading_time">Reading Time</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-value" id="speakingTime">0</div>
                            <div class="analytics-label" data-translate="speaking_time">Speaking Time</div>
                        </div>
                    </div>
                    <textarea id="editorContent" class="editor-content glass" placeholder="Start typing here..." aria-label="Activity content" data-translate-placeholder="start_typing"></textarea>
                </div>

                <div class="editor-footer">
                    <button id="voiceInputBtn" class="btn btn-icon" title="Voice input" aria-label="Voice input" 
                            style="background-color: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.3);">
                        <span class="material-icons">mic</span>
                    </button>
                    <p style="margin: 40px; font-size: 12px; text-align: center; color: #e53935;" data-translate="predictive_results">Some results are predictive and for reference only.</p>
                    <button id="clearEditorBtn" class="btn btn-icon" title="Clear text" aria-label="Clear text"
                            style="background-color: rgba(244, 67, 54, 0.2); border: 1px solid rgba(244, 67, 54, 0.3);">
                        <span class="material-icons">clear</span>
                    </button>
                </div>
            `;
        }

        renderVoiceModeSheet() {
            return `
                <div class="voice-mode-sheet-content">
                    <div class="voice-mode-header">
                        <h3 data-translate="voice_mode">Voice Mode</h3>
                        <button id="closeVoiceMode" class="btn btn-icon">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="voice-visualizer">
                        <div class="voice-bar" id="voiceBar1"></div>
                        <div class="voice-bar" id="voiceBar2"></div>
                        <div class="voice-bar" id="voiceBar3"></div>
                        <div class="voice-bar" id="voiceBar4"></div>
                        <div class="voice-bar" id="voiceBar5"></div>
                    </div>
                    <div class="voice-caption" id="voiceCaption"></div>
                    <div class="voice-controls">
                        <button id="voiceStart" class="btn btn-primary">
                            <span class="material-icons">mic</span>
                            <span data-translate="start">Start</span>
                        </button>
                        <button id="voicePause" class="btn btn-outline" disabled>
                            <span class="material-icons">pause</span>
                            <span data-translate="pause">Pause</span>
                        </button>
                        <button id="voiceStop" class="btn btn-outline" disabled>
                            <span class="material-icons">stop</span>
                            <span data-translate="stop">Stop</span>
                        </button>
                        <button id="voiceSpace" class="btn btn-outline">
                            <span class="material-icons">space_bar</span>
                            <span data-translate="space">Space</span>
                        </button>
                    </div>
                </div>
            `;
        }

        renderModal(type) {
            if (type === 'confirm') {
                return `
                <div class="modal-content glass">
                    <h3 class="modal-title" id="confirmModalTitle" data-translate="confirm_action">Confirm Action</h3>
                    <p class="modal-message" id="confirmModalMessage" data-translate="confirm_message">Are you sure you want to perform this action?</p>
                    <div class="modal-actions">
                        <button id="confirmModalCancel" class="btn btn-outline" data-translate="cancel">Cancel</button>
                        <button id="confirmModalConfirm" class="btn btn-primary" data-translate="confirm">Confirm</button>
                    </div>
                </div>
            `;
            } else {
                return `
                <div class="modal-content glass">
                    <h3 class="modal-title" id="alertModalTitle" data-translate="alert">Alert</h3>
                    <p class="modal-message" id="alertModalMessage" data-translate="alert_message">This is an alert message.</p>
                    <div class="modal-actions">
                        <button id="alertModalOk" class="btn btn-primary" data-translate="ok">OK</button>
                    </div>
                    </div>
                `;
            }
        }

        renderView() {
            const mainContent = document.getElementById('mainContent');
            if (!mainContent) return;

            if (this.state.isSearching) {
                mainContent.innerHTML = this.renderSearchResults();
                return;
            }

            switch (this.state.activeView) {
                case 'dashboard':
                    mainContent.innerHTML = this.renderDashboard();
                    break;
                case 'today':
                    mainContent.innerHTML = this.renderActivitiesView('today');
                    break;
                case 'yesterday':
                    mainContent.innerHTML = this.renderActivitiesView('yesterday');
                    break;
                case 'deleted':
                    mainContent.innerHTML = this.renderActivitiesView('deleted');
                    break;
                case 'archived':
                    mainContent.innerHTML = this.renderActivitiesView('archived');
                    break;
                case 'history':
                    mainContent.innerHTML = this.renderHistoryView();
                    break;
                default:
                    mainContent.innerHTML = this.renderDashboard();
            }
        }

        renderDashboard() {
            const filteredActivities = this.filterActivities();
            const activitiesToShow = filteredActivities.slice(0, 5);

            if (activitiesToShow.length === 0) {
                return `
                <h2 class="page-title" data-translate="dashboard">Dashboard</h2>
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <span class="material-icons" style="font-size: 4rem;">calculate</span>
                    </div>
                    <h3 class="empty-state-title" data-translate="no_activities">No Activities Yet</h3>
                    <p class="empty-state-description" data-translate="create_first_activity">Click the "+" button to create your first word count activity.</p>
                    <button id="createFirstActivity" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        <span data-translate="create_activity">Create Activity</span>
                    </button>
                </div>
            `;
            }

            let cardsHTML = '';
            activitiesToShow.forEach((activity, index) => {
                const previewText = activity.content.length > 100 ?
                    activity.content.substring(0, 100) + '...' :
                    activity.content;

                const cardColorClass = `card-color-${(index % 5) + 1}`;
                const animationDelay = `delay-${index * 100}`;

                cardsHTML += `
                <div class="activity-card glass ${cardColorClass} animate-slide ${animationDelay}" data-id="${activity.id}" tabindex="0" aria-label="${activity.title}, ${this.countWords(activity.content)} words, last updated ${this.formatDate(activity.updatedAt)}">
                    <div>
                        <h3 class="activity-card-title">${activity.title}</h3>
                        <p class="activity-card-preview">${previewText}</p>
                    </div>
                    <div class="activity-card-meta">
                        <span>${this.formatDate(activity.updatedAt)}</span>
                        <span class="activity-card-wordcount">${this.countWords(activity.content)} <span data-translate="words">words</span></span>
                    </div>
                </div>
            `;
            });

            return `
            <h2 class="page-title" data-translate="dashboard">Dashboard</h2>
            <div class="dashboard-grid">
                ${cardsHTML}
            </div>
        `;
        }

        renderHistoryView() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const recentActivities = this.state.activities.filter(activity => {
                const activityDate = new Date(activity.updatedAt);
                return activityDate >= oneWeekAgo && !activity.deleted && !activity.archived;
            });

            const wordsByDate = {};
            recentActivities.forEach(activity => {
                const date = new Date(activity.updatedAt).toDateString();
                if (!wordsByDate[date]) {
                    wordsByDate[date] = 0;
                }
                wordsByDate[date] += this.countWords(activity.content);
            });

            const dates = [];
            const wordCounts = [];
            const maxWords = Math.max(...Object.values(wordsByDate), 0) || 1;

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                dates.push(dateStr);
                wordCounts.push(wordsByDate[dateStr] || 0);
            }

            let barsHTML = '';
            dates.forEach((date, index) => {
                const height = (wordCounts[index] / maxWords) * 100;
                barsHTML += `
                <div class="history-bar" style="height: ${height}%" data-count="${wordCounts[index]} words">
                    <div class="history-date">${new Date(date).toLocaleDateString(this.state.currentLanguage, { month: 'short', day: 'numeric' })}</div>
                </div>
            `;
            });

            return `
            <h2 class="page-title" data-translate="writing_history">Writing History</h2>
            <div class="history-graph-container" style="height: 90%;">
                <div class="history-graph" style="height: 200px;">
                    ${barsHTML}
                </div>
                <div class="history-stats">
                    <div class="stat-item">
                        <span class="stat-value">${this.getTotalWordsLast7Days()}</span>
                        <span class="stat-label" data-translate="total_words_week">Total words this week</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${this.getAverageWordsPerDay()}</span>
                        <span class="stat-label" data-translate="avg_per_day">Average per day</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" style="font-size: 2rem;">${this.getMostProductiveDay()}</span>
                        <span class="stat-label" data-translate="most_productive_day">Most productive day</span>
                    </div>
                </div>
            </div>
        `;
        }

        getTotalWordsLast7Days() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const recentActivities = this.state.activities.filter(activity => {
                const activityDate = new Date(activity.updatedAt);
                return activityDate >= oneWeekAgo && !activity.deleted && !activity.archived;
            });

            return recentActivities.reduce((total, activity) => total + this.countWords(activity.content), 0);
        }

        getAverageWordsPerDay() {
            const total = this.getTotalWordsLast7Days();
            return Math.round(total / 7);
        }

        getMostProductiveDay() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const wordsByDay = {};
            this.state.activities.forEach(activity => {
                const activityDate = new Date(activity.updatedAt);
                if (activityDate >= oneWeekAgo && !activity.deleted && !activity.archived) {
                    const day = activityDate.toLocaleDateString(this.state.currentLanguage, {
                        weekday: 'long'
                    });
                    wordsByDay[day] = (wordsByDay[day] || 0) + this.countWords(activity.content);
                }
            });

            let maxDay = '';
            let maxWords = 0;

            for (const day in wordsByDay) {
                if (wordsByDay[day] > maxWords) {
                    maxWords = wordsByDay[day];
                    maxDay = day;
                }
            }

            return maxDay || 'N/A';
        }

        renderActivitiesView(viewType) {
            let title = '';
            let activities = [];

            switch (viewType) {
                case 'today':
                    title = "today_activities";
                    activities = this.getTodaysActivities();
                    break;
                case 'yesterday':
                    title = "yesterday_activities";
                    activities = this.getYesterdaysActivities();
                    break;
                case 'deleted':
                    title = "deleted_activities";
                    activities = this.state.activities.filter(a => a.deleted);
                    break;
                case 'archived':
                    title = "archived_activities";
                    activities = this.state.activities.filter(a => a.archived);
                    break;
            }

            if (activities.length === 0) {
                let message = '';
                let icon = 'info';
                let messageKey = '';
                let buttonKey = '';

                if (viewType === 'today') {
                    messageKey = "no_today_activities";
                    icon = "today";
                    buttonKey = "create_today_activity";
                } else if (viewType === 'yesterday') {
                    messageKey = "no_yesterday_activities";
                    icon = "event";
                } else if (viewType === 'deleted') {
                    messageKey = "no_deleted_activities";
                    icon = "delete";
                } else if (viewType === 'archived') {
                    messageKey = "no_archived_activities";
                    icon = "archive";
                }

                return `
                <h2 class="page-title" data-translate="${title}">${window.CountifyLanguage?.getTranslation(title) || title}</h2>
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <span class="material-icons" style="font-size: 4rem;">${icon}</span>
                    </div>
                    <h3 class="empty-state-title" data-translate="no_activities_found">No Activities Found</h3>
                    <p class="empty-state-description" data-translate="${messageKey}">${window.CountifyLanguage?.getTranslation(messageKey) || messageKey}</p>
                    ${viewType === 'today' ? `
                        <button id="createTodayActivity" class="btn btn-primary">
                            <span class="material-icons">add</span>
                            <span data-translate="${buttonKey}">${window.CountifyLanguage?.getTranslation(buttonKey) || buttonKey}</span>
                        </button>
                    ` : ''}
                </div>
            `;
            }

            let cardsHTML = '';
            activities.forEach((activity, index) => {
                const previewText = activity.content.length > 100 ?
                    activity.content.substring(0, 100) + '...' :
                    activity.content;

                const cardColorClass = `card-color-${(index % 5) + 1}`;
                const animationDelay = `delay-${index * 100}`;

                cardsHTML += `
                <div class="activity-card glass ${cardColorClass} animate-slide ${animationDelay}" data-id="${activity.id}" tabindex="0" aria-label="${activity.title}, ${this.countWords(activity.content)} words, last updated ${this.formatDate(activity.updatedAt)}">
                    <div>
                        <h3 class="activity-card-title">${activity.title}</h3>
                        <p class="activity-card-preview">${previewText}</p>
                    </div>
                    <div class="activity-card-meta">
                        <span>${this.formatDate(activity.updatedAt)}</span>
                        <span class="activity-card-wordcount">${this.countWords(activity.content)} <span data-translate="words">words</span></span>
                    </div>
                </div>
            `;
            });

            return `
            <h2 class="page-title" data-translate="${title}">${window.CountifyLanguage?.getTranslation(title) || title}</h2>
            <div class="dashboard-grid">
                ${cardsHTML}
            </div>
        `;
        }

        renderSearchResults() {
            const filteredActivities = this.filterActivities();

            if (filteredActivities.length === 0) {
                return `
                <div class="search-results-header">
                    <h2 class="page-title" data-translate="search_results">Search Results</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <span class="material-icons">search_off</span>
                    </div>
                    <h3 class="empty-state-title" data-translate="no_results">No Results Found</h3>
                    <p class="empty-state-description" data-translate="no_match_query">No activities match your search for "${this.state.searchQuery}"</p>
                </div>
            `;
            }

            let cardsHTML = '';
            filteredActivities.forEach((activity, index) => {
                const previewText = activity.content.length > 100 ?
                    activity.content.substring(0, 100) + '...' :
                    activity.content;

                const cardColorClass = `card-color-${(index % 5) + 1}`;
                const animationDelay = `delay-${index * 100}`;

                cardsHTML += `
                <div class="activity-card glass ${cardColorClass} animate-slide ${animationDelay}" data-id="${activity.id}" tabindex="0" aria-label="${activity.title}, ${this.countWords(activity.content)} words, last updated ${this.formatDate(activity.updatedAt)}">
                    <div>
                        <h3 class="activity-card-title">${activity.title}</h3>
                        <p class="activity-card-preview">${previewText}</p>
                    </div>
                    <div class="activity-card-meta">
                        <span>${this.formatDate(activity.updatedAt)}</span>
                        <span class="activity-card-wordcount">${this.countWords(activity.content)} <span data-translate="words">words</span></span>
                    </div>
                </div>
            `;
            });

            return `
            <div class="search-results-header">
                <h2 class="page-title" data-translate="search_results">Search Results</h2>
                <div class="search-results-count">${filteredActivities.length} <span data-translate="results_for">results for</span> <span class="search-query">"${this.state.searchQuery}"</span></div>
            </div>
            <div class="dashboard-grid">
                ${cardsHTML}
            </div>
        `;
        }

        renderSearchResultsInDrawer() {
            const filteredActivities = this.filterActivities();
            const resultsContainer = document.getElementById('drawerSearchResults');
            if (!resultsContainer) return;

            if (filteredActivities.length === 0) {
                resultsContainer.innerHTML = `
                <div class="drawer-search-result-item">
                    <span data-translate="no_results_found">No results found for</span> "${this.state.searchQuery}"
                </div>
            `;
                resultsContainer.classList.add('show');
                return;
            }

            let resultsHTML = '';
            filteredActivities.slice(0, 5).forEach(activity => {
                const previewText = activity.content.length > 50 ?
                    activity.content.substring(0, 50) + '...' :
                    activity.content;

                resultsHTML += `
                <div class="drawer-search-result-item" data-id="${activity.id}">
                    <div class="drawer-search-result-title">${activity.title}</div>
                    <div class="drawer-search-result-preview">${previewText}</div>
                </div>
            `;
            });

            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.classList.add('show');

            resultsContainer.querySelectorAll('.drawer-search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    this.openEditor(item.dataset.id);
                    this.toggleDrawer();
                    resultsContainer.classList.remove('show');
                    document.getElementById('searchInput').value = '';
                    this.state.searchQuery = '';
                });
            });
        }

        setupEventListeners() {
            // Drawer toggle
            document.getElementById('drawerToggle')?.addEventListener('click', () => this.toggleDrawer());
            document.getElementById('drawerClose')?.addEventListener('click', () => this.toggleDrawer());
            document.getElementById('drawerOverlay')?.addEventListener('click', () => this.toggleDrawer());

            // Navigation items
            document.getElementById('dashboardView')?.addEventListener('click', () => {
                this.state.activeView = 'dashboard';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            document.getElementById('todaysActivities')?.addEventListener('click', () => {
                this.state.activeView = 'today';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            document.getElementById('yesterdaysActivities')?.addEventListener('click', () => {
                this.state.activeView = 'yesterday';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            document.getElementById('writingHistory')?.addEventListener('click', () => {
                this.state.activeView = 'history';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            document.getElementById('deletedActivities')?.addEventListener('click', () => {
                this.state.activeView = 'deleted';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            document.getElementById('archivedActivities')?.addEventListener('click', () => {
                this.state.activeView = 'archived';
                this.state.isSearching = false;
                this.renderView();
                this.toggleDrawer();
            });

            // Language selector
            document.getElementById('languageSelectorBtn')?.addEventListener('click', () => {
                if (window.CountifyLanguage && window.CountifyLanguage.showLanguageSelector) {
                    window.CountifyLanguage.showLanguageSelector();
                }
            });

            // New activity
            document.getElementById('newActivityBtn')?.addEventListener('click', () => this.openEditor());
            document.getElementById('fab')?.addEventListener('click', () => this.openEditor());

            // Search input
            const searchInput = document.getElementById('searchInput');
            searchInput?.addEventListener('input', (e) => {
                this.state.searchQuery = e.target.value.toLowerCase();
                this.state.isSearching = this.state.searchQuery.length > 0;

                if (this.state.searchQuery.length > 0) {
                    this.renderSearchResultsInDrawer();
                } else {
                    document.getElementById('drawerSearchResults')?.classList.remove('show');
                }
            });

            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.drawer-search') && !e.target.closest('#drawerSearchResults')) {
                    document.getElementById('drawerSearchResults')?.classList.remove('show');
                }
            });

            // Editor events
            document.getElementById('editorBack')?.addEventListener('click', () => {
                this.closeEditor();
            });

            document.getElementById('editorSave')?.addEventListener('click', () => {
                this.saveActivity(false, true);
                this.closeEditor();
            });

            document.getElementById('editorDelete')?.addEventListener('click', () => {
                const activity = this.state.activities.find(a => a.id === this.state.currentActivityId);
                if (activity && activity.isTutorial) {
                    this.showAlert(
                        window.CountifyLanguage?.getTranslation('cannot_delete') || 'Cannot Delete',
                        window.CountifyLanguage?.getTranslation('cannot_delete_message') || 'This is a tutorial activity and cannot be deleted.'
                    );
                    return;
                }

                this.showConfirmModal(
                    window.CountifyLanguage?.getTranslation('delete_activity') || 'Delete Activity',
                    window.CountifyLanguage?.getTranslation('delete_confirm') || 'Are you sure you want to delete this activity? This action cannot be undone.',
                    () => {
                        this.deleteActivity(this.state.currentActivityId);
                        this.closeEditor();
                    }
                );
            });

            // Real-time updates for editor content
            const editorContent = document.getElementById('editorContent');
            if (editorContent) {
                editorContent.addEventListener('input', () => {
                    this.updateTextAnalytics();
                    this.pushToHistoryStack();
                });

                editorContent.addEventListener('paste', () => {
                    setTimeout(() => {
                        this.updateTextAnalytics();
                        this.pushToHistoryStack();
                    }, 10);
                });
            }

            document.getElementById('clearEditorBtn')?.addEventListener('click', () => {
                this.showConfirmModal(
                    window.CountifyLanguage?.getTranslation('clear_text') || 'Clear Text',
                    window.CountifyLanguage?.getTranslation('clear_text_confirm') || 'Are you sure you want to clear all text? This action cannot be undone.',
                    () => {
                        document.getElementById('editorContent').value = '';
                        this.updateTextAnalytics();
                        this.pushToHistoryStack();
                    }
                );
            });

            // Undo/Redo buttons
            document.getElementById('undoBtn')?.addEventListener('click', () => this.undo());
            document.getElementById('redoBtn')?.addEventListener('click', () => this.redo());

            // Voice input
            document.getElementById('voiceInputBtn')?.addEventListener('click', () => {
                if (!this.state.wattConsent) {
                    this.showWATTBanner();
                    return;
                }
                this.toggleVoiceMode();
            });

            // Voice mode controls
            document.getElementById('voiceStart')?.addEventListener('click', () => this.startVoiceInput());
            document.getElementById('voicePause')?.addEventListener('click', () => this.toggleVoicePause());
            document.getElementById('voiceStop')?.addEventListener('click', () => this.stopVoiceInput());
            document.getElementById('voiceSpace')?.addEventListener('click', () => this.insertSpace());
            document.getElementById('closeVoiceMode')?.addEventListener('click', () => this.closeVoiceMode());

            // Modal events
            document.getElementById('confirmModalCancel')?.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('modal-open');
            });

            document.getElementById('confirmModalConfirm')?.addEventListener('click', () => {
                if (this.state.pendingAction) {
                    this.state.pendingAction();
                    this.state.pendingAction = null;
                }
                document.getElementById('confirmModal').classList.remove('modal-open');
            });

            document.getElementById('alertModalOk')?.addEventListener('click', () => {
                document.getElementById('alertModal').classList.remove('modal-open');
            });

            // Settings changes
            document.getElementById('themeSelect')?.addEventListener('change', (e) => {
                this.state.theme = e.target.value;
                this.applyTheme(this.state.theme);
                this.saveSettings();
            });

            document.getElementById('fontSelect')?.addEventListener('change', (e) => {
                this.state.font = e.target.value;
                this.applyFont(this.state.font);
                this.saveSettings();
            });

            document.getElementById('textSizeSelect')?.addEventListener('change', (e) => {
                this.state.textSize = e.target.value;
                this.applyTextSize(this.state.textSize);
                this.saveSettings();
            });

            // Empty state buttons
            document.addEventListener('click', (e) => {
                if (e.target.id === 'createFirstActivity' || e.target.closest('#createFirstActivity')) {
                    this.openEditor();
                }

                if (e.target.id === 'createTodayActivity' || e.target.closest('#createTodayActivity')) {
                    this.openEditor();
                }
            });

            // Activity card clicks
            document.addEventListener('click', (e) => {
                const activityCard = e.target.closest('.activity-card');
                if (activityCard) {
                    const activity = this.state.activities.find(a => a.id === activityCard.dataset.id);
                    if (activity) {
                        if (activity.archived) {
                            this.showConfirmModal(
                                window.CountifyLanguage?.getTranslation('unarchive_activity') || 'Unarchive Activity',
                                window.CountifyLanguage?.getTranslation('unarchive_confirm') || 'This activity is archived. Do you want to unarchive it to edit?',
                                () => {
                                    activity.archived = false;
                                    this.saveActivities();
                                    this.openEditor(activity.id);
                                }
                            );
                        } else {
                            this.openEditor(activityCard.dataset.id);
                        }
                    }
                }
            });

            // Activity card keyboard navigation
            document.addEventListener('keydown', (e) => {
                const activityCard = document.activeElement.closest('.activity-card');
                if (activityCard && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    this.openEditor(activityCard.dataset.id);
                }
            });

            // Context menu for activity cards
            document.addEventListener('contextmenu', (e) => {
                const activityCard = e.target.closest('.activity-card');
                if (activityCard) {
                    e.preventDefault();
                    const activity = this.state.activities.find(a => a.id === activityCard.dataset.id);
                    if (activity) {
                        this.showActivityOptions(activityCard.dataset.id, e.clientX, e.clientY);
                    }
                }
            });

            // Close context menu on click outside
            document.addEventListener('click', () => {
                this.hideContextMenu();
            });

            // WATT banner events
            document.getElementById('wattAccept')?.addEventListener('click', () => {
                this.state.wattConsent = true;
                this.state.wattAsked = true;
                localStorage.setItem('watt-consent', 'true');
                localStorage.setItem('watt-asked', 'true');
                document.getElementById('wattBanner').classList.remove('show');
            });

            document.getElementById('wattDecline')?.addEventListener('click', () => {
                this.state.wattConsent = false;
                this.state.wattAsked = true;
                localStorage.setItem('watt-consent', 'false');
                localStorage.setItem('watt-asked', 'true');
                document.getElementById('wattBanner').classList.remove('show');
            });

            // Keyboard shortcuts for undo/redo
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        this.undo();
                    } else if ((e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        this.redo();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        this.saveActivity(false, true);
                        this.closeEditor();
                    }
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    document.getElementById('drawer').classList.remove('drawer-open');
                    document.getElementById('drawerOverlay').classList.remove('drawer-overlay-visible');
                }
            });

            // Close voice mode when clicking outside
            document.addEventListener('click', (e) => {
                if (this.state.isVoiceModeActive &&
                    !e.target.closest('#voiceModeSheet') &&
                    !e.target.closest('#voiceInputBtn')) {
                    this.closeVoiceMode();
                }
            });
        }

        pushToHistoryStack() {
            if (!this.state.currentActivityId) return;

            const editorContent = document.getElementById('editorContent');
            const editorTitle = document.getElementById('editorTitle');
            if (!editorContent || !editorTitle) return;

            const currentContent = editorContent.value;
            const currentTitle = editorTitle.value;

            if (!this.state.historyStack[this.state.currentActivityId]) {
                this.state.historyStack[this.state.currentActivityId] = [];
                this.state.futureStack[this.state.currentActivityId] = [];
            }

            const lastHistory = this.state.historyStack[this.state.currentActivityId][0];
            if (lastHistory && lastHistory.content === currentContent && lastHistory.title === currentTitle) {
                return;
            }

            this.state.historyStack[this.state.currentActivityId].unshift({
                content: currentContent,
                title: currentTitle,
                timestamp: Date.now()
            });

            this.state.futureStack[this.state.currentActivityId] = [];

            if (this.state.historyStack[this.state.currentActivityId].length > 50) {
                this.state.historyStack[this.state.currentActivityId].pop();
            }

            this.updateUndoRedoButtons();
        }

        undo() {
            if (!this.state.currentActivityId ||
                !this.state.historyStack[this.state.currentActivityId] ||
                this.state.historyStack[this.state.currentActivityId].length < 2) {
                return;
            }

            const currentState = this.state.historyStack[this.state.currentActivityId].shift();
            const previousState = this.state.historyStack[this.state.currentActivityId][0];

            this.state.futureStack[this.state.currentActivityId].unshift(currentState);

            document.getElementById('editorContent').value = previousState.content;
            document.getElementById('editorTitle').value = previousState.title;
            this.updateTextAnalytics();

            this.updateUndoRedoButtons();
        }

        redo() {
            if (!this.state.currentActivityId ||
                !this.state.futureStack[this.state.currentActivityId] ||
                this.state.futureStack[this.state.currentActivityId].length === 0) {
                return;
            }

            const nextState = this.state.futureStack[this.state.currentActivityId].shift();

            const currentContent = document.getElementById('editorContent').value;
            const currentTitle = document.getElementById('editorTitle').value;
            this.state.historyStack[this.state.currentActivityId].unshift({
                content: currentContent,
                title: currentTitle,
                timestamp: Date.now()
            });

            document.getElementById('editorContent').value = nextState.content;
            document.getElementById('editorTitle').value = nextState.title;
            this.updateTextAnalytics();

            this.updateUndoRedoButtons();
        }

        updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (!this.state.currentActivityId || !undoBtn || !redoBtn) {
                return;
            }

            const hasUndo = this.state.historyStack[this.state.currentActivityId] &&
                this.state.historyStack[this.state.currentActivityId].length > 1;
            const hasRedo = this.state.futureStack[this.state.currentActivityId] &&
                this.state.futureStack[this.state.currentActivityId].length > 0;

            undoBtn.disabled = !hasUndo;
            redoBtn.disabled = !hasRedo;
        }

        toggleVoiceMode() {
            if (!this.state.isVoiceModeActive) {
                this.openVoiceMode();
            } else {
                this.closeVoiceMode();
            }
        }

        openVoiceMode() {
            this.state.isVoiceModeActive = true;
            document.getElementById('voiceModeSheet').classList.add('open');
            document.getElementById('voiceStart').focus();
        }

        closeVoiceMode() {
            this.state.isVoiceModeActive = false;
            document.getElementById('voiceModeSheet').classList.remove('open');
            this.stopVoiceInput();
        }

        startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                this.showAlert(
                    window.CountifyLanguage?.getTranslation('voice_input_error') || 'Voice Input Error',
                    'Voice input is not supported in your browser.'
                );
                return;
            }

            if (this.state.voiceRecognition) {
                return;
            }

            const recognition = new webkitSpeechRecognition();
            this.state.voiceRecognition = recognition;
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = window.CountifyLanguage?.getLanguageCode(this.state.currentLanguage) || 'en-US';

            recognition.onstart = () => {
                document.getElementById('voiceStart').disabled = true;
                document.getElementById('voicePause').disabled = false;
                document.getElementById('voiceStop').disabled = false;
                document.getElementById('voiceInputBtn').innerHTML = '<span class="material-icons">mic_off</span>';
                document.getElementById('voiceInputBtn').style.color = 'var(--error)';
                this.startVoiceVisualizer();
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                document.getElementById('voiceCaption').textContent = interimTranscript || finalTranscript;

                if (finalTranscript) {
                    const editor = document.getElementById('editorContent');
                    editor.value += (editor.value ? ' ' : '') + finalTranscript;
                    this.updateTextAnalytics();
                    this.pushToHistoryStack();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                this.stopVoiceInput();
                this.showAlert(
                    window.CountifyLanguage?.getTranslation('voice_input_error') || 'Voice Input Error',
                    `An error occurred: ${event.error}`
                );
            };

            recognition.onend = () => {
                if (this.state.voiceRecognition) {
                    // Only restart if we didn't explicitly stop it
                    this.state.voiceRecognition.start();
                }
            };

            recognition.start();
        }

        toggleVoicePause() {
            if (!this.state.voiceRecognition) return;

            const pauseBtn = document.getElementById('voicePause');
            if (pauseBtn.textContent.includes(window.CountifyLanguage?.getTranslation('pause') || 'Pause')) {
                this.state.voiceRecognition.stop();
                pauseBtn.innerHTML = `<span class="material-icons">play_arrow</span> <span data-translate="continue">Continue</span>`;
                this.stopVoiceVisualizer();
            } else {
                this.state.voiceRecognition.start();
                pauseBtn.innerHTML = `<span class="material-icons">pause</span> <span data-translate="pause">Pause</span>`;
                this.startVoiceVisualizer();
            }
        }

        stopVoiceInput() {
            if (!this.state.voiceRecognition) return;

            this.state.voiceRecognition.stop();
            this.state.voiceRecognition = null;

            document.getElementById('voiceStart').disabled = false;
            document.getElementById('voicePause').disabled = true;
            document.getElementById('voiceStop').disabled = true;
            document.getElementById('voicePause').innerHTML = `<span class="material-icons">pause</span> <span data-translate="pause">Pause</span>`;
            document.getElementById('voiceInputBtn').innerHTML = '<span class="material-icons">mic</span>';
            document.getElementById('voiceInputBtn').style.color = '';
            document.getElementById('voiceCaption').textContent = '';

            this.stopVoiceVisualizer();
        }

        insertSpace() {
            const editor = document.getElementById('editorContent');
            editor.value += ' ';
            editor.focus();
            this.updateTextAnalytics();
            this.pushToHistoryStack();
        }

        startVoiceVisualizer() {
            this.stopVoiceVisualizer();

            const visualizerBars = [
                document.getElementById('voiceBar1'),
                document.getElementById('voiceBar2'),
                document.getElementById('voiceBar3'),
                document.getElementById('voiceBar4'),
                document.getElementById('voiceBar5')
            ];

            this.state.visualizerInterval = setInterval(() => {
                visualizerBars.forEach(bar => {
                    const height = Math.floor(Math.random() * 30) + 5;
                    bar.style.height = `${height}px`;
                });
            }, 100);
        }

        stopVoiceVisualizer() {
            if (this.state.visualizerInterval) {
                clearInterval(this.state.visualizerInterval);
                this.state.visualizerInterval = null;

                const visualizerBars = [
                    document.getElementById('voiceBar1'),
                    document.getElementById('voiceBar2'),
                    document.getElementById('voiceBar3'),
                    document.getElementById('voiceBar4'),
                    document.getElementById('voiceBar5')
                ];

                visualizerBars.forEach(bar => {
                    bar.style.height = '5px';
                });
            }
        }

        showWATTBanner() {
            if (!this.state.wattAsked) {
                document.getElementById('wattBanner')?.classList.add('show');
            }
        }

        setupRippleEffects() {
            document.addEventListener('click', function(e) {
                const target = e.target.closest('.btn, .btn-icon, .activity-card, .fab');
                if (target) {
                    const rect = target.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;

                    target.appendChild(ripple);

                    ripple.addEventListener('animationend', () => {
                        ripple.remove();
                    });
                }
            });
        }

        toggleDrawer() {
            document.getElementById('drawer')?.classList.toggle('drawer-open');
            document.getElementById('drawerOverlay')?.classList.toggle('drawer-overlay-visible');
            document.getElementById('drawerSearchResults')?.classList.remove('show');
        }

        async loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('countify-settings')) || {};

                if (settings.theme) {
                    this.state.theme = settings.theme;
                    this.applyTheme(settings.theme);
                }

                if (settings.font) {
                    this.state.font = settings.font;
                    this.applyFont(settings.font);
                }

                if (settings.textSize) {
                    this.state.textSize = settings.textSize;
                    this.applyTextSize(settings.textSize);
                }

                if (settings.language) {
                    this.state.currentLanguage = settings.language;
                    if (window.CountifyLanguage) {
                        window.CountifyLanguage.setCurrentLanguage(settings.language);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async saveSettings() {
            try {
                const settings = {
                    theme: this.state.theme,
                    font: this.state.font,
                    textSize: this.state.textSize,
                    language: this.state.currentLanguage
                };

                localStorage.setItem('countify-settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async loadActivities() {
            try {
                const activities = localStorage.getItem('countify-activities');
                this.state.activities = activities ? JSON.parse(activities) || [] : [];
            } catch (error) {
                console.error('Error loading activities:', error);
                this.state.activities = [];
            }
        }

        async saveActivities() {
            try {
                localStorage.setItem('countify-activities', JSON.stringify(this.state.activities.filter(a => !a.isTutorial)));
            } catch (error) {
                console.error('Error saving activities:', error);
            }
        }

        applyTheme(theme) {
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                theme = prefersDark ? 'dark' : 'light';
            }

            document.documentElement.setAttribute('data-theme', theme);
        }

        applyFont(font) {
            if (font !== 'Poppins') {
                document.body.style.fontFamily = `${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif`;
            } else {
                document.body.style.fontFamily = '';
            }
        }

        applyTextSize(size) {
            document.body.classList.remove('text-small', 'text-normal', 'text-large');
            if (size !== 'normal') {
                document.body.classList.add(`text-${size}`);
            }

            const editor = document.getElementById('editorContent');
            if (editor) {
                editor.style.fontSize = size === 'small' ? '0.875rem' :
                    size === 'large' ? '1.125rem' : '1rem';
            }
        }

        watchSystemTheme() {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', (e) => {
                if (this.state.theme === 'system') {
                    this.applyTheme('system');
                }
            });
        }

        filterActivities() {
            let filtered = [...this.state.activities].filter(a => !a.deleted && !a.archived);

            if (this.state.searchQuery) {
                filtered = filtered.filter(activity =>
                    activity.title.toLowerCase().includes(this.state.searchQuery) ||
                    activity.content.toLowerCase().includes(this.state.searchQuery)
                );
            }

            if (this.state.selectedFolder !== 'all') {
                filtered = filtered.filter(activity =>
                    activity.folder === this.state.selectedFolder
                );
            }

            return filtered.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }

        getTodaysActivities() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            return this.state.activities.filter(activity => {
                const activityDate = new Date(activity.updatedAt);
                return activityDate >= today && !activity.deleted && !activity.archived;
            });
        }

        getYesterdaysActivities() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            return this.state.activities.filter(activity => {
                const activityDate = new Date(activity.updatedAt);
                return activityDate >= yesterday && activityDate < today && !activity.deleted && !activity.archived;
            });
        }

        formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffInDays === 0) {
                return window.CountifyLanguage?.getTranslation('today') || 'Today';
            } else if (diffInDays === 1) {
                return window.CountifyLanguage?.getTranslation('yesterday') || 'Yesterday';
            } else if (diffInDays < 7) {
                return date.toLocaleDateString(this.state.currentLanguage, {
                    weekday: 'short'
                });
            } else {
                return date.toLocaleDateString(this.state.currentLanguage, {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        countWords(text) {
            if (!text || !text.trim()) return 0;
            return text.trim().split(/\s+/).length;
        }

        countCharacters(text, includeSpaces = true) {
            if (!text) return 0;
            return includeSpaces ? text.length : text.replace(/\s+/g, '').length;
        }

        countSentences(text) {
            if (!text || !text.trim()) return 0;
            const sentences = text.split(/[.!?]+(?=\s|$)/);
            return sentences.filter(s => s.trim().length > 0).length;
        }

        countParagraphs(text) {
            if (!text || !text.trim()) return 0;
            const paragraphs = text.split(/\n\s*\n+/);
            return paragraphs.filter(p => p.trim().length > 0).length;
        }

        calculateReadingTime(wordCount) {
            const wordsPerMinute = 200;
            const minutes = wordCount / wordsPerMinute;
            return Math.ceil(minutes) || 0;
        }

        calculateSpeakingTime(wordCount) {
            const wordsPerMinute = 150;
            const minutes = wordCount / wordsPerMinute;
            return Math.ceil(minutes) || 0;
        }

        updateTextAnalytics() {
            const text = document.getElementById('editorContent')?.value || '';
            const wordCount = this.countWords(text);

            document.getElementById('wordCount').textContent = wordCount;
            document.getElementById('charCount').textContent = this.countCharacters(text, true);
            document.getElementById('charNoSpacesCount').textContent = this.countCharacters(text, false);
            document.getElementById('sentenceCount').textContent = this.countSentences(text);
            document.getElementById('paragraphCount').textContent = this.countParagraphs(text);

            document.getElementById('readingTime').textContent =
                this.calculateReadingTime(wordCount) + (this.calculateReadingTime(wordCount) === 1 ?
                    ' ' + (window.CountifyLanguage?.getTranslation('min') || 'min') :
                    ' ' + (window.CountifyLanguage?.getTranslation('mins') || 'mins'));

            document.getElementById('speakingTime').textContent =
                this.calculateSpeakingTime(wordCount) + (this.calculateSpeakingTime(wordCount) === 1 ?
                    ' ' + (window.CountifyLanguage?.getTranslation('min') || 'min') :
                    ' ' + (window.CountifyLanguage?.getTranslation('mins') || 'mins'));
        }

        async openEditor(activityId = null) {
            if (activityId) {
                const activity = this.state.activities.find(a => a.id === activityId);
                if (activity) {
                    this.state.currentActivityId = activity.id;
                    document.getElementById('editorTitle').value = activity.title;

                    if (activity.isTutorial) {
                        document.getElementById('editorTitle').readOnly = true;
                        document.getElementById('editorContent').readOnly = true;
                    } else {
                        document.getElementById('editorTitle').readOnly = false;
                        document.getElementById('editorContent').readOnly = false;
                    }

                    document.getElementById('editorContent').value = activity.content;
                    this.updateTextAnalytics();
                    this.state.isEditing = true;

                    if (!this.state.historyStack[activityId]) {
                        this.state.historyStack[activityId] = [{
                            content: activity.content,
                            title: activity.title,
                            timestamp: Date.now()
                        }];
                        this.state.futureStack[activityId] = [];
                    }
                }
            } else {
                this.state.currentActivityId = this.generateId();
                document.getElementById('editorTitle').value = this.generateDefaultTitle();
                document.getElementById('editorTitle').readOnly = false;
                document.getElementById('editorContent').value = '';
                document.getElementById('editorContent').readOnly = false;
                this.updateTextAnalytics();
                this.state.isEditing = false;

                this.state.historyStack[this.state.currentActivityId] = [{
                    content: '',
                    title: this.generateDefaultTitle(),
                    timestamp: Date.now()
                }];
                this.state.futureStack[this.state.currentActivityId] = [];
            }

            document.getElementById('editorContainer').classList.add('editor-container-open');
            document.getElementById('editorContent').focus();
            this.updateUndoRedoButtons();

            if (document.getElementById('drawer').classList.contains('drawer-open')) {
                this.toggleDrawer();
            }

            document.getElementById('fab').style.display = 'none';
            this.closeVoiceMode();
        }

        generateDefaultTitle() {
            const now = new Date();
            const hours = now.getHours();

            if (window.CountifyLanguage) {
                if (hours < 12) return window.CountifyLanguage.getTranslation('morning_activity') || 'Morning Activity';
                if (hours < 17) return window.CountifyLanguage.getTranslation('afternoon_activity') || 'Afternoon Activity';
                return window.CountifyLanguage.getTranslation('evening_activity') || 'Evening Activity';
            } else {
                if (hours < 12) return 'Morning Activity';
                if (hours < 17) return 'Afternoon Activity';
                return 'Evening Activity';
            }
        }

        closeEditor() {
            document.getElementById('editorContainer').classList.remove('editor-container-open');
            this.state.currentActivityId = null;
            this.renderView();
            document.getElementById('fab').style.display = 'flex';
            this.closeVoiceMode();
        }

        async saveActivity(isAutoSave = false, showIndicator = false) {
            const title = document.getElementById('editorTitle')?.value.trim() || this.generateDefaultTitle();
            const content = document.getElementById('editorContent')?.value.trim() || '';
            const wordCount = this.countWords(content);
            const now = new Date().toISOString();

            const activity = this.state.activities.find(a => a.id === this.state.currentActivityId);
            if (activity && activity.isTutorial) {
                this.showAlert(
                    window.CountifyLanguage?.getTranslation('cannot_save') || 'Cannot Save',
                    window.CountifyLanguage?.getTranslation('cannot_save_message') || 'This is a tutorial activity and cannot be modified.'
                );
                return;
            }

            if (this.state.isEditing) {
                this.state.activities = this.state.activities.map(activity => {
                    if (activity.id === this.state.currentActivityId) {
                        return {
                            ...activity,
                            title,
                            content,
                            wordCount,
                            updatedAt: now
                        };
                    }
                    return activity;
                });
            } else {
                this.state.activities.unshift({
                    id: this.state.currentActivityId,
                    title,
                    content,
                    wordCount,
                    createdAt: now,
                    updatedAt: now,
                    deleted: false,
                    archived: false
                });
                this.state.isEditing = true;
            }

            await this.saveActivities();

            if (showIndicator) {
                this.showAutoSaveIndicator();
            }
        }

        async deleteActivity(activityId) {
            const activity = this.state.activities.find(a => a.id === activityId);
            if (activity && activity.isTutorial) {
                this.showAlert(
                    window.CountifyLanguage?.getTranslation('cannot_delete') || 'Cannot Delete',
                    window.CountifyLanguage?.getTranslation('cannot_delete_message') || 'This is a tutorial activity and cannot be deleted.'
                );
                return;
            }

            this.state.activities = this.state.activities.filter(activity => activity.id !== activityId);
            await this.saveActivities();
            this.renderView();
        }

        showActivityOptions(activityId, x, y) {
            const activity = this.state.activities.find(a => a.id === activityId);
            if (!activity) return;

            const contextMenu = document.getElementById('contextMenu');
            contextMenu.innerHTML = `
            <div class="context-menu-item" data-action="edit" tabindex="0">
                <span class="material-icons">edit</span>
                <span data-translate="edit">Edit</span>
            </div>
            ${activity.deleted ? `
                <div class="context-menu-item danger" data-action="deletePermanently" tabindex="0">
                    <span class="material-icons">delete_forever</span>
                    <span data-translate="delete_permanently">Delete Permanently</span>
                </div>
            ` : activity.archived ? `
                <div class="context-menu-item" data-action="unarchive" tabindex="0">
                    <span class="material-icons">unarchive</span>
                    <span data-translate="unarchive">Unarchive</span>
                </div>
                <div class="context-menu-item danger" data-action="delete" tabindex="0">
                    <span class="material-icons">delete</span>
                    <span data-translate="delete">Delete</span>
                </div>
            ` : `
                <div class="context-menu-item" data-action="archive" tabindex="0">
                    <span class="material-icons">archive</span>
                    <span data-translate="archive">Archive</span>
                </div>
                <div class="context-menu-item danger" data-action="delete" tabindex="0">
                    <span class="material-icons">delete</span>
                    <span data-translate="delete">Delete</span>
                </div>
            `}
        `;

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const menuWidth = 200;
            const menuHeight = activity.deleted ? 96 : activity.archived ? 144 : 192;

            const adjustedX = x + menuWidth > viewportWidth ? viewportWidth - menuWidth - 10 : x;
            const adjustedY = y + menuHeight > viewportHeight ? viewportHeight - menuHeight - 10 : y;

            contextMenu.style.left = `${adjustedX}px`;
            contextMenu.style.top = `${adjustedY}px`;
            contextMenu.classList.add('context-menu-open');

            setTimeout(() => {
                contextMenu.querySelector('.context-menu-item').focus();
            }, 10);

            contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const action = item.dataset.action;
                    this.handleContextMenuAction(action, activity);
                });

                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        e.stopPropagation();
                        const action = item.dataset.action;
                        this.handleContextMenuAction(action, activity);
                    }
                });
            });
        }

        handleContextMenuAction(action, activity) {
            switch (action) {
                case 'edit':
                    this.openEditor(activity.id);
                    break;
                case 'archive':
                    activity.archived = true;
                    this.saveActivities();
                    this.renderView();
                    break;
                case 'unarchive':
                    activity.archived = false;
                    this.saveActivities();
                    this.renderView();
                    break;
                case 'delete':
                    activity.deleted = true;
                    this.saveActivities();
                    this.renderView();
                    break;
                case 'deletePermanently':
                    this.showConfirmModal(
                        window.CountifyLanguage?.getTranslation('delete_permanent_confirm') || 'Delete Permanently',
                        window.CountifyLanguage?.getTranslation('delete_permanent_confirm') || 'Are you sure you want to permanently delete this activity? This cannot be undone.',
                        async () => {
                            this.state.activities = this.state.activities.filter(a => a.id !== activity.id);
                            await this.saveActivities();
                            this.renderView();
                        }
                    );
                    break;
            }

            this.hideContextMenu();
        }

        hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('context-menu-open');
        }

        showConfirmModal(title, message, confirmAction) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            this.state.pendingAction = confirmAction;
            document.getElementById('confirmModal').classList.add('modal-open');

            setTimeout(() => {
                document.getElementById('confirmModalCancel').focus();
            }, 100);
        }

        showAlert(title, message) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModal').classList.add('modal-open');

            setTimeout(() => {
                document.getElementById('alertModalOk').focus();
            }, 100);
        }

        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }
    }

    // Initialize the app when the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        const app = new CountifyApp();
    });
</script>
</body>

</html>