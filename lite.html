<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NearCheck+</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --accent-color: #EA4335;
            --warning-color: #FBBC05;
            --dark-color: #202124;
            --light-color: #FFFFFF;
            --gray-color: #F1F3F4;
            --text-primary: #3C4043;
            --text-secondary: #5F6368;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-color);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background-color: var(--light-color);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .avatar-initials {
            font-size: 16px;
        }

        .avatar-emoji {
            font-size: 20px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 72px;
            left: 0;
            bottom: 0;
            width: 280px;
            background-color: var(--light-color);
            box-shadow: var(--shadow-sm);
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 90;
            overflow-y: auto;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .sidebar-item:hover {
            background-color: var(--gray-color);
        }

        .sidebar-item.active {
            border-left-color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }

        .sidebar-icon {
            font-size: 24px;
            color: var(--text-secondary);
        }

        .sidebar-item.active .sidebar-icon {
            color: var(--primary-color);
        }

        .sidebar-text {
            font-weight: 500;
        }

        .sidebar-divider {
            height: 1px;
            background-color: rgba(0, 0, 0, 0.1);
            margin: 8px 16px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 16px;
            transition: var(--transition);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-title-icon {
            font-size: 28px;
        }

        .greeting {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .greeting-time {
            color: var(--primary-color);
        }

        /* Card Styles */
        .card {
            background-color: var(--light-color);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            padding: 16px;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 20px;
            color: var(--primary-color);
        }

        /* Button Styles */
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            border: none;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            user-select: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3367D6;
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #E0E0E0;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #D33426;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #2D9246;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-primary);
        }

        .btn-warning:hover {
            background-color: #E8A808;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            min-width: 36px;
            min-height: 36px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #DADCE0;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        .form-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-check-input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .form-check-label {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        /* Bottom Sheet Styles */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--light-color);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(100%);
            transition: var(--transition);
            z-index: 110;
            max-height: 90vh;
            overflow-y: auto;
            padding-bottom: 24px;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .bottom-sheet-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            background-color: var(--light-color);
            z-index: 1;
        }

        .bottom-sheet-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .bottom-sheet-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .bottom-sheet-body {
            padding: 16px;
        }

        .bottom-sheet-footer {
            padding: 16px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background-color: var(--light-color);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .bottom-sheet-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .bottom-sheet-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--light-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 120;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.open {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 110;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .modal-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 130;
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-success .toast-icon {
            color: var(--secondary-color);
        }

        .toast-error .toast-icon {
            color: var(--accent-color);
        }

        .toast-warning .toast-icon {
            color: var(--warning-color);
        }

        /* Section Carousel */
        .section-carousel {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
            margin-bottom: 24px;
        }

        .section-carousel::-webkit-scrollbar {
            display: none;
        }

        .section-card {
            min-width: 240px;
            background-color: var(--light-color);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            padding: 16px;
            transition: var(--transition);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .section-card:hover {
            box-shadow: var(--shadow-md);
        }

        .section-card-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-card-icon {
            font-size: 20px;
        }

        .section-card-subject {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .section-card-schedule {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .section-card-actions {
            display: flex;
            gap: 8px;
        }

        /* Attendance Card */
        .attendance-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background-color: var(--light-color);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .attendance-card:hover {
            box-shadow: var(--shadow-md);
        }

        .attendance-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .attendance-info {
            flex: 1;
        }

        .attendance-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .attendance-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .attendance-status {
            font-size: 0.875rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-present {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }

        .status-absent {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--accent-color);
        }

        .status-excused {
            background-color: rgba(251, 188, 5, 0.1);
            color: var(--warning-color);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 16px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 16px;
            max-width: 400px;
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            .app-container {
                display: flex;
                min-height: 100vh;
            }

            .sidebar {
                position: relative;
                top: 0;
                transform: translateX(0);
                width: 280px;
                flex-shrink: 0;
                border-right: 1px solid rgba(0, 0, 0, 0.1);
                box-shadow: none;
            }

            .main-content {
                flex: 1;
                padding: 24px;
            }

            .header {
                padding: 16px 24px;
            }

            .mobile-menu-btn {
                display: none;
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                width: 280px;
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        /* Confetti Effect */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            opacity: 0;
            z-index: 9999;
            animation: confetti-fall 3s ease-in-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        .mt-1 {
            margin-top: 4px;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mt-3 {
            margin-top: 16px;
        }

        .mt-4 {
            margin-top: 24px;
        }

        .mt-5 {
            margin-top: 32px;
        }

        .mb-1 {
            margin-bottom: 4px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .mb-4 {
            margin-bottom: 24px;
        }

        .mb-5 {
            margin-bottom: 32px;
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .w-100 {
            width: 100%;
        }

        /* Context Menu Protection */
        .context-menu-protection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
            display: none;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="material-icons logo-icon">near_me</span>
                <span>NearCheck+</span>
            </div>
            <div class="header-actions">
                <button id="mobileMenuBtn" class="btn btn-icon mobile-menu-btn">
                    <span class="material-icons">menu</span>
                </button>
                <div id="userAvatar" class="avatar" style="background-color: #4285F4;">
                    <span class="avatar-initials">U</span>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-item active" data-page="dashboard">
                <span class="material-icons sidebar-icon">dashboard</span>
                <span class="sidebar-text">Dashboard</span>
            </div>
            <div class="sidebar-item" data-page="sections">
                <span class="material-icons sidebar-icon">class</span>
                <span class="sidebar-text">Sections</span>
            </div>
            <div class="sidebar-item" data-page="attendance">
                <span class="material-icons sidebar-icon">checklist</span>
                <span class="sidebar-text">Attendance</span>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-item" data-page="settings">
                <span class="material-icons sidebar-icon">settings</span>
                <span class="sidebar-text">Settings</span>
            </div>
            <div class="sidebar-item" id="logoutBtn">
                <span class="material-icons sidebar-icon">logout</span>
                <span class="sidebar-text">Logout</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Page (Default) -->
            <div id="dashboardPage" class="page">
                <h1 class="page-title">
                    <span class="material-icons page-title-icon">dashboard</span>
                    <span>Dashboard</span>
                </h1>
                <p class="greeting">
                    <span class="greeting-time" id="greetingTime"></span>,
                    <span id="userDisplayName">User</span>
                </p>

                <!-- Sections Carousel -->
                <h2 class="card-title">
                    <span class="material-icons card-icon">class</span>
                    <span>Your Sections</span>
                </h2>
                <div class="section-carousel" id="sectionsCarousel">
                    <!-- Sections will be dynamically added here -->
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">class</span>
                        <h3 class="empty-state-title">No Sections Yet</h3>
                        <p class="empty-state-text">Create or join a section to get started with attendance tracking.</p>
                        <button class="btn btn-primary" id="createSectionBtn">Create Section</button>
                    </div>
                </div>

                <!-- Recent Attendance -->
                <h2 class="card-title">
                    <span class="material-icons card-icon">checklist</span>
                    <span>Recent Attendance</span>
                </h2>
                <div class="card">
                    <div id="recentAttendanceList">
                        <!-- Attendance items will be dynamically added here -->
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">checklist</span>
                            <h3 class="empty-state-title">No Attendance Records</h3>
                            <p class="empty-state-text">Your attendance records will appear here once you start checking in.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sections Page -->
            <div id="sectionsPage" class="page" style="display: none;">
                <h1 class="page-title">
                    <span class="material-icons page-title-icon">class</span>
                    <span>Your Sections</span>
                </h1>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p>Manage your class sections and attendance settings</p>
                    <button class="btn btn-primary" id="createSectionBtn2">
                        <span class="material-icons">add</span>
                        Create Section
                    </button>
                </div>

                <div class="card">
                    <div id="sectionsList">
                        <!-- Sections will be dynamically added here -->
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">class</span>
                            <h3 class="empty-state-title">No Sections Yet</h3>
                            <p class="empty-state-text">Create or join a section to get started with attendance tracking.</p>
                            <button class="btn btn-primary" id="createSectionBtn3">Create Section</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Page -->
            <div id="attendancePage" class="page" style="display: none;">
                <h1 class="page-title">
                    <span class="material-icons page-title-icon">checklist</span>
                    <span>Attendance</span>
                </h1>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">search</span>
                        <span>Search Attendance</span>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="attendanceSearch" placeholder="Search by section or student name">
                    </div>
                </div>

                <div id="attendanceRecords">
                    <!-- Attendance records will be dynamically added here -->
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">checklist</span>
                        <h3 class="empty-state-title">No Attendance Records</h3>
                        <p class="empty-state-text">Your attendance records will appear here once you start checking in.</p>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page" style="display: none;">
                <h1 class="page-title">
                    <span class="material-icons page-title-icon">settings</span>
                    <span>Settings</span>
                </h1>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">account_circle</span>
                        <span>Profile</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Identity</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary" id="changeToEmojiBtn">
                                <span class="material-icons">emoji_emotions</span>
                                Emoji
                            </button>
                            <button class="btn btn-secondary" id="changeToTextBtn">
                                <span class="material-icons">text_fields</span>
                                Text
                            </button>
                        </div>
                        <p class="form-text">You can change your display identity once every 24 hours.</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">location_on</span>
                        <span>Location Permissions</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location Access</label>
                        <div id="locationStatus" class="mb-2">
                            <span class="material-icons">help</span>
                            <span>Checking location permission status...</span>
                        </div>
                        <button class="btn btn-primary" id="requestLocationBtn">
                            <span class="material-icons">location_on</span>
                            Request Location Access
                        </button>
                        <p class="form-text">NearCheck+ only accesses your location when checking in or creating a session.</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">security</span>
                        <span>Security</span>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" id="changePasswordBtn">
                            <span class="material-icons">lock</span>
                            Change Password
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" id="changeEmailBtn">
                            <span class="material-icons">email</span>
                            Change Email
                        </button>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">analytics</span>
                        <span>Analytics</span>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="analyticsToggle">
                            <label class="form-check-label" for="analyticsToggle">Allow analytics collection</label>
                        </div>
                        <p class="form-text">Help improve NearCheck+ by sharing anonymous usage data.</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="material-icons card-icon">info</span>
                        <span>About</span>
                    </div>
                    <div class="form-group">
                        <p>NearCheck+ v1.0.0</p>
                        <p class="form-text">A privacy-focused, geolocation-based attendance web app.</p>
                    </div>
                </div>
            </div>

            <!-- Section Detail Page -->
            <div id="sectionDetailPage" class="page" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-icon" id="backToSectionsBtn">
                        <span class="material-icons">arrow_back</span>
                    </button>
                    <h1 class="page-title mb-0" id="sectionDetailTitle">
                        <span class="material-icons page-title-icon">class</span>
                        <span>Section Details</span>
                    </h1>
                </div>

                <div class="card mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="sectionName" class="card-title mb-1">Section Name</h2>
                            <p id="sectionSubject" class="text-muted">Subject</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-icon" id="editSectionBtn">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-icon" id="deleteSectionBtn">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p id="sectionSchedule" class="d-flex align-items-center">
                            <span class="material-icons mr-2">schedule</span>
                            <span>Schedule: Mon, Wed, Fri at 9:00 AM</span>
                        </p>
                        <p id="sectionLocation" class="d-flex align-items-center">
                            <span class="material-icons mr-2">location_on</span>
                            <span>Location: Set on session start</span>
                        </p>
                        <p id="sectionRadius" class="d-flex align-items-center">
                            <span class="material-icons mr-2">my_location</span>
                            <span>Check-in radius: 10 meters</span>
                        </p>
                        <p id="sectionCreated" class="d-flex align-items-center">
                            <span class="material-icons mr-2">calendar_today</span>
                            <span>Created: Loading...</span>
                        </p>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="card-title mb-0">
                        <span class="material-icons card-icon">group</span>
                        <span>Students</span>
                    </h2>
                    <button class="btn btn-primary" id="startSessionBtn">
                        <span class="material-icons">play_arrow</span>
                        Start Session
                    </button>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">search</span>
                        <span>Search Students</span>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="studentSearch" placeholder="Search by student name">
                    </div>
                </div>

                <div class="card">
                    <div id="studentsList">
                        <!-- Students will be dynamically added here -->
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">group</span>
                            <h3 class="empty-state-title">No Students Yet</h3>
                            <p class="empty-state-text">Share the section invite link or QR code to add students.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Detail Page -->
            <div id="sessionDetailPage" class="page" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-icon" id="backToSectionDetailBtn">
                        <span class="material-icons">arrow_back</span>
                    </button>
                    <h1 class="page-title mb-0">
                        <span class="material-icons page-title-icon">play_arrow</span>
                        <span>Active Session</span>
                    </h1>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">timer</span>
                        <span>Session Timer</span>
                    </div>
                    <div class="text-center mb-3">
                        <h2 id="sessionTimer">00:00</h2>
                        <p class="text-muted">Session duration</p>
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-success" id="extendSessionBtn">
                            <span class="material-icons">add</span>
                            Extend
                        </button>
                        <button class="btn btn-accent" id="endSessionBtn">
                            <span class="material-icons">stop</span>
                            End Session
                        </button>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">location_on</span>
                        <span>Session Location</span>
                    </div>
                    <div class="mb-3">
                        <p id="sessionLocationText">Location: Loading...</p>
                        <p id="sessionRadiusText">Check-in radius: 10 meters</p>
                    </div>
                    <button class="btn btn-primary" id="updateLocationBtn">
                        <span class="material-icons">my_location</span>
                        Update Location
                    </button>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">qr_code</span>
                        <span>Invite Students</span>
                    </div>
                    <div class="text-center mb-3">
                        <div id="sessionQRCode" style="width: 200px; height: 200px; margin: 0 auto; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="font-size: 48px; color: #ccc;">qr_code</span>
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <button class="btn btn-secondary" id="copyInviteLinkBtn">
                            <span class="material-icons">link</span>
                            Copy Link
                        </button>
                        <button class="btn btn-secondary" id="downloadQRCodeBtn">
                            <span class="material-icons">download</span>
                            Download QR
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="material-icons card-icon">checklist</span>
                        <span>Attendance</span>
                    </div>
                    <div id="sessionAttendanceList">
                        <!-- Attendance during this session will be dynamically added here -->
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">checklist</span>
                            <h3 class="empty-state-title">No Check-ins Yet</h3>
                            <p class="empty-state-text">Student check-ins will appear here as they join the session.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Check-in Page -->
            <div id="checkInPage" class="page" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-icon" id="backToDashboardBtn">
                        <span class="material-icons">arrow_back</span>
                    </button>
                    <h1 class="page-title mb-0">
                        <span class="material-icons page-title-icon">near_me</span>
                        <span>Check-in</span>
                    </h1>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">class</span>
                        <span id="checkInSectionName">Section Name</span>
                    </div>
                    <div class="mb-3">
                        <p id="checkInSessionStatus" class="d-flex align-items-center">
                            <span class="material-icons mr-2">info</span>
                            <span>Checking session status...</span>
                        </p>
                        <p id="checkInSessionTime" class="d-flex align-items-center">
                            <span class="material-icons mr-2">schedule</span>
                            <span>Session time: Loading...</span>
                        </p>
                        <p id="checkInPointsInfo" class="d-flex align-items-center">
                            <span class="material-icons mr-2">star</span>
                            <span>Plus Points: Calculating...</span>
                        </p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-title">
                        <span class="material-icons card-icon">location_on</span>
                        <span>Your Location</span>
                    </div>
                    <div class="mb-3">
                        <p id="checkInLocationStatus">Checking your location...</p>
                        <p id="checkInDistance">Distance from session: Calculating...</p>
                    </div>
                    <button class="btn btn-primary" id="checkInBtn" disabled>
                        <span class="material-icons">near_me</span>
                        Check-in Now
                    </button>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="material-icons card-icon">timer</span>
                        <span>Check-in Timer</span>
                    </div>
                    <div class="text-center mb-3">
                        <h2 id="checkInTimer">00:00</h2>
                        <p class="text-muted">Time remaining for maximum points</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Sheets -->
        <div class="bottom-sheet" id="profileBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Your Profile</h3>
                <button class="bottom-sheet-close" id="closeProfileBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="text-center mb-4">
                    <div id="profileAvatar" class="avatar" style="width: 80px; height: 80px; margin: 0 auto 16px; font-size: 32px;">
                        <span class="avatar-initials">U</span>
                    </div>
                    <h3 id="profileUsername">username@nearcheck</h3>
                    <p class="text-muted" id="profileRole">Role: Loading...</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="profileFullName" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="profileEmail" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Account Created</label>
                    <input type="text" class="form-control" id="profileCreatedAt" disabled>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="closeProfileBottomSheetBtn">Close</button>
            </div>
        </div>

        <div class="bottom-sheet" id="createSectionBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Create New Section</h3>
                <button class="bottom-sheet-close" id="closeCreateSectionBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Section Name</label>
                    <input type="text" class="form-control" id="sectionNameInput" placeholder="e.g., Math 101 - Section A">
                </div>
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-control" id="sectionSubjectInput" placeholder="e.g., Mathematics">
                </div>
                <div class="form-group">
                    <label class="form-label">Schedule</label>
                    <select class="form-control" id="sectionDaysInput">
                        <option value="MWF">Monday, Wednesday, Friday</option>
                        <option value="TTh">Tuesday, Thursday</option>
                        <option value="MW">Monday, Wednesday</option>
                        <option value="TThF">Tuesday, Thursday, Friday</option>
                        <option value="M-F">Monday to Friday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-control" id="sectionTimeInput">
                </div>
                <div class="form-group">
                    <label class="form-label">Check-in Radius</label>
                    <select class="form-control" id="sectionRadiusInput">
                        <option value="5">NearSnap (5m)</option>
                        <option value="10" selected>NearStandard (10m)</option>
                        <option value="20">NearFlex (20m)</option>
                        <option value="50">NearMax (50m)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sectionPlusPointsInput" checked>
                        <label class="form-check-label" for="sectionPlusPointsInput">Enable Plus Points</label>
                    </div>
                    <p class="form-text">Reward students for early check-ins with bonus points.</p>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelCreateSectionBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmCreateSectionBtn">Create Section</button>
            </div>
        </div>

        <div class="bottom-sheet" id="editSectionBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Edit Section</h3>
                <button class="bottom-sheet-close" id="closeEditSectionBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Section Name</label>
                    <input type="text" class="form-control" id="editSectionNameInput">
                </div>
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-control" id="editSectionSubjectInput">
                </div>
                <div class="form-group">
                    <label class="form-label">Schedule</label>
                    <select class="form-control" id="editSectionDaysInput">
                        <option value="MWF">Monday, Wednesday, Friday</option>
                        <option value="TTh">Tuesday, Thursday</option>
                        <option value="MW">Monday, Wednesday</option>
                        <option value="TThF">Tuesday, Thursday, Friday</option>
                        <option value="M-F">Monday to Friday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-control" id="editSectionTimeInput">
                </div>
                <div class="form-group">
                    <label class="form-label">Check-in Radius</label>
                    <select class="form-control" id="editSectionRadiusInput">
                        <option value="5">NearSnap (5m)</option>
                        <option value="10">NearStandard (10m)</option>
                        <option value="20">NearFlex (20m)</option>
                        <option value="50">NearMax (50m)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="editSectionPlusPointsInput">
                        <label class="form-check-label" for="editSectionPlusPointsInput">Enable Plus Points</label>
                    </div>
                    <p class="form-text">Reward students for early check-ins with bonus points.</p>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelEditSectionBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmEditSectionBtn">Save Changes</button>
            </div>
        </div>

        <div class="bottom-sheet" id="deleteSectionBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Delete Section</h3>
                <button class="bottom-sheet-close" id="closeDeleteSectionBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="alert alert-warning mb-3">
                    <span class="material-icons">warning</span>
                    <p>This action cannot be undone. All section data, including student records and attendance history, will be permanently deleted.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Enter your password to confirm</label>
                    <input type="password" class="form-control" id="deleteSectionPasswordInput" placeholder="Your current password">
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="deleteSectionConfirmInput">
                        <label class="form-check-label" for="deleteSectionConfirmInput">I understand this action is irreversible</label>
                    </div>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelDeleteSectionBtn">Cancel</button>
                <button class="btn btn-accent" id="confirmDeleteSectionBtn" disabled>Delete Section</button>
            </div>
        </div>

        <div class="bottom-sheet" id="changeDisplayBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Change Display Identity</h3>
                <button class="bottom-sheet-close" id="closeChangeDisplayBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div id="emojiSelection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Select an Emoji</label>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 300px; overflow-y: auto;">
                            <!-- Emojis will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div id="textSelection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Enter 1-2 Letters</label>
                        <input type="text" class="form-control" id="displayTextInput" maxlength="2" placeholder="e.g., AB">
                    </div>
                </div>
                <div id="changeDisplayError" class="text-muted" style="color: var(--accent-color); display: none;"></div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelChangeDisplayBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmChangeDisplayBtn">Save</button>
            </div>
        </div>

        <div class="bottom-sheet" id="changePasswordBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Change Password</h3>
                <button class="bottom-sheet-close" id="closeChangePasswordBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-control" id="currentPasswordInput" placeholder="Enter your current password">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPasswordInput" placeholder="Enter your new password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmPasswordInput" placeholder="Confirm your new password">
                </div>
                <div id="passwordError" class="text-muted" style="color: var(--accent-color); display: none;"></div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelChangePasswordBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmChangePasswordBtn">Change Password</button>
            </div>
        </div>

        <div class="bottom-sheet" id="changeEmailBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Change Email</h3>
                <button class="bottom-sheet-close" id="closeChangeEmailBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Current Email</label>
                    <input type="email" class="form-control" id="currentEmailInput" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">New Email</label>
                    <input type="email" class="form-control" id="newEmailInput" placeholder="Enter your new email">
                </div>
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-control" id="emailPasswordInput" placeholder="Enter your current password">
                </div>
                <div id="emailError" class="text-muted" style="color: var(--accent-color); display: none;"></div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelChangeEmailBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmChangeEmailBtn">Change Email</button>
            </div>
        </div>

        <div class="bottom-sheet" id="sessionOptionsBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Session Options</h3>
                <button class="bottom-sheet-close" id="closeSessionOptionsBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Session Duration</label>
                    <select class="form-control" id="sessionDurationInput">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">60 minutes</option>
                        <option value="90">90 minutes</option>
                        <option value="120">120 minutes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Check-in Radius</label>
                    <select class="form-control" id="sessionRadiusInput">
                        <option value="5">NearSnap (5m)</option>
                        <option value="10" selected>NearStandard (10m)</option>
                        <option value="20">NearFlex (20m)</option>
                        <option value="50">NearMax (50m)</option>
                    </select>
                </div>
                <div id="plusPointsOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Plus Points Settings</label>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span>Max Points:</span>
                            <input type="number" class="form-control" id="maxPointsInput" min="1" max="60" value="5" style="width: 60px;">
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span>Min Points:</span>
                            <input type="number" class="form-control" id="minPointsInput" min="0" max="59" value="1" style="width: 60px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rememberPlusPointsInput" checked>
                            <label class="form-check-label" for="rememberPlusPointsInput">Remember my settings</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelSessionOptionsBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmSessionOptionsBtn">Start Session</button>
            </div>
        </div>

        <div class="bottom-sheet" id="extendSessionBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Extend Session</h3>
                <button class="bottom-sheet-close" id="closeExtendSessionBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="form-group">
                    <label class="form-label">Extend By</label>
                    <select class="form-control" id="extendDurationInput">
                        <option value="5">5 minutes</option>
                        <option value="10" selected>10 minutes</option>
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="updateLocationExtendInput">
                        <label class="form-check-label" for="updateLocationExtendInput">Update session location</label>
                    </div>
                    <p class="form-text">If checked, the check-in radius will be centered on your current location.</p>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="cancelExtendSessionBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmExtendSessionBtn">Extend Session</button>
            </div>
        </div>

        <div class="bottom-sheet" id="studentProfileBottomSheet">
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Student Profile</h3>
                <button class="bottom-sheet-close" id="closeStudentProfileBottomSheet">&times;</button>
            </div>
            <div class="bottom-sheet-body">
                <div class="text-center mb-4">
                    <div id="studentProfileAvatar" class="avatar" style="width: 80px; height: 80px; margin: 0 auto 16px; font-size: 32px;">
                        <span class="avatar-initials">S</span>
                    </div>
                    <h3 id="studentProfileName">Student Name</h3>
                    <p class="text-muted" id="studentProfileUsername">username@nearcheck</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Joined Section</label>
                    <input type="text" class="form-control" id="studentJoinedDate" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Total Plus Points</label>
                    <input type="text" class="form-control" id="studentPlusPoints" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Attendance Rate</label>
                    <input type="text" class="form-control" id="studentAttendanceRate" disabled>
                </div>
            </div>
            <div class="bottom-sheet-footer">
                <button class="btn btn-secondary" id="closeStudentProfileBtn">Close</button>
                <button class="btn btn-accent" id="removeStudentBtn" style="display: none;">
                    <span class="material-icons">person_remove</span>
                    Remove Student
                </button>
            </div>
        </div>

        <!-- Bottom Sheet Backdrop -->
        <div class="bottom-sheet-backdrop" id="bottomSheetBackdrop"></div>

        <!-- Modals -->
        <div class="modal" id="ageConfirmationModal">
            <div class="modal-header">
                <h3 class="modal-title">Age Confirmation</h3>
                <button class="modal-close" id="closeAgeConfirmationModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>To continue, please confirm that you are <strong id="ageRequirement">13 years old or above</strong>. This helps us maintain a safe, secure, and appropriate experience for all NearCheck users.</p>
                <div class="form-group mt-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="ageConfirmationCheckbox">
                        <label class="form-check-label" for="ageConfirmationCheckbox">I confirm that I meet the age requirement</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAgeConfirmationBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmAgeConfirmationBtn" disabled>Continue</button>
            </div>
        </div>

        <div class="modal" id="analyticsConsentModal">
            <div class="modal-header">
                <h3 class="modal-title">Help Improve NearCheck+</h3>
                <button class="modal-close" id="closeAnalyticsConsentModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>NearCheck+ would like to collect anonymous usage data to help improve the app. This data includes:</p>
                <ul class="mb-3">
                    <li>Feature usage</li>
                    <li>Performance metrics</li>
                    <li>Error reports</li>
                </ul>
                <p>No personal information or attendance data will be collected. You can change this setting anytime in your account settings.</p>
                <div class="form-group mt-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="analyticsConsentCheckbox" checked>
                        <label class="form-check-label" for="analyticsConsentCheckbox">Allow analytics collection</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="confirmAnalyticsConsentBtn">Continue</button>
            </div>
        </div>

        <div class="modal" id="locationPermissionModal">
            <div class="modal-header">
                <h3 class="modal-title">Location Access Required</h3>
                <button class="modal-close" id="closeLocationPermissionModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>NearCheck+ needs access to your location to verify your attendance when checking in or creating sessions.</p>
                <p>Your precise location is only used during these actions and is not stored permanently.</p>
                <div class="alert alert-warning mt-3">
                    <span class="material-icons">warning</span>
                    <p>Without location access, you won't be able to check in or create sessions.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="denyLocationPermissionBtn">Not Now</button>
                <button class="btn btn-primary" id="grantLocationPermissionBtn">Allow Location Access</button>
            </div>
        </div>

        <div class="modal" id="checkInSuccessModal">
            <div class="modal-header">
                <h3 class="modal-title">Check-in Successful</h3>
                <button class="modal-close" id="closeCheckInSuccessModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <span class="material-icons" style="font-size: 48px; color: var(--secondary-color);">check_circle</span>
                    <h3 id="checkInPointsEarned">You earned 5 Plus Points!</h3>
                    <p class="text-muted" id="checkInTime">Checked in at 9:05 AM</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="closeCheckInSuccessBtn">Done</button>
            </div>
        </div>

        <!-- Modal Backdrop -->
        <div class="modal-backdrop" id="modalBackdrop"></div>

        <!-- Toast Notification -->
        <div class="toast" id="toastNotification">
            <span class="material-icons toast-icon">info</span>
            <span id="toastMessage">This is a notification message</span>
        </div>

        <!-- Auth Screens (Initially shown) -->
        <div id="authScreen" style="display: flex; flex-direction: column; min-height: 100vh; padding: 24px; background-color: var(--light-color);">
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <div style="margin-bottom: 40px;">
                    <span class="material-icons" style="font-size: 48px; color: var(--primary-color);">near_me</span>
                    <h1 style="font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-top: 16px;">NearCheck+</h1>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Attendance. Smarter than ever.</p>
                </div>

                <div id="roleSelection" style="width: 100%; max-width: 400px;">
                    <h2 style="font-size: 1.25rem; margin-bottom: 24px;">Hi there! Let's get you started.</h2>
                    <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                        <button class="btn btn-primary btn-lg" id="teacherRoleBtn">
                            <span class="material-icons">school</span>
                            I'm a Teacher
                        </button>
                        <button class="btn btn-secondary btn-lg" id="studentRoleBtn">
                            <span class="material-icons">person</span>
                            I'm a Student
                        </button>
                    </div>
                    <div style="margin-top: 24px;">
                        <button class="btn btn-text" id="haveAccountBtn">Already have an account? Sign In</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 24px;">
                        By continuing to NearCheck+, you agree with our <a href="#" style="color: var(--primary-color);">Terms</a> and <a href="#" style="color: var(--primary-color);">Privacy Policy</a>.
                    </p>
                </div>

                <div id="teacherSignUpForm" style="width: 100%; max-width: 400px; display: none;">
                    <h2 style="font-size: 1.25rem; margin-bottom: 24px;">Teacher Sign Up</h2>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="text" class="form-control" id="teacherFullName" placeholder="Full Name">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="email" class="form-control" id="teacherEmail" placeholder="Email Address">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="password" class="form-control" id="teacherPassword" placeholder="Password">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="password" class="form-control" id="teacherConfirmPassword" placeholder="Confirm Password">
                    </div>
                    <div class="form-group" style="margin-bottom: 24px;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="teacherTermsCheckbox">
                            <label class="form-check-label" for="teacherTermsCheckbox">I agree to the Terms and Privacy Policy</label>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg w-100" id="teacherSignUpBtn">Sign Up</button>
                    <button class="btn btn-text w-100 mt-2" id="backToRoleSelectionFromTeacher">Back</button>
                </div>

                <div id="studentSignUpForm" style="width: 100%; max-width: 400px; display: none;">
                    <h2 style="font-size: 1.25rem; margin-bottom: 24px;">Student Sign Up</h2>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="text" class="form-control" id="studentFullName" placeholder="Full Name">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="email" class="form-control" id="studentEmail" placeholder="Email Address">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="password" class="form-control" id="studentPassword" placeholder="Password">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="password" class="form-control" id="studentConfirmPassword" placeholder="Confirm Password">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="text" class="form-control" id="studentSectionId" placeholder="Section ID (optional)">
                    </div>
                    <div class="form-group" style="margin-bottom: 24px;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="studentTermsCheckbox">
                            <label class="form-check-label" for="studentTermsCheckbox">I agree to the Terms and Privacy Policy</label>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg w-100" id="studentSignUpBtn">Sign Up</button>
                    <button class="btn btn-text w-100 mt-2" id="backToRoleSelectionFromStudent">Back</button>
                </div>

                <div id="signInForm" style="width: 100%; max-width: 400px; display: none;">
                    <h2 style="font-size: 1.25rem; margin-bottom: 24px;">Sign In</h2>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="text" class="form-control" id="signInEmail" placeholder="Email or Username">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <input type="password" class="form-control" id="signInPassword" placeholder="Password">
                    </div>
                    <div class="form-group" style="margin-bottom: 24px;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMeCheckbox">
                            <label class="form-check-label" for="rememberMeCheckbox">Remember me</label>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg w-100" id="signInBtn">Sign In</button>
                    <button class="btn btn-text w-100 mt-2" id="backToRoleSelectionFromSignIn">Back</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none;">
            <div style="text-align: center;">
                <div class="spinner" style="margin: 0 auto 16px;"></div>
                <p id="loadingText">Loading...</p>
            </div>
        </div>

        <!-- Context Menu Protection -->
        <div class="context-menu-protection" id="contextMenuProtection"></div>
    </div>

    <!-- Firebase and other libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script src="config.js"></script>

<script>
        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appContainer = document.getElementById('app');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        let analytics;

        // App State
        let currentUser = null;
        let userRole = null;
        let userData = null;
        let currentSection = null;
        let currentSession = null;
        let activeSessionListener = null;
        let activeAttendanceListener = null;
        let activeStudentsListener = null;
        let activeSectionsListener = null;

        // Initialize the app
        function initApp() {
            // Check auth state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    await loadUserData();

                    // Hide auth screen and show app
                    authScreen.style.display = 'none';
                    appContainer.style.display = 'flex';

                    // Initialize analytics if consented
                    if (userData.analyticsConsent) {
                        analytics = firebase.analytics();
                        logEvent('login');
                    }

                    // Setup the UI based on user role
                    setupUI();

                    // Check for active session
                    checkActiveSession();
                } else {
                    // User is signed out
                    currentUser = null;
                    userData = null;

                    // Show auth screen and hide app
                    authScreen.style.display = 'flex';
                    appContainer.style.display = 'none';

                    // Show role selection
                    showRoleSelection();
                }
            });

            // Setup event listeners
            setupEventListeners();
        }

        // Load user data from Firestore
        async function loadUserData() {
            showLoading('Loading your data...');

            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    userData = doc.data();
                    userRole = userData.role;

                    // Set up real-time listeners for user data
                    setupUserDataListeners();
                } else {
                    // Shouldn't happen as we create user doc on sign up
                    console.error('User document not found');
                    showToast('Error loading your data. Please try again.', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading your data. Please try again.', 'error');
                await auth.signOut();
            }

            hideLoading();
        }

        // Set up real-time listeners for user data
        function setupUserDataListeners() {
            // Listen for user data changes
            db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const newData = doc.data();
                    userData = newData;

                    // Update UI elements that depend on user data
                    updateUserProfileUI();

                    // Check if role changed (shouldn't happen normally)
                    if (userRole !== newData.role) {
                        userRole = newData.role;
                        setupUI();
                    }
                }
            });

            // Listen for sections changes if teacher
            if (userRole === 'teacher') {
                setupTeacherListeners();
            } else if (userRole === 'student') {
                setupStudentListeners();
            }
        }

        // Set up listeners for teacher-specific data
        function setupTeacherListeners() {
            // Clear previous listeners
            if (activeSectionsListener) activeSectionsListener();
            if (activeSessionListener) activeSessionListener();
            if (activeStudentsListener) activeStudentsListener();
            if (activeAttendanceListener) activeAttendanceListener();

            // Listen for teacher's sections
            activeSectionsListener = db.collection('sections')
                .where('teacherId', '==', currentUser.uid)
                .onSnapshot((querySnapshot) => {
                    updateSectionsUI(querySnapshot.docs);
                }, (error) => {
                    console.error('Error listening to sections:', error);
                });
        }

        // Set up listeners for student-specific data
        function setupStudentListeners() {
            // Clear previous listeners
            if (activeSectionsListener) activeSectionsListener();
            if (activeSessionListener) activeSessionListener();

            // Listen for student's sections
            activeSectionsListener = db.collection('sectionStudents')
                .where('studentId', '==', currentUser.uid)
                .onSnapshot(async (querySnapshot) => {
                    const sectionIds = querySnapshot.docs.map(doc => doc.data().sectionId);
                    if (sectionIds.length > 0) {
                        const sectionsSnapshot = await db.collection('sections')
                            .where(firebase.firestore.FieldPath.documentId(), 'in', sectionIds)
                            .get();
                        updateSectionsUI(sectionsSnapshot.docs);
                    } else {
                        updateSectionsUI([]);
                    }
                }, (error) => {
                    console.error('Error listening to student sections:', error);
                });
        }

        // Check if user has an active session
        async function checkActiveSession() {
            if (userRole === 'teacher') {
                const sessionQuery = await db.collection('sessions')
                    .where('teacherId', '==', currentUser.uid)
                    .where('ended', '==', false)
                    .limit(1)
                    .get();

                if (!sessionQuery.empty) {
                    currentSession = sessionQuery.docs[0].data();
                    currentSession.id = sessionQuery.docs[0].id;
                    showSessionDetail(currentSession);
                }
            } else if (userRole === 'student') {
                // Check if student is in any sections
                const sectionStudentsQuery = await db.collection('sectionStudents')
                    .where('studentId', '==', currentUser.uid)
                    .get();

                if (!sectionStudentsQuery.empty) {
                    const sectionIds = sectionStudentsQuery.docs.map(doc => doc.data().sectionId);

                    // Check for active sessions in these sections
                    const sessionQuery = await db.collection('sessions')
                        .where('sectionId', 'in', sectionIds)
                        .where('ended', '==', false)
                        .limit(1)
                        .get();

                    if (!sessionQuery.empty) {
                        currentSession = sessionQuery.docs[0].data();
                        currentSession.id = sessionQuery.docs[0].id;

                        // Check if this is the student's first time seeing this session
                        const lastNotified = localStorage.getItem(`lastNotified_${currentSession.id}`);
                        if (!lastNotified || lastNotified !== currentSession.id) {
                            showCheckInPrompt();
                            localStorage.setItem(`lastNotified_${currentSession.id}`, currentSession.id);
                        }
                    }
                }
            }
        }

        // Setup UI based on user role
        function setupUI() {
            // Update greeting based on time of day
            updateGreeting();

            // Update user profile in UI
            updateUserProfileUI();

            // Set up sidebar navigation
            setupSidebarNavigation();

            // Show dashboard by default
            showPage('dashboard');

            // Show appropriate content based on role
            if (userRole === 'teacher') {
                document.getElementById('startSessionBtn').style.display = 'block';
                document.getElementById('removeStudentBtn').style.display = 'block';
            } else {
                document.getElementById('startSessionBtn').style.display = 'none';
                document.getElementById('removeStudentBtn').style.display = 'none';
            }
        }

        // Update greeting based on time of day
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting;

            if (hour < 12) {
                greeting = 'Good morning';
            } else if (hour < 18) {
                greeting = 'Good afternoon';
            } else {
                greeting = 'Good evening';
            }

            document.getElementById('greetingTime').textContent = greeting;

            if (userData && userData.displayName) {
                document.getElementById('userDisplayName').textContent = userData.displayName;
            }
        }

        // Update user profile in UI
        function updateUserProfileUI() {
            if (!userData) return;

            // Update avatar
            const avatar = document.getElementById('userAvatar');
            const profileAvatar = document.getElementById('profileAvatar');

            if (userData.avatarType === 'emoji') {
                avatar.innerHTML = `<span class="avatar-emoji">${userData.avatarValue}</span>`;
                profileAvatar.innerHTML = `<span class="avatar-emoji">${userData.avatarValue}</span>`;
            } else {
                avatar.innerHTML = `<span class="avatar-initials">${userData.avatarValue}</span>`;
                profileAvatar.innerHTML = `<span class="avatar-initials">${userData.avatarValue}</span>`;
            }

            avatar.style.backgroundColor = userData.avatarColor;
            profileAvatar.style.backgroundColor = userData.avatarColor;

            // Update profile info
            document.getElementById('profileUsername').textContent = userData.username;
            document.getElementById('profileRole').textContent = `Role: ${userData.role === 'teacher' ? 'Teacher' : 'Student'}`;
            document.getElementById('profileFullName').value = userData.fullName || '';
            document.getElementById('profileEmail').value = currentUser.email || '';

            const createdAt = userData.createdAt?.toDate();
            if (createdAt) {
                document.getElementById('profileCreatedAt').value = createdAt.toLocaleString();
            }

            // Update analytics toggle
            document.getElementById('analyticsToggle').checked = userData.analyticsConsent || false;
        }

        // Set up sidebar navigation
        function setupSidebarNavigation() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');

            sidebarItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    sidebarItems.forEach(i => i.classList.remove('active'));

                    // Add active class to clicked item
                    item.classList.add('active');

                    // Show the corresponding page
                    const page = item.getAttribute('data-page');
                    showPage(page);

                    // Close sidebar on mobile
                    if (window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    showToast('You have been signed out', 'success');
                }).catch(error => {
                    console.error('Error signing out:', error);
                    showToast('Error signing out. Please try again.', 'error');
                });
            });

            // Mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // User avatar click
            document.getElementById('userAvatar').addEventListener('click', () => {
                showBottomSheet('profileBottomSheet');
            });
        }

        // Show a page and hide others
        function showPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.style.display = 'none';
            });

            // Show the requested page
            const pageToShow = document.getElementById(`${pageId}Page`);
            if (pageToShow) {
                pageToShow.style.display = 'block';

                // Load data for the page if needed
                if (pageId === 'dashboard') {
                    loadDashboardData();
                } else if (pageId === 'sections') {
                    loadSectionsData();
                } else if (pageId === 'attendance') {
                    loadAttendanceData();
                }
            }
        }

        // Load data for dashboard
        function loadDashboardData() {
            if (userRole === 'teacher') {
                // Load teacher's sections
                db.collection('sections')
                    .where('teacherId', '==', currentUser.uid)
                    .get()
                    .then(querySnapshot => {
                        updateSectionsCarouselUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        showToast('Error loading your sections', 'error');
                    });

                // Load recent attendance
                db.collection('attendance')
                    .where('teacherId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get()
                    .then(querySnapshot => {
                        updateRecentAttendanceUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading attendance:', error);
                    });
            } else {
                // Load student's sections
                db.collection('sectionStudents')
                    .where('studentId', '==', currentUser.uid)
                    .get()
                    .then(async querySnapshot => {
                        const sectionIds = querySnapshot.docs.map(doc => doc.data().sectionId);
                        if (sectionIds.length > 0) {
                            const sectionsSnapshot = await db.collection('sections')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', sectionIds)
                                .get();
                            updateSectionsCarouselUI(sectionsSnapshot.docs);
                        } else {
                            updateSectionsCarouselUI([]);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        showToast('Error loading your sections', 'error');
                    });

                // Load student's recent attendance
                db.collection('attendance')
                    .where('studentId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get()
                    .then(querySnapshot => {
                        updateRecentAttendanceUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading attendance:', error);
                    });
            }
        }

        // Load data for sections page
        function loadSectionsData() {
            if (userRole === 'teacher') {
                db.collection('sections')
                    .where('teacherId', '==', currentUser.uid)
                    .get()
                    .then(querySnapshot => {
                        updateSectionsUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        showToast('Error loading your sections', 'error');
                    });
            } else {
                db.collection('sectionStudents')
                    .where('studentId', '==', currentUser.uid)
                    .get()
                    .then(async querySnapshot => {
                        const sectionIds = querySnapshot.docs.map(doc => doc.data().sectionId);
                        if (sectionIds.length > 0) {
                            const sectionsSnapshot = await db.collection('sections')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', sectionIds)
                                .get();
                            updateSectionsUI(sectionsSnapshot.docs);
                        } else {
                            updateSectionsUI([]);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        showToast('Error loading your sections', 'error');
                    });
            }
        }

        // Load data for attendance page
        function loadAttendanceData() {
            if (userRole === 'teacher') {
                db.collection('attendance')
                    .where('teacherId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get()
                    .then(querySnapshot => {
                        updateAttendanceUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading attendance:', error);
                        showToast('Error loading attendance records', 'error');
                    });
            } else {
                db.collection('attendance')
                    .where('studentId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get()
                    .then(querySnapshot => {
                        updateAttendanceUI(querySnapshot.docs);
                    })
                    .catch(error => {
                        console.error('Error loading attendance:', error);
                        showToast('Error loading attendance records', 'error');
                    });
            }
        }

        // Update sections carousel UI
        function updateSectionsCarouselUI(sectionDocs) {
            const carousel = document.getElementById('sectionsCarousel');

            if (sectionDocs.length === 0) {
                carousel.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">class</span>
                        <h3 class="empty-state-title">No Sections Yet</h3>
                        <p class="empty-state-text">Create or join a section to get started with attendance tracking.</p>
                        ${userRole === 'teacher' ? '<button class="btn btn-primary" id="createSectionBtn">Create Section</button>' : ''}
                    </div>
                `;

                if (userRole === 'teacher') {
                    document.getElementById('createSectionBtn').addEventListener('click', () => {
                        showBottomSheet('createSectionBottomSheet');
                    });
                }

                return;
            }

            carousel.innerHTML = '';

            sectionDocs.forEach(doc => {
                const section = doc.data();
                section.id = doc.id;

                const sectionCard = document.createElement('div');
                sectionCard.className = 'section-card';
                sectionCard.innerHTML = `
                    <h3 class="section-card-title">
                        <span class="material-icons section-card-icon">class</span>
                        <span>${section.name}</span>
                    </h3>
                    <p class="section-card-subject">${section.subject || 'No subject specified'}</p>
                    <p class="section-card-schedule">
                        <span class="material-icons">schedule</span>
                        <span>${formatSchedule(section.scheduleDays, section.scheduleTime)}</span>
                    </p>
                    <div class="section-card-actions">
                        <button class="btn btn-secondary btn-sm view-section-btn" data-section-id="${section.id}">
                            <span class="material-icons">visibility</span>
                            View
                        </button>
                    </div>
                `;

                carousel.appendChild(sectionCard);

                // Add event listener to view button
                sectionCard.querySelector('.view-section-btn').addEventListener('click', () => {
                    showSectionDetail(section);
                });
            });
        }

        // Update sections list UI
        function updateSectionsUI(sectionDocs) {
            const sectionsList = document.getElementById('sectionsList');

            if (sectionDocs.length === 0) {
                sectionsList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">class</span>
                        <h3 class="empty-state-title">No Sections Yet</h3>
                        <p class="empty-state-text">Create or join a section to get started with attendance tracking.</p>
                        ${userRole === 'teacher' ? '<button class="btn btn-primary" id="createSectionBtn4">Create Section</button>' : ''}
                    </div>
                `;

                if (userRole === 'teacher') {
                    document.getElementById('createSectionBtn4').addEventListener('click', () => {
                        showBottomSheet('createSectionBottomSheet');
                    });
                }

                return;
            }

            sectionsList.innerHTML = '';

            sectionDocs.forEach(doc => {
                const section = doc.data();
                section.id = doc.id;

                const sectionItem = document.createElement('div');
                sectionItem.className = 'attendance-card';
                sectionItem.innerHTML = `
                    <div class="attendance-avatar" style="background-color: ${stringToColor(section.name)};">
                        <span class="avatar-initials">${getInitials(section.name)}</span>
                    </div>
                    <div class="attendance-info">
                        <h3 class="attendance-name">${section.name}</h3>
                        <p class="attendance-time">${section.subject || 'No subject specified'}</p>
                    </div>
                    <button class="btn btn-icon view-section-btn" data-section-id="${section.id}">
                        <span class="material-icons">chevron_right</span>
                    </button>
                `;

                sectionsList.appendChild(sectionItem);

                // Add event listener to view button
                sectionItem.querySelector('.view-section-btn').addEventListener('click', () => {
                    showSectionDetail(section);
                });
            });
        }

        // Update recent attendance UI
        function updateRecentAttendanceUI(attendanceDocs) {
            const attendanceList = document.getElementById('recentAttendanceList');

            if (attendanceDocs.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">checklist</span>
                        <h3 class="empty-state-title">No Attendance Records</h3>
                        <p class="empty-state-text">Your attendance records will appear here once you start checking in.</p>
                    </div>
                `;
                return;
            }

            attendanceList.innerHTML = '';

            // We'll need to fetch student/teacher names to display
            const promises = attendanceDocs.map(async doc => {
                const attendance = doc.data();
                attendance.id = doc.id;

                let userDoc;
                if (userRole === 'teacher') {
                    // For teachers, show student names
                    userDoc = await db.collection('users').doc(attendance.studentId).get();
                } else {
                    // For students, show section names
                    const sectionDoc = await db.collection('sections').doc(attendance.sectionId).get();
                    return {
                        attendance,
                        section: sectionDoc.data()
                    };
                }

                return {
                    attendance,
                    user: userDoc.data()
                };
            });

            Promise.all(promises).then(results => {
                results.forEach(result => {
                    const {
                        attendance
                    } = result;
                    const attendanceItem = document.createElement('div');
                    attendanceItem.className = 'attendance-card';

                    if (userRole === 'teacher') {
                        const {
                            user
                        } = result;
                        attendanceItem.innerHTML = `
                            <div class="attendance-avatar" style="background-color: ${user.avatarColor}">
                                ${user.avatarType === 'emoji' ? 
                                    `<span class="avatar-emoji">${user.avatarValue}</span>` : 
                                    `<span class="avatar-initials">${user.avatarValue}</span>`}
                            </div>
                            <div class="attendance-info">
                                <h3 class="attendance-name">${user.fullName || 'Student'}</h3>
                                <p class="attendance-time">${attendance.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <span class="attendance-status ${getStatusClass(attendance.status)}">
                                ${attendance.status}
                                ${attendance.points > 0 ? `(+${attendance.points})` : ''}
                            </span>
                        `;
                    } else {
                        const {
                            section
                        } = result;
                        attendanceItem.innerHTML = `
                            <div class="attendance-avatar" style="background-color: ${stringToColor(section.name)};">
                                <span class="avatar-initials">${getInitials(section.name)}</span>
                            </div>
                            <div class="attendance-info">
                                <h3 class="attendance-name">${section.name}</h3>
                                <p class="attendance-time">${attendance.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <span class="attendance-status ${getStatusClass(attendance.status)}">
                                ${attendance.status}
                                ${attendance.points > 0 ? `(+${attendance.points})` : ''}
                            </span>
                        `;
                    }

                    attendanceList.appendChild(attendanceItem);
                });
            }).catch(error => {
                console.error('Error loading attendance details:', error);
            });
        }

        // Update attendance UI
        function updateAttendanceUI(attendanceDocs) {
            const attendanceRecords = document.getElementById('attendanceRecords');

            if (attendanceDocs.length === 0) {
                attendanceRecords.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">checklist</span>
                        <h3 class="empty-state-title">No Attendance Records</h3>
                        <p class="empty-state-text">Your attendance records will appear here once you start checking in.</p>
                    </div>
                `;
                return;
            }

            attendanceRecords.innerHTML = '';

            // We'll need to fetch student/teacher names to display
            const promises = attendanceDocs.map(async doc => {
                const attendance = doc.data();
                attendance.id = doc.id;

                let userDoc, sectionDoc;
                if (userRole === 'teacher') {
                    // For teachers, show student names and section names
                    userDoc = await db.collection('users').doc(attendance.studentId).get();
                    sectionDoc = await db.collection('sections').doc(attendance.sectionId).get();
                } else {
                    // For students, show section names and teacher names
                    sectionDoc = await db.collection('sections').doc(attendance.sectionId).get();
                    userDoc = await db.collection('users').doc(sectionDoc.data().teacherId).get();
                }

                return {
                    attendance,
                    user: userDoc.data(),
                    section: sectionDoc.data()
                };
            });

            Promise.all(promises).then(results => {
                results.forEach(result => {
                    const {
                        attendance,
                        user,
                        section
                    } = result;
                    const attendanceItem = document.createElement('div');
                    attendanceItem.className = 'attendance-card';

                    if (userRole === 'teacher') {
                        attendanceItem.innerHTML = `
                            <div class="attendance-avatar" style="background-color: ${user.avatarColor}">
                                ${user.avatarType === 'emoji' ? 
                                    `<span class="avatar-emoji">${user.avatarValue}</span>` : 
                                    `<span class="avatar-initials">${user.avatarValue}</span>`}
                            </div>
                            <div class="attendance-info">
                                <h3 class="attendance-name">${user.fullName || 'Student'}</h3>
                                <p class="attendance-time">${section.name} • ${attendance.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <span class="attendance-status ${getStatusClass(attendance.status)}">
                                ${attendance.status}
                                ${attendance.points > 0 ? `(+${attendance.points})` : ''}
                            </span>
                        `;
                    } else {
                        attendanceItem.innerHTML = `
                            <div class="attendance-avatar" style="background-color: ${stringToColor(section.name)};">
                                <span class="avatar-initials">${getInitials(section.name)}</span>
                            </div>
                            <div class="attendance-info">
                                <h3 class="attendance-name">${section.name}</h3>
                                <p class="attendance-time">${user.fullName || 'Teacher'} • ${attendance.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <span class="attendance-status ${getStatusClass(attendance.status)}">
                                ${attendance.status}
                                ${attendance.points > 0 ? `(+${attendance.points})` : ''}
                            </span>
                        `;
                    }

                    attendanceRecords.appendChild(attendanceItem);
                });
            }).catch(error => {
                console.error('Error loading attendance details:', error);
            });
        }

        // Show section detail
        async function showSectionDetail(section) {
            currentSection = section;

            // Update section info
            document.getElementById('sectionDetailTitle').querySelector('span:last-child').textContent = section.name;
            document.getElementById('sectionName').textContent = section.name;
            document.getElementById('sectionSubject').textContent = section.subject || 'No subject specified';
            document.getElementById('sectionSchedule').querySelector('span:last-child').textContent =
                `Schedule: ${formatSchedule(section.scheduleDays, section.scheduleTime)}`;
            document.getElementById('sectionRadius').querySelector('span:last-child').textContent =
                `Check-in radius: ${section.radius || 10} meters`;

            // Format created date
            if (section.createdAt && section.createdAt.toDate) {
                const createdAt = section.createdAt.toDate();
                document.getElementById('sectionCreated').querySelector('span:last-child').textContent =
                    `Created: ${createdAt.toLocaleDateString()}`;
            }

            // Show location if available
            if (section.location) {
                document.getElementById('sectionLocation').querySelector('span:last-child').textContent =
                    `Location: ${section.location.latitude.toFixed(4)}, ${section.location.longitude.toFixed(4)}`;
            } else {
                document.getElementById('sectionLocation').querySelector('span:last-child').textContent =
                    'Location: Set on session start';
            }

            // Load students for this section
            showLoading('Loading students...');

            try {
                const studentsQuery = await db.collection('sectionStudents')
                    .where('sectionId', '==', section.id)
                    .get();

                const studentIds = studentsQuery.docs.map(doc => doc.data().studentId);

                if (studentIds.length > 0) {
                    const studentsSnapshot = await db.collection('users')
                        .where(firebase.firestore.FieldPath.documentId(), 'in', studentIds)
                        .get();

                    updateStudentsUI(studentsSnapshot.docs);
                } else {
                    updateStudentsUI([]);
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showToast('Error loading students', 'error');
                updateStudentsUI([]);
            }

            hideLoading();

            // Hide all pages and show section detail
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.style.display = 'none';
            });

            document.getElementById('sectionDetailPage').style.display = 'block';
        }

        // Update students UI
        function updateStudentsUI(studentDocs) {
            const studentsList = document.getElementById('studentsList');

            if (studentDocs.length === 0) {
                studentsList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">group</span>
                        <h3 class="empty-state-title">No Students Yet</h3>
                        <p class="empty-state-text">Share the section invite link or QR code to add students.</p>
                    </div>
                `;
                return;
            }

            studentsList.innerHTML = '';

            studentDocs.forEach(doc => {
                const student = doc.data();
                student.id = doc.id;

                const studentItem = document.createElement('div');
                studentItem.className = 'attendance-card';
                studentItem.innerHTML = `
                    <div class="attendance-avatar" style="background-color: ${student.avatarColor}">
                        ${student.avatarType === 'emoji' ? 
                            `<span class="avatar-emoji">${student.avatarValue}</span>` : 
                            `<span class="avatar-initials">${student.avatarValue}</span>`}
                    </div>
                    <div class="attendance-info">
                        <h3 class="attendance-name">${student.fullName || 'Student'}</h3>
                        <p class="attendance-time">${student.username}</p>
                    </div>
                    <button class="btn btn-icon view-student-btn" data-student-id="${student.id}">
                        <span class="material-icons">chevron_right</span>
                    </button>
                `;

                studentsList.appendChild(studentItem);

                // Add event listener to view button
                studentItem.querySelector('.view-student-btn').addEventListener('click', () => {
                    showStudentProfile(student);
                });
            });
        }

        // Show student profile
        async function showStudentProfile(student) {
            // Update student info
            document.getElementById('studentProfileName').textContent = student.fullName || 'Student';
            document.getElementById('studentProfileUsername').textContent = student.username;

            // Set avatar
            const studentAvatar = document.getElementById('studentProfileAvatar');
            studentAvatar.style.backgroundColor = student.avatarColor;
            if (student.avatarType === 'emoji') {
                studentAvatar.innerHTML = `<span class="avatar-emoji">${student.avatarValue}</span>`;
            } else {
                studentAvatar.innerHTML = `<span class="avatar-initials">${student.avatarValue}</span>`;
            }

            // Get join date for this section
            const sectionStudentDoc = await db.collection('sectionStudents')
                .where('sectionId', '==', currentSection.id)
                .where('studentId', '==', student.id)
                .limit(1)
                .get();

            if (!sectionStudentDoc.empty) {
                const joinedAt = sectionStudentDoc.docs[0].data().joinedAt.toDate();
                document.getElementById('studentJoinedDate').value = joinedAt.toLocaleDateString();
            }

            // Get total plus points for this student in this section
            const attendanceQuery = await db.collection('attendance')
                .where('sectionId', '==', currentSection.id)
                .where('studentId', '==', student.id)
                .where('status', '==', 'present')
                .get();

            const totalPoints = attendanceQuery.docs.reduce((sum, doc) => sum + (doc.data().points || 0), 0);
            document.getElementById('studentPlusPoints').value = totalPoints;

            // Calculate attendance rate
            const totalSessionsQuery = await db.collection('sessions')
                .where('sectionId', '==', currentSection.id)
                .get();

            const totalSessions = totalSessionsQuery.size;
            const attendedSessions = attendanceQuery.size;
            const attendanceRate = totalSessions > 0 ? Math.round((attendedSessions / totalSessions) * 100) : 0;

            document.getElementById('studentAttendanceRate').value = `${attendanceRate}%`;

            // Show remove button for teachers
            if (userRole === 'teacher') {
                document.getElementById('removeStudentBtn').style.display = 'block';
                document.getElementById('removeStudentBtn').onclick = () => {
                    if (confirm('Are you sure you want to remove this student from the section?')) {
                        removeStudentFromSection(student.id);
                    }
                };
            } else {
                document.getElementById('removeStudentBtn').style.display = 'none';
            }

            showBottomSheet('studentProfileBottomSheet');
        }

        // Remove student from section
        async function removeStudentFromSection(studentId) {
            showLoading('Removing student...');

            try {
                // Find the sectionStudent document
                const sectionStudentQuery = await db.collection('sectionStudents')
                    .where('sectionId', '==', currentSection.id)
                    .where('studentId', '==', studentId)
                    .limit(1)
                    .get();

                if (!sectionStudentQuery.empty) {
                    // Delete the document
                    await db.collection('sectionStudents').doc(sectionStudentQuery.docs[0].id).delete();

                    showToast('Student removed from section', 'success');
                    closeBottomSheet('studentProfileBottomSheet');

                    // Refresh students list
                    loadStudentsForCurrentSection();
                } else {
                    showToast('Student not found in section', 'error');
                }
            } catch (error) {
                console.error('Error removing student:', error);
                showToast('Error removing student', 'error');
            }

            hideLoading();
        }

        // Load students for current section
        async function loadStudentsForCurrentSection() {
            if (!currentSection) return;

            showLoading('Loading students...');

            try {
                const studentsQuery = await db.collection('sectionStudents')
                    .where('sectionId', '==', currentSection.id)
                    .get();

                const studentIds = studentsQuery.docs.map(doc => doc.data().studentId);

                if (studentIds.length > 0) {
                    const studentsSnapshot = await db.collection('users')
                        .where(firebase.firestore.FieldPath.documentId(), 'in', studentIds)
                        .get();

                    updateStudentsUI(studentsSnapshot.docs);
                } else {
                    updateStudentsUI([]);
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showToast('Error loading students', 'error');
                updateStudentsUI([]);
            }

            hideLoading();
        }

        // Show session detail
        function showSessionDetail(session) {
            currentSession = session;

            // Update session info
            document.getElementById('sessionTimer').textContent = '00:00';

            if (session.location) {
                document.getElementById('sessionLocationText').textContent =
                    `Location: ${session.location.latitude.toFixed(4)}, ${session.location.longitude.toFixed(4)}`;
            } else {
                document.getElementById('sessionLocationText').textContent = 'Location: Not set';
            }

            document.getElementById('sessionRadiusText').textContent =
                `Check-in radius: ${session.radius || 10} meters`;

            // Generate QR code for session
            generateSessionQRCode();

            // Start session timer
            startSessionTimer();

            // Load attendance for this session
            loadSessionAttendance();

            // Hide all pages and show session detail
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.style.display = 'none';
            });

            document.getElementById('sessionDetailPage').style.display = 'block';
        }

        // Generate QR code for session
        function generateSessionQRCode() {
            const qrCodeElement = document.getElementById('sessionQRCode');
            qrCodeElement.innerHTML = '';

            const inviteLink = `${window.location.origin}?sectionId=${currentSection.id}&sessionId=${currentSession.id}`;

            QRCode.toCanvas(qrCodeElement, inviteLink, {
                width: 200
            }, (error) => {
                if (error) {
                    console.error('Error generating QR code:', error);
                    qrCodeElement.innerHTML = '<span class="material-icons" style="font-size: 48px; color: #ccc;">qr_code</span>';
                }
            });
        }

        // Start session timer
        function startSessionTimer() {
            if (!currentSession) return;

            // Clear previous interval if exists
            if (currentSession.timerInterval) {
                clearInterval(currentSession.timerInterval);
            }

            const startTime = currentSession.startedAt.toDate();
            const timerElement = document.getElementById('sessionTimer');

            // Update timer immediately
            updateTimer();

            // Update timer every second
            currentSession.timerInterval = setInterval(updateTimer, 1000);

            function updateTimer() {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000); // Difference in seconds

                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;

                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Load attendance for current session
        async function loadSessionAttendance() {
            if (!currentSession) return;

            showLoading('Loading attendance...');

            try {
                const attendanceQuery = await db.collection('attendance')
                    .where('sessionId', '==', currentSession.id)
                    .orderBy('timestamp', 'desc')
                    .get();

                updateSessionAttendanceUI(attendanceQuery.docs);

                // Set up real-time listener for new attendance
                if (activeAttendanceListener) activeAttendanceListener();

                activeAttendanceListener = db.collection('attendance')
                    .where('sessionId', '==', currentSession.id)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(querySnapshot => {
                        updateSessionAttendanceUI(querySnapshot.docs);
                    }, error => {
                        console.error('Error listening to attendance:', error);
                    });
            } catch (error) {
                console.error('Error loading attendance:', error);
                showToast('Error loading attendance', 'error');
                updateSessionAttendanceUI([]);
            }

            hideLoading();
        }

        // Update session attendance UI
        function updateSessionAttendanceUI(attendanceDocs) {
            const attendanceList = document.getElementById('sessionAttendanceList');

            if (attendanceDocs.length === 0) {
                attendanceList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">checklist</span>
                        <h3 class="empty-state-title">No Check-ins Yet</h3>
                        <p class="empty-state-text">Student check-ins will appear here as they join the session.</p>
                    </div>
                `;
                return;
            }

            attendanceList.innerHTML = '';

            // We need to fetch student names
            const promises = attendanceDocs.map(async doc => {
                const attendance = doc.data();
                attendance.id = doc.id;

                const studentDoc = await db.collection('users').doc(attendance.studentId).get();
                return {
                    attendance,
                    student: studentDoc.data()
                };
            });

            Promise.all(promises).then(results => {
                results.forEach(result => {
                    const {
                        attendance,
                        student
                    } = result;
                    const attendanceItem = document.createElement('div');
                    attendanceItem.className = 'attendance-card';

                    attendanceItem.innerHTML = `
                        <div class="attendance-avatar" style="background-color: ${student.avatarColor}">
                            ${student.avatarType === 'emoji' ? 
                                `<span class="avatar-emoji">${student.avatarValue}</span>` : 
                                `<span class="avatar-initials">${student.avatarValue}</span>`}
                        </div>
                        <div class="attendance-info">
                            <h3 class="attendance-name">${student.fullName || 'Student'}</h3>
                            <p class="attendance-time">${attendance.timestamp.toDate().toLocaleString()}</p>
                        </div>
                        <span class="attendance-status ${getStatusClass(attendance.status)}">
                            ${attendance.status}
                            ${attendance.points > 0 ? `(+${attendance.points})` : ''}
                        </span>
                    `;

                    attendanceList.appendChild(attendanceItem);
                });
            }).catch(error => {
                console.error('Error loading student details:', error);
            });
        }

        // Show check-in prompt for students
        function showCheckInPrompt() {
            if (!currentSession || userRole !== 'student') return;

            // Show bottom sheet with check-in options
            const bottomSheet = document.createElement('div');
            bottomSheet.className = 'bottom-sheet';
            bottomSheet.innerHTML = `
                <div class="bottom-sheet-header">
                    <h3 class="bottom-sheet-title">Active Session</h3>
                    <button class="bottom-sheet-close" id="closeCheckInPrompt">&times;</button>
                </div>
                <div class="bottom-sheet-body">
                    <p>An active session has begun, earning you bonus points.</p>
                    <div class="text-center my-3">
                        <h2 id="checkInPromptTimer">00:00</h2>
                        <p class="text-muted">Time remaining for maximum points</p>
                    </div>
                </div>
                <div class="bottom-sheet-footer">
                    <button class="btn btn-secondary" id="checkInLaterBtn">Later</button>
                    <button class="btn btn-primary" id="checkInNowBtn">Check-in Now</button>
                </div>
            `;

            document.body.appendChild(bottomSheet);

            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'bottom-sheet-backdrop open';
            backdrop.id = 'checkInPromptBackdrop';
            document.body.appendChild(backdrop);

            // Start timer
            const startTime = currentSession.startedAt.toDate();
            const timerElement = document.getElementById('checkInPromptTimer');

            function updateTimer() {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000); // Difference in seconds

                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;

                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);

            // Event listeners
            document.getElementById('closeCheckInPrompt').addEventListener('click', closeCheckInPrompt);
            document.getElementById('checkInLaterBtn').addEventListener('click', closeCheckInPrompt);
            document.getElementById('checkInNowBtn').addEventListener('click', () => {
                closeCheckInPrompt();
                showCheckInPage();
            });

            function closeCheckInPrompt() {
                clearInterval(timerInterval);
                bottomSheet.remove();
                backdrop.remove();
            }
        }

        // Show check-in page
        function showCheckInPage() {
            if (!currentSession || userRole !== 'student') return;

            // Update check-in page info
            document.getElementById('checkInSectionName').textContent = currentSection.name;

            // Set session status
            document.getElementById('checkInSessionStatus').querySelector('span:last-child').textContent =
                'Session is active';
            document.getElementById('checkInSessionStatus').querySelector('span.material-icons').textContent = 'check_circle';
            document.getElementById('checkInSessionStatus').querySelector('span.material-icons').style.color = 'var(--secondary-color)';

            // Set session time
            const startTime = currentSession.startedAt.toDate();
            document.getElementById('checkInSessionTime').querySelector('span:last-child').textContent =
                `Session started at ${startTime.toLocaleTimeString()}`;

            // Set plus points info
            if (currentSession.plusPoints) {
                document.getElementById('checkInPointsInfo').querySelector('span:last-child').textContent =
                    `Plus Points: ${currentSession.minPoints}-${currentSession.maxPoints} points possible`;
            } else {
                document.getElementById('checkInPointsInfo').querySelector('span:last-child').textContent =
                    'Plus Points: Not enabled for this session';
            }

            // Start check-in timer
            startCheckInTimer();

            // Check location
            checkLocationForCheckIn();

            // Hide all pages and show check-in page
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.style.display = 'none';
            });

            document.getElementById('checkInPage').style.display = 'block';
        }

        // Start check-in timer
        function startCheckInTimer() {
            if (!currentSession || !currentSession.plusPoints) return;

            // Clear previous interval if exists
            if (currentSession.checkInTimerInterval) {
                clearInterval(currentSession.checkInTimerInterval);
            }

            const startTime = currentSession.startedAt.toDate();
            const timerElement = document.getElementById('checkInTimer');

            // Update timer immediately
            updateTimer();

            // Update timer every second
            currentSession.checkInTimerInterval = setInterval(updateTimer, 1000);

            function updateTimer() {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000); // Difference in seconds
                const remaining = Math.max(0, currentSession.duration * 60 - diff);

                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;

                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Check location for check-in
        function checkLocationForCheckIn() {
            if (!currentSession || userRole !== 'student') return;

            document.getElementById('checkInLocationStatus').textContent = 'Checking your location...';
            document.getElementById('checkInDistance').textContent = 'Distance from session: Calculating...';
            document.getElementById('checkInBtn').disabled = true;

            if (!navigator.geolocation) {
                document.getElementById('checkInLocationStatus').textContent = 'Geolocation is not supported by your browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    document.getElementById('checkInLocationStatus').textContent =
                        `Your location: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;

                    if (currentSession.location) {
                        const sessionLat = currentSession.location.latitude;
                        const sessionLng = currentSession.location.longitude;

                        const distance = calculateDistance(
                            userLat, userLng,
                            sessionLat, sessionLng
                        );

                        document.getElementById('checkInDistance').textContent =
                            `Distance from session: ${distance.toFixed(1)} meters`;

                        if (distance <= currentSession.radius) {
                            document.getElementById('checkInBtn').disabled = false;
                        } else {
                            document.getElementById('checkInLocationStatus').textContent += ' (Too far)';
                        }
                    } else {
                        document.getElementById('checkInDistance').textContent = 'Session location not set';
                    }
                },
                (error) => {
                    console.error('Error getting location:', error);
                    document.getElementById('checkInLocationStatus').textContent =
                        'Error getting your location. Please make sure location access is granted.';
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Calculate distance between two coordinates in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Show bottom sheet
        function showBottomSheet(sheetId) {
            const bottomSheet = document.getElementById(sheetId);
            const backdrop = document.getElementById('bottomSheetBackdrop');

            bottomSheet.classList.add('open');
            backdrop.classList.add('open');

            // Add event listener to backdrop
            backdrop.onclick = () => {
                closeBottomSheet(sheetId);
            };
        }

        // Close bottom sheet
        function closeBottomSheet(sheetId) {
            const bottomSheet = document.getElementById(sheetId);
            const backdrop = document.getElementById('bottomSheetBackdrop');

            bottomSheet.classList.remove('open');
            backdrop.classList.remove('open');
            backdrop.onclick = null;
        }

        // Show modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = document.getElementById('modalBackdrop');

            modal.classList.add('open');
            backdrop.classList.add('open');

            // Add event listener to backdrop
            backdrop.onclick = () => {
                closeModal(modalId);
            };
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = document.getElementById('modalBackdrop');

            modal.classList.remove('open');
            backdrop.classList.remove('open');
            backdrop.onclick = null;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = `toast toast-${type}`;
            toastMessage.textContent = message;

            // Set icon based on type
            const icon = toast.querySelector('.toast-icon');
            if (type === 'success') {
                icon.textContent = 'check_circle';
            } else if (type === 'error') {
                icon.textContent = 'error';
            } else if (type === 'warning') {
                icon.textContent = 'warning';
            } else {
                icon.textContent = 'info';
            }

            // Show toast
            toast.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show loading overlay
        function showLoading(message = 'Loading...') {
            loadingText.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Format schedule
        function formatSchedule(days, time) {
            let daysText;

            switch (days) {
                case 'MWF':
                    daysText = 'Monday, Wednesday, Friday';
                    break;
                case 'TTh':
                    daysText = 'Tuesday, Thursday';
                    break;
                case 'MW':
                    daysText = 'Monday, Wednesday';
                    break;
                case 'TThF':
                    daysText = 'Tuesday, Thursday, Friday';
                    break;
                case 'M-F':
                    daysText = 'Monday to Friday';
                    break;
                default:
                    daysText = days || 'Not scheduled';
            }

            if (time) {
                return `${daysText} at ${time}`;
            } else {
                return daysText;
            }
        }

        // Get status class
        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'present':
                    return 'status-present';
                case 'absent':
                    return 'status-absent';
                case 'excused':
                    return 'status-excused';
                default:
                    return '';
            }
        }

        // Generate initials from name
        function getInitials(name) {
            if (!name) return '?';

            const parts = name.split(' ');
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();

            return `${parts[0].charAt(0).toUpperCase()}${parts[parts.length - 1].charAt(0).toUpperCase()}`;
        }

        // Generate color from string
        function stringToColor(str) {
            if (!str) return '#4285F4';

            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }

            const h = hash % 360;
            return `hsl(${h}, 70%, 60%)`;
        }

        // Log analytics event
        function logEvent(eventName, eventParams = {}) {
            if (analytics && userData?.analyticsConsent) {
                analytics.logEvent(eventName, eventParams);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth screen event listeners
            document.getElementById('teacherRoleBtn').addEventListener('click', () => {
                document.getElementById('roleSelection').style.display = 'none';
                document.getElementById('teacherSignUpForm').style.display = 'block';
            });

            document.getElementById('studentRoleBtn').addEventListener('click', () => {
                document.getElementById('roleSelection').style.display = 'none';
                document.getElementById('studentSignUpForm').style.display = 'block';
            });

            document.getElementById('haveAccountBtn').addEventListener('click', () => {
                document.getElementById('roleSelection').style.display = 'none';
                document.getElementById('signInForm').style.display = 'block';
            });

            document.getElementById('backToRoleSelectionFromTeacher').addEventListener('click', () => {
                document.getElementById('teacherSignUpForm').style.display = 'none';
                document.getElementById('roleSelection').style.display = 'block';
            });

            document.getElementById('backToRoleSelectionFromStudent').addEventListener('click', () => {
                document.getElementById('studentSignUpForm').style.display = 'none';
                document.getElementById('roleSelection').style.display = 'block';
            });

            document.getElementById('backToRoleSelectionFromSignIn').addEventListener('click', () => {
                document.getElementById('signInForm').style.display = 'none';
                document.getElementById('roleSelection').style.display = 'block';
            });

            // Teacher sign up
            document.getElementById('teacherSignUpBtn').addEventListener('click', async () => {
                const fullName = document.getElementById('teacherFullName').value.trim();
                const email = document.getElementById('teacherEmail').value.trim();
                const password = document.getElementById('teacherPassword').value;
                const confirmPassword = document.getElementById('teacherConfirmPassword').value;
                const agreeTerms = document.getElementById('teacherTermsCheckbox').checked;

                // Validation
                if (!fullName) {
                    showToast('Please enter your full name', 'error');
                    return;
                }

                if (!email) {
                    showToast('Please enter your email', 'error');
                    return;
                }

                if (!password) {
                    showToast('Please enter a password', 'error');
                    return;
                }

                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }

                if (password !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }

                if (!agreeTerms) {
                    showToast('Please agree to the terms and privacy policy', 'error');
                    return;
                }

                showLoading('Creating your account...');

                try {
                    // Show age confirmation for teachers
                    document.getElementById('ageRequirement').textContent = '20 years old or above';
                    showModal('ageConfirmationModal');

                    // Set up confirmation handler
                    document.getElementById('confirmAgeConfirmationBtn').onclick = async () => {
                        closeModal('ageConfirmationModal');

                        // Create user with Firebase Auth
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                        // Generate username
                        const username = `${fullName.split(' ')[0].toLowerCase()}@nearcheck/teacher${Math.random().toString(36).substr(2, 8)}`;

                        // Create user document in Firestore
                        await db.collection('users').doc(userCredential.user.uid).set({
                            fullName,
                            email,
                            username,
                            role: 'teacher',
                            avatarType: 'text',
                            avatarValue: getInitials(fullName),
                            avatarColor: stringToColor(fullName),
                            analyticsConsent: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Show analytics consent modal
                        showModal('analyticsConsentModal');

                        // Set up confirmation handler
                        document.getElementById('confirmAnalyticsConsentBtn').onclick = async () => {
                            const consent = document.getElementById('analyticsConsentCheckbox').checked;

                            // Update user document with consent
                            await db.collection('users').doc(userCredential.user.uid).update({
                                analyticsConsent: consent
                            });

                            closeModal('analyticsConsentModal');

                            // Initialize analytics if consented
                            if (consent) {
                                analytics = firebase.analytics();
                                logEvent('sign_up', {
                                    method: 'email',
                                    role: 'teacher'
                                });
                            }

                            showToast('Account created successfully', 'success');
                        };
                    };
                } catch (error) {
                    console.error('Error creating teacher account:', error);

                    let errorMessage = 'Error creating account. Please try again.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email is already in use. Please use a different email.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                    }

                    showToast(errorMessage, 'error');
                }

                hideLoading();
            });

            // Student sign up
            document.getElementById('studentSignUpBtn').addEventListener('click', async () => {
                const fullName = document.getElementById('studentFullName').value.trim();
                const email = document.getElementById('studentEmail').value.trim();
                const password = document.getElementById('studentPassword').value;
                const confirmPassword = document.getElementById('studentConfirmPassword').value;
                const sectionId = document.getElementById('studentSectionId').value.trim();
                const agreeTerms = document.getElementById('studentTermsCheckbox').checked;

                // Validation
                if (!fullName) {
                    showToast('Please enter your full name', 'error');
                    return;
                }

                if (!email) {
                    showToast('Please enter your email', 'error');
                    return;
                }

                if (!password) {
                    showToast('Please enter a password', 'error');
                    return;
                }

                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }

                if (password !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }

                if (!agreeTerms) {
                    showToast('Please agree to the terms and privacy policy', 'error');
                    return;
                }

                showLoading('Creating your account...');

                try {
                    // Show age confirmation for students
                    document.getElementById('ageRequirement').textContent = '13 years old or above';
                    showModal('ageConfirmationModal');

                    // Set up confirmation handler
                    document.getElementById('confirmAgeConfirmationBtn').onclick = async () => {
                        closeModal('ageConfirmationModal');

                        // Create user with Firebase Auth
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                        // Generate username
                        const username = `${fullName.split(' ')[0].toLowerCase()}@nearcheck/student${Math.random().toString(36).substr(2, 8)}`;

                        // Create user document in Firestore
                        await db.collection('users').doc(userCredential.user.uid).set({
                            fullName,
                            email,
                            username,
                            role: 'student',
                            avatarType: 'text',
                            avatarValue: getInitials(fullName),
                            avatarColor: stringToColor(fullName),
                            analyticsConsent: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Join section if sectionId was provided
                        if (sectionId) {
                            try {
                                // Verify section exists
                                const sectionDoc = await db.collection('sections').doc(sectionId).get();

                                if (sectionDoc.exists) {
                                    await db.collection('sectionStudents').add({
                                        sectionId,
                                        studentId: userCredential.user.uid,
                                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                } else {
                                    showToast('Section not found. You can join later from your dashboard.', 'warning');
                                }
                            } catch (error) {
                                console.error('Error joining section:', error);
                                showToast('Error joining section. You can try again later from your dashboard.', 'warning');
                            }
                        }

                        // Show analytics consent modal
                        showModal('analyticsConsentModal');

                        // Set up confirmation handler
                        document.getElementById('confirmAnalyticsConsentBtn').onclick = async () => {
                            const consent = document.getElementById('analyticsConsentCheckbox').checked;

                            // Update user document with consent
                            await db.collection('users').doc(userCredential.user.uid).update({
                                analyticsConsent: consent
                            });

                            closeModal('analyticsConsentModal');

                            // Initialize analytics if consented
                            if (consent) {
                                analytics = firebase.analytics();
                                logEvent('sign_up', {
                                    method: 'email',
                                    role: 'student'
                                });
                            }

                            showToast('Account created successfully', 'success');
                        };
                    };
                } catch (error) {
                    console.error('Error creating student account:', error);

                    let errorMessage = 'Error creating account. Please try again.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email is already in use. Please use a different email.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                    }

                    showToast(errorMessage, 'error');
                }

                hideLoading();
            });

            // Sign in
            document.getElementById('signInBtn').addEventListener('click', async () => {
                const emailOrUsername = document.getElementById('signInEmail').value.trim();
                const password = document.getElementById('signInPassword').value;
                const rememberMe = document.getElementById('rememberMeCheckbox').checked;

                // Validation
                if (!emailOrUsername) {
                    showToast('Please enter your email or username', 'error');
                    return;
                }

                if (!password) {
                    showToast('Please enter your password', 'error');
                    return;
                }

                showLoading('Signing in...');

                try {
                    // Try to sign in with email (username contains @ which is invalid in email)
                    if (emailOrUsername.includes('@') && !emailOrUsername.includes('@nearcheck')) {
                        await auth.signInWithEmailAndPassword(emailOrUsername, password);
                    } else {
                        // Search for user by username
                        const usersQuery = await db.collection('users')
                            .where('username', '==', emailOrUsername)
                            .limit(1)
                            .get();

                        if (usersQuery.empty) {
                            throw new Error('auth/user-not-found');
                        }

                        const userDoc = usersQuery.docs[0];
                        const userEmail = userDoc.data().email;

                        await auth.signInWithEmailAndPassword(userEmail, password);
                    }

                    // Set persistence based on remember me
                    await auth.setPersistence(rememberMe ?
                        firebase.auth.Auth.Persistence.LOCAL :
                        firebase.auth.Auth.Persistence.SESSION);

                    showToast('Signed in successfully', 'success');
                } catch (error) {
                    console.error('Error signing in:', error);

                    let errorMessage = 'Error signing in. Please try again.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email or username';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many attempts. Please try again later.';
                    }

                    showToast(errorMessage, 'error');
                }

                hideLoading();
            });

            // Create section
            document.getElementById('confirmCreateSectionBtn').addEventListener('click', async () => {
                const name = document.getElementById('sectionNameInput').value.trim();
                const subject = document.getElementById('sectionSubjectInput').value.trim();
                const days = document.getElementById('sectionDaysInput').value;
                const time = document.getElementById('sectionTimeInput').value;
                const radius = parseInt(document.getElementById('sectionRadiusInput').value);
                const plusPoints = document.getElementById('sectionPlusPointsInput').checked;

                // Validation
                if (!name) {
                    showToast('Please enter a section name', 'error');
                    return;
                }

                if (!time) {
                    showToast('Please select a time', 'error');
                    return;
                }

                showLoading('Creating section...');

                try {
                    // Check if teacher has reached section limit
                    const sectionsQuery = await db.collection('sections')
                        .where('teacherId', '==', currentUser.uid)
                        .get();

                    if (sectionsQuery.size >= 9) {
                        showToast('You have reached the maximum number of sections (9)', 'error');
                        hideLoading();
                        return;
                    }

                    // Create section document
                    const sectionRef = await db.collection('sections').add({
                        name,
                        subject,
                        scheduleDays: days,
                        scheduleTime: time,
                        radius,
                        plusPoints,
                        teacherId: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showToast('Section created successfully', 'success');
                    closeBottomSheet('createSectionBottomSheet');

                    // Show the new section
                    const sectionDoc = await sectionRef.get();
                    showSectionDetail(sectionDoc.data());

                    // Log event
                    logEvent('create_section');
                } catch (error) {
                    console.error('Error creating section:', error);
                    showToast('Error creating section. Please try again.', 'error');
                }

                hideLoading();
            });

            // Edit section
            document.getElementById('confirmEditSectionBtn').addEventListener('click', async () => {
                if (!currentSection) return;

                const name = document.getElementById('editSectionNameInput').value.trim();
                const subject = document.getElementById('editSectionSubjectInput').value.trim();
                const days = document.getElementById('editSectionDaysInput').value;
                const time = document.getElementById('editSectionTimeInput').value;
                const radius = parseInt(document.getElementById('editSectionRadiusInput').value);
                const plusPoints = document.getElementById('editSectionPlusPointsInput').checked;

                // Validation
                if (!name) {
                    showToast('Please enter a section name', 'error');
                    return;
                }

                if (!time) {
                    showToast('Please select a time', 'error');
                    return;
                }

                showLoading('Updating section...');

                try {
                    // Update section document
                    await db.collection('sections').doc(currentSection.id).update({
                        name,
                        subject,
                        scheduleDays: days,
                        scheduleTime: time,
                        radius,
                        plusPoints
                    });

                    showToast('Section updated successfully', 'success');
                    closeBottomSheet('editSectionBottomSheet');

                    // Refresh section data
                    const sectionDoc = await db.collection('sections').doc(currentSection.id).get();
                    currentSection = sectionDoc.data();
                    currentSection.id = sectionDoc.id;

                    // Update UI
                    document.getElementById('sectionName').textContent = name;
                    document.getElementById('sectionSubject').textContent = subject || 'No subject specified';
                    document.getElementById('sectionSchedule').querySelector('span:last-child').textContent =
                        `Schedule: ${formatSchedule(days, time)}`;
                    document.getElementById('sectionRadius').querySelector('span:last-child').textContent =
                        `Check-in radius: ${radius} meters`;

                    // Log event
                    logEvent('edit_section');
                } catch (error) {
                    console.error('Error updating section:', error);
                    showToast('Error updating section. Please try again.', 'error');
                }

                hideLoading();
            });

            // Delete section
            document.getElementById('confirmDeleteSectionBtn').addEventListener('click', async () => {
                if (!currentSection) return;

                const password = document.getElementById('deleteSectionPasswordInput').value;
                const confirmDelete = document.getElementById('deleteSectionConfirmInput').checked;

                // Validation
                if (!password) {
                    showToast('Please enter your password', 'error');
                    return;
                }

                if (!confirmDelete) {
                    showToast('Please confirm you understand this action is irreversible', 'error');
                    return;
                }

                showLoading('Deleting section...');

                try {
                    // Reauthenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email,
                        password
                    );

                    await currentUser.reauthenticateWithCredential(credential);

                    // Delete section and all related data in a batch
                    const batch = db.batch();

                    // Delete section
                    batch.delete(db.collection('sections').doc(currentSection.id));

                    // Delete section students
                    const sectionStudentsQuery = await db.collection('sectionStudents')
                        .where('sectionId', '==', currentSection.id)
                        .get();

                    sectionStudentsQuery.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Delete attendance records
                    const attendanceQuery = await db.collection('attendance')
                        .where('sectionId', '==', currentSection.id)
                        .get();

                    attendanceQuery.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Delete sessions
                    const sessionsQuery = await db.collection('sessions')
                        .where('sectionId', '==', currentSection.id)
                        .get();

                    sessionsQuery.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Commit the batch
                    await batch.commit();

                    showToast('Section deleted successfully', 'success');
                    closeBottomSheet('deleteSectionBottomSheet');

                    // Go back to sections page
                    showPage('sections');
                    currentSection = null;

                    // Log event
                    logEvent('delete_section');
                } catch (error) {
                    console.error('Error deleting section:', error);

                    let errorMessage = 'Error deleting section. Please try again.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password';
                    }

                    showToast(errorMessage, 'error');
                }

                hideLoading();
            });

            // Start session
            document.getElementById('confirmSessionOptionsBtn').addEventListener('click', async () => {
                if (!currentSection) return;

                const duration = parseInt(document.getElementById('sessionDurationInput').value);
                const radius = parseInt(document.getElementById('sessionRadiusInput').value);
                let maxPoints = 5;
                let minPoints = 1;
                let rememberSettings = false;

                if (currentSection.plusPoints) {
                    maxPoints = parseInt(document.getElementById('maxPointsInput').value);
                    minPoints = parseInt(document.getElementById('minPointsInput').value);
                    rememberSettings = document.getElementById('rememberPlusPointsInput').checked;
                }

                // Validation
                if (currentSection.plusPoints) {
                    if (maxPoints <= minPoints) {
                        showToast('Max points must be greater than min points', 'error');
                        return;
                    }

                    if (maxPoints > 60) {
                        showToast('Max points cannot exceed 60', 'error');
                        return;
                    }

                    if (minPoints < 0) {
                        showToast('Min points cannot be negative', 'error');
                        return;
                    }
                }

                showLoading('Starting session...');

                try {
                    // Get current location
                    const position = await getLocation();

                    if (!position) {
                        showToast('Location access is required to start a session', 'error');
                        hideLoading();
                        return;
                    }

                    // Create session document
                    const sessionRef = await db.collection('sessions').add({
                        sectionId: currentSection.id,
                        teacherId: currentUser.uid,
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        },
                        radius,
                        duration,
                        plusPoints: currentSection.plusPoints,
                        maxPoints: currentSection.plusPoints ? maxPoints : 0,
                        minPoints: currentSection.plusPoints ? minPoints : 0,
                        startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        ended: false
                    });

                    // Remember plus points settings if enabled
                    if (currentSection.plusPoints && rememberSettings) {
                        await db.collection('users').doc(currentUser.uid).update({
                            lastPlusPointsSettings: {
                                maxPoints,
                                minPoints
                            }
                        });
                    }

                    // Update section with last used location
                    await db.collection('sections').doc(currentSection.id).update({
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        },
                        radius
                    });

                    showToast('Session started successfully', 'success');
                    closeBottomSheet('sessionOptionsBottomSheet');

                    // Show the new session
                    const sessionDoc = await sessionRef.get();
                    currentSession = sessionDoc.data();
                    currentSession.id = sessionDoc.id;
                    showSessionDetail(currentSession);

                    // Log event
                    logEvent('start_session', {
                        duration,
                        radius,
                        plus_points: currentSection.plusPoints,
                        max_points: maxPoints,
                        min_points: minPoints
                    });
                } catch (error) {
                    console.error('Error starting session:', error);
                    showToast('Error starting session. Please try again.', 'error');
                }

                hideLoading();
            });

            // Extend session
            document.getElementById('confirmExtendSessionBtn').addEventListener('click', async () => {
                if (!currentSession) return;

                const extendBy = parseInt(document.getElementById('extendDurationInput').value);
                const updateLocation = document.getElementById('updateLocationExtendInput').checked;

                showLoading('Extending session...');

                try {
                    const updates = {
                        duration: currentSession.duration + extendBy
                    };

                    if (updateLocation) {
                        const position = await getLocation();

                        if (position) {
                            updates.location = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            updates.radius = currentSession.radius;

                            // Update section with new location
                            await db.collection('sections').doc(currentSession.sectionId).update({
                                location: updates.location,
                                radius: updates.radius
                            });
                        }
                    }

                    // Update session
                    await db.collection('sessions').doc(currentSession.id).update(updates);

                    showToast(`Session extended by ${extendBy} minutes`, 'success');
                    closeBottomSheet('extendSessionBottomSheet');

                    // Refresh session data
                    const sessionDoc = await db.collection('sessions').doc(currentSession.id).get();
                    currentSession = sessionDoc.data();
                    currentSession.id = sessionDoc.id;

                    // Log event
                    logEvent('extend_session', {
                        extend_by: extendBy,
                        update_location: updateLocation
                    });
                } catch (error) {
                    console.error('Error extending session:', error);
                    showToast('Error extending session. Please try again.', 'error');
                }

                hideLoading();
            });

            // End session
            document.getElementById('endSessionBtn').addEventListener('click', async () => {
                if (!currentSession) return;

                if (!confirm('Are you sure you want to end this session?')) {
                    return;
                }

                showLoading('Ending session...');

                try {
                    // Update session
                    await db.collection('sessions').doc(currentSession.id).update({
                        ended: true,
                        endedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showToast('Session ended successfully', 'success');

                    // Go back to section detail
                    const sectionDoc = await db.collection('sections').doc(currentSession.sectionId).get();
                    showSectionDetail(sectionDoc.data());
                    currentSession = null;

                    // Log event
                    logEvent('end_session');
                } catch (error) {
                    console.error('Error ending session:', error);
                    showToast('Error ending session. Please try again.', 'error');
                }

                hideLoading();
            });

            // Check in
            document.getElementById('checkInBtn').addEventListener('click', async () => {
                if (!currentSession || userRole !== 'student') return;

                showLoading('Checking in...');

                try {
                    // Get current location
                    const position = await getLocation();

                    if (!position) {
                        showToast('Location access is required to check in', 'error');
                        hideLoading();
                        return;
                    }

                    // Calculate distance from session location
                    const distance = calculateDistance(
                        position.coords.latitude, position.coords.longitude,
                        currentSession.location.latitude, currentSession.location.longitude
                    );

                    // Check if within radius
                    if (distance > currentSession.radius) {
                        showToast('You are too far from the session location', 'error');
                        hideLoading();
                        return;
                    }

                    // Calculate plus points if enabled
                    let points = 0;
                    if (currentSession.plusPoints) {
                        const now = new Date();
                        const startTime = currentSession.startedAt.toDate();
                        const elapsedMinutes = (now - startTime) / (1000 * 60);

                        // Linear decrease from maxPoints to minPoints over session duration
                        if (elapsedMinutes <= 0) {
                            points = currentSession.maxPoints;
                        } else if (elapsedMinutes >= currentSession.duration) {
                            points = currentSession.minPoints;
                        } else {
                            const progress = elapsedMinutes / currentSession.duration;
                            points = Math.round(
                                currentSession.maxPoints -
                                (currentSession.maxPoints - currentSession.minPoints) * progress
                            );
                        }
                    }

                    // Create attendance record
                    await db.collection('attendance').add({
                        sectionId: currentSession.sectionId,
                        sessionId: currentSession.id,
                        studentId: currentUser.uid,
                        teacherId: currentSession.teacherId,
                        status: 'present',
                        points,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }
                    });

                    // Show success modal
                    document.getElementById('checkInPointsEarned').textContent =
                        points > 0 ? `You earned ${points} Plus Points!` : 'Check-in successful!';

                    const now = new Date();
                    document.getElementById('checkInTime').textContent =
                        `Checked in at ${now.toLocaleTimeString()}`;

                    showModal('checkInSuccessModal');

                    // Log event
                    logEvent('check_in', {
                        distance,
                        points,
                        session_duration: currentSession.duration
                    });
                } catch (error) {
                    console.error('Error checking in:', error);
                    showToast('Error checking in. Please try again.', 'error');
                }

                hideLoading();
            });

            // Change display identity
            document.getElementById('confirmChangeDisplayBtn').addEventListener('click', async () => {
                const emojiSelection = document.getElementById('emojiSelection').style.display !== 'none';
                let newValue;
                let newType;

                if (emojiSelection) {
                    const selectedEmoji = document.querySelector('.emoji-option.selected');
                    if (!selectedEmoji) {
                        document.getElementById('changeDisplayError').textContent = 'Please select an emoji';
                        document.getElementById('changeDisplayError').style.display = 'block';
                        return;
                    }

                    newValue = selectedEmoji.textContent;
                    newType = 'emoji';
                } else {
                    newValue = document.getElementById('displayTextInput').value.trim();
                    if (!newValue || newValue.length > 2) {
                        document.getElementById('changeDisplayError').textContent = 'Please enter 1-2 letters';
                        document.getElementById('changeDisplayError').style.display = 'block';
                        return;
                    }

                    newType = 'text';
                }

                // Check if 24 hours have passed since last change
                if (userData.lastAvatarChange) {
                    const lastChange = userData.lastAvatarChange.toDate();
                    const now = new Date();
                    const hoursSinceLastChange = (now - lastChange) / (1000 * 60 * 60);

                    if (hoursSinceLastChange < 24) {
                        document.getElementById('changeDisplayError').textContent =
                            `You can only change your display identity once every 24 hours. Please try again in ${Math.ceil(24 - hoursSinceLastChange)} hours.`;
                        document.getElementById('changeDisplayError').style.display = 'block';
                        return;
                    }
                }

                showLoading('Updating display identity...');

                try {
                    // Update user document
                    await db.collection('users').doc(currentUser.uid).update({
                        avatarType: newType,
                        avatarValue: newValue,
                        lastAvatarChange: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showToast('Display identity updated successfully', 'success');
                    closeBottomSheet('changeDisplayBottomSheet');

                    // Log event
                    logEvent('change_avatar', {
                        type: newType
                    });
                } catch (error) {
                    console.error('Error updating display identity:', error);
                    showToast('Error updating display identity. Please try again.', 'error');
                }

                hideLoading();
            });

            // Change password
            document.getElementById('confirmChangePasswordBtn').addEventListener('click', async () => {
                const currentPassword = document.getElementById('currentPasswordInput').value;
                const newPassword = document.getElementById('newPasswordInput').value;
                const confirmPassword = document.getElementById('confirmPasswordInput').value;

                // Validation
                if (!currentPassword) {
                    document.getElementById('passwordError').textContent = 'Please enter your current password';
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                }

                if (!newPassword) {
                    document.getElementById('passwordError').textContent = 'Please enter a new password';
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                }

                if (newPassword.length < 6) {
                    document.getElementById('passwordError').textContent = 'Password must be at least 6 characters';
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    document.getElementById('passwordError').textContent = 'Passwords do not match';
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                }

                showLoading('Changing password...');

                try {
                    // Reauthenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email,
                        currentPassword
                    );

                    await currentUser.reauthenticateWithCredential(credential);

                    // Update password
                    await currentUser.updatePassword(newPassword);

                    showToast('Password changed successfully', 'success');
                    closeBottomSheet('changePasswordBottomSheet');

                    // Log event
                    logEvent('change_password');
                } catch (error) {
                    console.error('Error changing password:', error);

                    let errorMessage = 'Error changing password. Please try again.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect current password';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                    }

                    document.getElementById('passwordError').textContent = errorMessage;
                    document.getElementById('passwordError').style.display = 'block';
                }

                hideLoading();
            });

            // Change email
            document.getElementById('confirmChangeEmailBtn').addEventListener('click', async () => {
                const newEmail = document.getElementById('newEmailInput').value.trim();
                const password = document.getElementById('emailPasswordInput').value;

                // Validation
                if (!newEmail) {
                    document.getElementById('emailError').textContent = 'Please enter a new email';
                    document.getElementById('emailError').style.display = 'block';
                    return;
                }

                if (!password) {
                    document.getElementById('emailError').textContent = 'Please enter your password';
                    document.getElementById('emailError').style.display = 'block';
                    return;
                }

                showLoading('Changing email...');

                try {
                    // Reauthenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email,
                        password
                    );

                    await currentUser.reauthenticateWithCredential(credential);

                    // Update email
                    await currentUser.updateEmail(newEmail);

                    // Update user document
                    await db.collection('users').doc(currentUser.uid).update({
                        email: newEmail
                    });

                    showToast('Email changed successfully', 'success');
                    closeBottomSheet('changeEmailBottomSheet');

                    // Log event
                    logEvent('change_email');
                } catch (error) {
                    console.error('Error changing email:', error);

                    let errorMessage = 'Error changing email. Please try again.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address';
                    } else if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email is already in use';
                    }

                    document.getElementById('emailError').textContent = errorMessage;
                    document.getElementById('emailError').style.display = 'block';
                }

                hideLoading();
            });

            // Toggle analytics consent
            document.getElementById('analyticsToggle').addEventListener('change', async (e) => {
                const consent = e.target.checked;

                try {
                    // Update user document
                    await db.collection('users').doc(currentUser.uid).update({
                        analyticsConsent: consent
                    });

                    // Initialize or disable analytics
                    if (consent) {
                        analytics = firebase.analytics();
                        logEvent('analytics_consent', {
                            consent: true
                        });
                        showToast('Analytics collection enabled', 'success');
                    } else {
                        analytics = null;
                        showToast('Analytics collection disabled', 'success');
                    }
                } catch (error) {
                    console.error('Error updating analytics consent:', error);
                    showToast('Error updating analytics settings. Please try again.', 'error');

                    // Revert the toggle
                    e.target.checked = !consent;
                }
            });

            // Request location access
            document.getElementById('requestLocationBtn').addEventListener('click', () => {
                showModal('locationPermissionModal');
            });

            // Grant location permission
            document.getElementById('grantLocationPermissionBtn').addEventListener('click', async () => {
                closeModal('locationPermissionModal');

                try {
                    const position = await getLocation();
                    if (position) {
                        showToast('Location access granted', 'success');
                        updateLocationStatusUI();
                    }
                } catch (error) {
                    console.error('Error getting location:', error);
                    showToast('Error getting location. Please try again.', 'error');
                }
            });

            // Deny location permission
            document.getElementById('denyLocationPermissionBtn').addEventListener('click', () => {
                closeModal('locationPermissionModal');
                showToast('Location access is required for check-ins', 'warning');
            });

            // Back to sections button
            document.getElementById('backToSectionsBtn').addEventListener('click', () => {
                showPage('sections');
                currentSection = null;
            });

            // Back to section detail button
            document.getElementById('backToSectionDetailBtn').addEventListener('click', () => {
                if (currentSection) {
                    showSectionDetail(currentSection);
                    currentSession = null;
                } else {
                    showPage('sections');
                }
            });

            // Back to dashboard button
            document.getElementById('backToDashboardBtn').addEventListener('click', () => {
                showPage('dashboard');
                currentSession = null;
            });

            // Create section buttons
            document.getElementById('createSectionBtn2').addEventListener('click', () => {
                showBottomSheet('createSectionBottomSheet');
            });

            document.getElementById('createSectionBtn3').addEventListener('click', () => {
                showBottomSheet('createSectionBottomSheet');
            });

            // Edit section button
            document.getElementById('editSectionBtn').addEventListener('click', () => {
                if (!currentSection) return;

                // Fill form with current values
                document.getElementById('editSectionNameInput').value = currentSection.name;
                document.getElementById('editSectionSubjectInput').value = currentSection.subject || '';
                document.getElementById('editSectionDaysInput').value = currentSection.scheduleDays || 'MWF';
                document.getElementById('editSectionTimeInput').value = currentSection.scheduleTime || '09:00';
                document.getElementById('editSectionRadiusInput').value = currentSection.radius || 10;
                document.getElementById('editSectionPlusPointsInput').checked = currentSection.plusPoints || false;

                showBottomSheet('editSectionBottomSheet');
            });

            // Delete section button
            document.getElementById('deleteSectionBtn').addEventListener('click', () => {
                if (!currentSection) return;

                showBottomSheet('deleteSectionBottomSheet');
            });

            // Delete section confirmation checkbox
            document.getElementById('deleteSectionConfirmInput').addEventListener('change', (e) => {
                document.getElementById('confirmDeleteSectionBtn').disabled = !e.target.checked;
            });

            // Change to emoji button
            document.getElementById('changeToEmojiBtn').addEventListener('click', () => {
                document.getElementById('emojiSelection').style.display = 'block';
                document.getElementById('textSelection').style.display = 'none';
                document.getElementById('changeDisplayError').style.display = 'none';

                // Populate emojis if not already done
                if (document.querySelectorAll('.emoji-option').length === 0) {
                    const emojis = ['😀', '😊', '😎', '🤩', '😍', '🤗', '🙂', '😇', '🤠', '😋', '😜', '🤪', '😎', '🤓', '🧐', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😴', '🤢', '😷', '🤒', '🤕'];
                    const emojiContainer = document.getElementById('emojiSelection').querySelector('div');

                    emojis.forEach(emoji => {
                        const emojiOption = document.createElement('span');
                        emojiOption.className = 'emoji-option';
                        emojiOption.textContent = emoji;
                        emojiOption.style.fontSize = '24px';
                        emojiOption.style.cursor = 'pointer';
                        emojiOption.style.padding = '4px';
                        emojiOption.style.borderRadius = '4px';

                        emojiOption.addEventListener('click', () => {
                            document.querySelectorAll('.emoji-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            emojiOption.classList.add('selected');
                        });

                        emojiContainer.appendChild(emojiOption);
                    });
                }

                showBottomSheet('changeDisplayBottomSheet');
            });

            // Change to text button
            document.getElementById('changeToTextBtn').addEventListener('click', () => {
                document.getElementById('emojiSelection').style.display = 'none';
                document.getElementById('textSelection').style.display = 'block';
                document.getElementById('changeDisplayError').style.display = 'none';
                document.getElementById('displayTextInput').value = '';

                showBottomSheet('changeDisplayBottomSheet');
            });

            // Change password button
            document.getElementById('changePasswordBtn').addEventListener('click', () => {
                document.getElementById('currentPasswordInput').value = '';
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmPasswordInput').value = '';
                document.getElementById('passwordError').style.display = 'none';

                showBottomSheet('changePasswordBottomSheet');
            });

            // Change email button
            document.getElementById('changeEmailBtn').addEventListener('click', () => {
                document.getElementById('currentEmailInput').value = currentUser.email || '';
                document.getElementById('newEmailInput').value = '';
                document.getElementById('emailPasswordInput').value = '';
                document.getElementById('emailError').style.display = 'none';

                showBottomSheet('changeEmailBottomSheet');
            });

            // Start session button
            document.getElementById('startSessionBtn').addEventListener('click', () => {
                if (!currentSection) return;

                // Fill form with default or last used values
                document.getElementById('sessionDurationInput').value = '30';
                document.getElementById('sessionRadiusInput').value = currentSection.radius || 10;

                // Show/hide plus points options
                const plusPointsOptions = document.getElementById('plusPointsOptions');
                if (currentSection.plusPoints) {
                    plusPointsOptions.style.display = 'block';

                    // Set default or last used points
                    if (userData.lastPlusPointsSettings) {
                        document.getElementById('maxPointsInput').value = userData.lastPlusPointsSettings.maxPoints || 5;
                        document.getElementById('minPointsInput').value = userData.lastPlusPointsSettings.minPoints || 1;
                    } else {
                        document.getElementById('maxPointsInput').value = 5;
                        document.getElementById('minPointsInput').value = 1;
                    }
                } else {
                    plusPointsOptions.style.display = 'none';
                }

                showBottomSheet('sessionOptionsBottomSheet');
            });

            // Extend session button
            document.getElementById('extendSessionBtn').addEventListener('click', () => {
                if (!currentSession) return;

                document.getElementById('extendDurationInput').value = '10';
                document.getElementById('updateLocationExtendInput').checked = false;

                showBottomSheet('extendSessionBottomSheet');
            });

            // Update location button
            document.getElementById('updateLocationBtn').addEventListener('click', async () => {
                if (!currentSession) return;

                showLoading('Updating location...');

                try {
                    const position = await getLocation();

                    if (!position) {
                        showToast('Location access is required', 'error');
                        hideLoading();
                        return;
                    }

                    // Update session location
                    await db.collection('sessions').doc(currentSession.id).update({
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }
                    });

                    // Update section location
                    await db.collection('sections').doc(currentSession.sectionId).update({
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }
                    });

                    showToast('Location updated successfully', 'success');

                    // Refresh session data
                    const sessionDoc = await db.collection('sessions').doc(currentSession.id).get();
                    currentSession = sessionDoc.data();
                    currentSession.id = sessionDoc.id;

                    // Update UI
                    document.getElementById('sessionLocationText').textContent =
                        `Location: ${currentSession.location.latitude.toFixed(4)}, ${currentSession.location.longitude.toFixed(4)}`;

                    // Log event
                    logEvent('update_session_location');
                } catch (error) {
                    console.error('Error updating location:', error);
                    showToast('Error updating location. Please try again.', 'error');
                }

                hideLoading();
            });

            // Copy invite link button
            document.getElementById('copyInviteLinkBtn').addEventListener('click', () => {
                if (!currentSession) return;

                const inviteLink = `${window.location.origin}?sectionId=${currentSection.id}&sessionId=${currentSession.id}`;

                navigator.clipboard.writeText(inviteLink).then(() => {
                    showToast('Invite link copied to clipboard', 'success');
                }).catch(() => {
                    showToast('Failed to copy invite link', 'error');
                });
            });

            // Download QR code button
            document.getElementById('downloadQRCodeBtn').addEventListener('click', () => {
                if (!currentSession) return;

                const canvas = document.querySelector('#sessionQRCode canvas');
                if (!canvas) return;

                const link = document.createElement('a');
                link.download = `NearCheck-Session-${currentSession.id}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });

            // Check if there's a sectionId in the URL (for invite links)
            const urlParams = new URLSearchParams(window.location.search);
            const sectionId = urlParams.get('sectionId');
            const sessionId = urlParams.get('sessionId');

            if (sectionId && !currentUser) {
                // Store sectionId to use after sign up
                localStorage.setItem('pendingSectionId', sectionId);

                if (sessionId) {
                    localStorage.setItem('pendingSessionId', sessionId);
                }
            }

            // Check for pending section join after sign in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const pendingSectionId = localStorage.getItem('pendingSectionId');
                    const pendingSessionId = localStorage.getItem('pendingSessionId');

                    if (pendingSectionId) {
                        try {
                            // Verify section exists
                            const sectionDoc = await db.collection('sections').doc(pendingSectionId).get();

                            if (sectionDoc.exists) {
                                // Check if student is already in section
                                const sectionStudentQuery = await db.collection('sectionStudents')
                                    .where('sectionId', '==', pendingSectionId)
                                    .where('studentId', '==', user.uid)
                                    .limit(1)
                                    .get();

                                if (sectionStudentQuery.empty) {
                                    // Join section
                                    await db.collection('sectionStudents').add({
                                        sectionId: pendingSectionId,
                                        studentId: user.uid,
                                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });

                                    showToast('Joined section successfully', 'success');

                                    // If there's a session ID, show check-in page
                                    if (pendingSessionId) {
                                        const sessionDoc = await db.collection('sessions').doc(pendingSessionId).get();
                                        if (sessionDoc.exists && !sessionDoc.data().ended) {
                                            currentSession = sessionDoc.data();
                                            currentSession.id = sessionDoc.id;

                                            // Get section data
                                            const sectionDoc = await db.collection('sections').doc(pendingSectionId).get();
                                            currentSection = sectionDoc.data();
                                            currentSection.id = sectionDoc.id;

                                            showCheckInPage();
                                        }
                                    }
                                } else {
                                    showToast('You are already in this section', 'info');
                                }
                            } else {
                                showToast('Section not found', 'error');
                            }
                        } catch (error) {
                            console.error('Error joining section:', error);
                            showToast('Error joining section', 'error');
                        }

                        // Clear pending section
                        localStorage.removeItem('pendingSectionId');
                        localStorage.removeItem('pendingSessionId');

                        // Remove from URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            });

            // Update location status UI
            function updateLocationStatusUI() {
                if (!navigator.geolocation) {
                    document.getElementById('locationStatus').innerHTML = `
                        <span class="material-icons">error</span>
                        <span>Geolocation is not supported by your browser</span>
                    `;
                    return;
                }

                navigator.permissions.query({
                    name: 'geolocation'
                }).then((result) => {
                    const statusElement = document.getElementById('locationStatus');

                    const updateStatus = () => {
                        if (result.state === 'granted') {
                            statusElement.innerHTML = `
                                <span class="material-icons" style="color: var(--secondary-color);">check_circle</span>
                                <span>Location permission is active and accessible</span>
                            `;
                        } else if (result.state === 'denied') {
                            statusElement.innerHTML = `
                                <span class="material-icons" style="color: var(--accent-color);">cancel</span>
                                <span>User declined permission</span>
                            `;
                        } else {
                            statusElement.innerHTML = `
                                <span class="material-icons" style="color: var(--warning-color);">help</span>
                                <span>Location permission not yet requested</span>
                            `;
                        }
                    };

                    updateStatus();
                    result.onchange = updateStatus;
                }).catch((error) => {
                    console.error('Error checking location permission:', error);
                    document.getElementById('locationStatus').innerHTML = `
                        <span class="material-icons">error</span>
                        <span>Error checking location permission status</span>
                    `;
                });
            }

            // Get location with permission handling
            function getLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position),
                        (error) => reject(error), {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            }

            // Initialize location status UI
            updateLocationStatusUI();

            // Context menu protection
            document.addEventListener('contextmenu', (e) => {
                if (currentUser) {
                    e.preventDefault();
                }
            });

            // Prevent F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            document.addEventListener('keydown', (e) => {
                if (currentUser && (
                        e.key === 'F12' ||
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'U')
                    )) {
                    e.preventDefault();
                }
            });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>